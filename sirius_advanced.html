<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Анализ данных в социальных науках с помощью языка R. Вторая неделя</title>
  <meta name="description" content="Конспекты для курса по анализу данных в R для Сириус">
  <meta name="generator" content="bookdown <!--bookdown:version--> and GitBook 2.6.7">

  <meta property="og:title" content="Анализ данных в социальных науках с помощью языка R. Вторая неделя" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Конспекты для курса по анализу данных в R для Сириус" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Анализ данных в социальных науках с помощью языка R. Вторая неделя" />
  
  <meta name="twitter:description" content="Конспекты для курса по анализу данных в R для Сириус" />
  

<meta name="author" content="Иван Поздняков">


<meta name="date" content="2020-01-21">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<!--bookdown:link_prev-->
<!--bookdown:link_next-->
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/htmlwidgets-1.5.1/htmlwidgets.js"></script>
<link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="libs/datatables-binding-0.6/datatables.js"></script>
<link href="libs/dt-core-1.10.16/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.10.16/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.10.16/js/jquery.dataTables.min.js"></script>
<link href="libs/crosstalk-1.0.0/css/crosstalk.css" rel="stylesheet" />
<script src="libs/crosstalk-1.0.0/js/crosstalk.min.js"></script>
<script src="libs/plotly-binding-4.9.0/plotly.js"></script>
<script src="libs/typedarray-0.1/typedarray.min.js"></script>
<link href="libs/plotly-htmlwidgets-css-1.46.1/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="libs/plotly-main-1.46.1/plotly-latest.min.js"></script>
<link href="libs/str_view-0.1.0/str_view.css" rel="stylesheet" />
<script src="libs/str_view-binding-1.4.0/str_view.js"></script>
<script src="libs/d3-4.5.0/d3.min.js"></script>
<link href="libs/edgebundleR-0.0.2/styles.css" rel="stylesheet" />
<script src="libs/edgebundleR-0.0.2/packages.js"></script>
<script src="libs/edgebundleR-binding-0.1.4/edgebundleR.js"></script>
<script src="libs/forceNetwork-binding-0.4/forceNetwork.js"></script>


<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



<!--bookdown:title:start-->
<div id="header">
<h1 class="title">Анализ данных в социальных науках с помощью языка R. Вторая неделя</h1>
<p class="author"><em>Иван Поздняков</em></p>
<p class="date"><em>2020-01-21</em></p>
</div>
<!--bookdown:title:end-->

<!--bookdown:toc:start-->
  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">
<!--bookdown:toc2:start-->
<ul>
<li><a href="#d1"><span class="toc-section-number">1</span> Неделя 2, День 1</a><ul>
<li><a href="#warm"><span class="toc-section-number">1.1</span> Warmup exercise</a></li>
<li><a href="#lm"><span class="toc-section-number">1.2</span> Простая линейная регрессия</a><ul>
<li><a href="#formula"><span class="toc-section-number">1.2.1</span> Формула</a></li>
<li><a href="#lm"><span class="toc-section-number">1.2.2</span> Функция lm()</a></li>
<li><a href="#interpret"><span class="toc-section-number">1.2.3</span> Интерпретация вывода линейной регрессии</a></li>
<li><a href="#lm_a"><span class="toc-section-number">1.2.4</span> Допущения линейной регрессии</a></li>
<li><a href="#outliers"><span class="toc-section-number">1.2.5</span> Влияние выбросов на линейную модель</a></li>
</ul></li>
<li><a href="#lm_mult"><span class="toc-section-number">1.3</span> Множественная линейная регрессия</a></li>
</ul></li>
<li><a href="#d2"><span class="toc-section-number">2</span> Неделя 2, День 2</a><ul>
<li><a href="#anova"><span class="toc-section-number">2.1</span> Дисперсионный анализ (ANOVA)</a><ul>
<li><a href="#aov"><span class="toc-section-number">2.1.1</span> Функция aov()</a></li>
<li><a href="#anova_nhst"><span class="toc-section-number">2.1.2</span> Тестирование значимости нулевой гипотезы в ANOVA.</a></li>
<li><a href="#anova_posthoc"><span class="toc-section-number">2.1.3</span> Post-hoc тесты</a></li>
<li><a href="#aov_as_lm"><span class="toc-section-number">2.1.4</span> ANOVA и т-тест как частные случаи линейной регрессии</a></li>
<li><a href="#dummy"><span class="toc-section-number">2.1.5</span> Dummy coding</a></li>
<li><a href="#aov_a"><span class="toc-section-number">2.1.6</span> Допущения ANOVA</a></li>
<li><a href="#fact_aov"><span class="toc-section-number">2.1.7</span> Многофакторный дисперсионный анализ (Factorial ANOVA)</a></li>
<li><a href="#rm_aov"><span class="toc-section-number">2.1.8</span> Дисперсионный анализ с повторными измерениями (Repeated-measures ANOVA)</a></li>
<li><a href="#mixed_aov"><span class="toc-section-number">2.1.9</span> Смешанный дисперсионный анализ (Mixed between-within subjects ANOVA)</a></li>
<li><a href="#aov_sum"><span class="toc-section-number">2.1.10</span> Заключение</a></li>
</ul></li>
</ul></li>
<li><a href="#d2_rmd"><span class="toc-section-number">3</span> Неделя 2, День 2, продолжение</a><ul>
<li><a href="#rmd"><span class="toc-section-number">3.1</span> RMarkdown</a><ul>
<li><a href="#chunk"><span class="toc-section-number">3.1.1</span> Настройки чанка</a></li>
<li><a href="#chunks"><span class="toc-section-number">3.1.2</span> Настройка нескольких чанков</a></li>
<li><a href="#python"><span class="toc-section-number">3.1.3</span> Чанки с Python!</a></li>
<li><a href="#inline"><span class="toc-section-number">3.1.4</span> Код вне чанков (inline code)</a></li>
<li><a href="#md"><span class="toc-section-number">3.1.5</span> Синтаксис Markdown (без R)</a></li>
<li><a href="#rmd_tables"><span class="toc-section-number">3.1.6</span> Таблицы</a></li>
<li><a href="#vis"><span class="toc-section-number">3.1.7</span> Визуализации</a></li>
<li><a href="#din_vis"><span class="toc-section-number">3.1.8</span> Динамические визуализации в plotly</a></li>
<li><a href="#html"><span class="toc-section-number">3.1.9</span> Вставлять HTML</a></li>
</ul></li>
</ul></li>
<li><a href="#d2"><span class="toc-section-number">4</span> Неделя 2, День 3</a><ul>
<li><a href="#text"><span class="toc-section-number">4.1</span> Введение в работу с текстом</a></li>
<li><a href="#text_base"><span class="toc-section-number">4.2</span> Базовые операции с текстом</a><ul>
<li><a href="#text_c"><span class="toc-section-number">4.2.1</span> Соединение и разъединение строк</a></li>
<li><a href="#text_len"><span class="toc-section-number">4.2.2</span> Подсчет длины строк</a></li>
<li><a href="#text_cut"><span class="toc-section-number">4.2.3</span> Выделение подстрок и обрезание строк</a></li>
<li><a href="#text_to"><span class="toc-section-number">4.2.4</span> Изменение регистра</a></li>
<li><a href="#text_rand"><span class="toc-section-number">4.2.5</span> Случайные последовательности</a></li>
<li><a href="#text_sort"><span class="toc-section-number">4.2.6</span> Сортировка</a></li>
</ul></li>
<li><a href="#regexp"><span class="toc-section-number">4.3</span> Поиск паттернов и регулярные выражения</a><ul>
<li><a href="#grep"><span class="toc-section-number">4.3.1</span> grep(), gsub()</a></li>
<li><a href="#reg"><span class="toc-section-number">4.3.2</span> Регулярные выражения</a></li>
</ul></li>
<li><a href="#text_next"><span class="toc-section-number">4.4</span> А что дальше?</a></li>
<li><a href="#fuzzy"><span class="toc-section-number">4.5</span> Fuzzy matching</a></li>
</ul></li>
<li><a href="#d4"><span class="toc-section-number">5</span> Неделя 2, День 4</a><ul>
<li><a href="#multi"><span class="toc-section-number">5.1</span> Многомерные методы анализа данных</a></li>
<li><a href="#heatmap"><span class="toc-section-number">5.2</span> Хитмап корреляций</a></li>
<li><a href="#pca"><span class="toc-section-number">5.3</span> Анализ главных компонент (Principal component analysis)</a><ul>
<li><a href="#pca_n"><span class="toc-section-number">5.3.1</span> Количество извлекаемых компонент</a></li>
</ul></li>
<li><a href="#fa"><span class="toc-section-number">5.4</span> Эксплораторный факторный анализ</a></li>
<li><a href="#cfa"><span class="toc-section-number">5.5</span> Конфирматорный факторный анализ</a></li>
<li><a href="#other_multi"><span class="toc-section-number">5.6</span> Другие многомерные методы</a></li>
</ul></li>
<li><a href="#d6"><span class="toc-section-number">6</span> Неделя 2, День 6</a><ul>
<li><a href="#style"><span class="toc-section-number">6.1</span> Стиль кода</a></li>
<li><a href="#repr"><span class="toc-section-number">6.2</span> Вопроизводимость исследований</a><ul>
<li><a href="#quest"><span class="toc-section-number">6.2.1</span> Спорные исследовательские практики</a></li>
<li><a href="#repr_r"><span class="toc-section-number">6.2.2</span> Вопроизводимые исследования в R</a></li>
<li><a href="#power"><span class="toc-section-number">6.2.3</span> Статистическая мощность</a></li>
</ul></li>
</ul></li>
</ul>
<!--bookdown:toc2:end-->
      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Анализ данных в социальных науках с помощью языка R. Вторая неделя</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<!--bookdown:toc:end-->
<!--bookdown:body:start-->
<p>Здесь содержатся материалы для курса по анализу данных в R для Сириус.</p>
<!--chapter:end:index.Rmd-->
<div id="d1" class="section level1">
<h1><span class="header-section-number">1</span> Неделя 2, День 1</h1>
<div id="warm" class="section level2">
<h2><span class="header-section-number">1.1</span> Warmup exercise</h2>
<p>Итак, давайте загрузим датасет про студентов и вес их рюкзаков и сконвертируем его в data.table:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;Stat2Data&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(Stat2Data)
<span class="kw">library</span>(data.table)</code></pre></div>
<pre><code>## data.table 1.12.8 using 2 threads (see ?getDTthreads).  Latest news: r-datatable.com</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">&quot;Backpack&quot;</span>)
back &lt;-<span class="st"> </span><span class="kw">as.data.table</span>(Backpack)</code></pre></div>
<p><strong>Самостоятельное задание:</strong></p>
<ol style="list-style-type: decimal">
<li>Исследуйте колонки BackpackWeight и BodyWeight. В чем измеряются эти переменные? Переводите их в килограммы, создав колонки BackpackWeightKG, BodyWeightKG</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">back[, <span class="kw">summary</span>(BackpackWeight)]</code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##    2.00    8.00   11.00   11.66   14.25   35.00</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">back[, <span class="kw">summary</span>(BodyWeight)]</code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##   105.0   130.0   147.5   153.1   170.0   270.0</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">back[,BackpackWeightKG<span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="fl">0.45359237</span><span class="op">*</span>BackpackWeight]
back[,BodyWeightKG<span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="fl">0.45359237</span><span class="op">*</span>BodyWeight]</code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Присвойтен id каждому испытуемому</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">back[,id<span class="op">:</span><span class="er">=</span><span class="dv">1</span><span class="op">:</span>.N]</code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Как различается вес рюкзака в зависимости от пола? Кто весит больше? Если допустить, что выборка репрезентативна, то можно ли сделать вывод о различии в генеральной совокупности?</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">back[,<span class="kw">mean</span>(BackpackWeightKG), by =<span class="st"> </span>Sex]</code></pre></div>
<pre><code>##       Sex       V1
## 1: Female 5.006010
## 2:   Male 5.634625</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">back[,<span class="kw">t.test</span>(BackpackWeightKG <span class="op">~</span><span class="st"> </span>Sex)]</code></pre></div>
<pre><code>## 
##  Welch Two Sample t-test
## 
## data:  BackpackWeightKG by Sex
## t = -1.1782, df = 86.25, p-value = 0.242
## alternative hypothesis: true difference in means is not equal to 0
## 95 percent confidence interval:
##  -1.6892365  0.4320067
## sample estimates:
## mean in group Female   mean in group Male 
##             5.006010             5.634625</code></pre>
<ol start="4" style="list-style-type: decimal">
<li>Повторите пункт 3 для веса самих студентов.</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">back[,<span class="kw">mean</span>(BodyWeightKG), by =<span class="st"> </span>Sex]</code></pre></div>
<pre><code>##       Sex       V1
## 1: Female 62.28236
## 2:   Male 78.14893</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">back[,<span class="kw">t.test</span>(BodyWeightKG <span class="op">~</span><span class="st"> </span>Sex)]</code></pre></div>
<pre><code>## 
##  Welch Two Sample t-test
## 
## data:  BodyWeightKG by Sex
## t = -7.0863, df = 77.002, p-value = 5.704e-10
## alternative hypothesis: true difference in means is not equal to 0
## 95 percent confidence interval:
##  -20.32511 -11.40803
## sample estimates:
## mean in group Female   mean in group Male 
##             62.28236             78.14893</code></pre>
<ol start="5" style="list-style-type: decimal">
<li>Визуализируйте распределение этих двух переменных в зависимости от пола (используя ggplot2)</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ggplot2)
<span class="kw">ggplot</span>(back)<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_histogram</span>(<span class="kw">aes</span>(<span class="dt">x =</span> BodyWeightKG, <span class="dt">fill =</span> Sex), <span class="dt">bins =</span> <span class="dv">15</span>, <span class="dt">position =</span> <span class="st">&quot;identity&quot;</span>, <span class="dt">alpha =</span> <span class="fl">0.7</span>)</code></pre></div>
<p><img src="sirius_advanced_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(back)<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_histogram</span>(<span class="kw">aes</span>(<span class="dt">x =</span> BackpackWeightKG, <span class="dt">fill =</span> Sex), <span class="dt">bins =</span> <span class="dv">12</span>, <span class="dt">position =</span> <span class="st">&quot;identity&quot;</span>, <span class="dt">alpha =</span> <span class="fl">0.7</span>)</code></pre></div>
<p><img src="sirius_advanced_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<ol start="6" style="list-style-type: decimal">
<li>Теперь исследуем взаимосвязь переменных. Посчитайте коэффициент корреляции Пирсона и Спирмена.</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">back[, <span class="kw">cor.test</span>(BodyWeightKG, BackpackWeightKG)]</code></pre></div>
<pre><code>## 
##  Pearson&#39;s product-moment correlation
## 
## data:  BodyWeightKG and BackpackWeightKG
## t = 1.9088, df = 98, p-value = 0.05921
## alternative hypothesis: true correlation is not equal to 0
## 95 percent confidence interval:
##  -0.007360697  0.371918344
## sample estimates:
##       cor 
## 0.1893312</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">back[, <span class="kw">cor.test</span>(BodyWeightKG, BackpackWeightKG, <span class="dt">method =</span> <span class="st">&quot;spearman&quot;</span>)]</code></pre></div>
<pre><code>## Warning in cor.test.default(BodyWeightKG, BackpackWeightKG, method =
## &quot;spearman&quot;): Cannot compute exact p-value with ties</code></pre>
<pre><code>## 
##  Spearman&#39;s rank correlation rho
## 
## data:  BodyWeightKG and BackpackWeightKG
## S = 131520, p-value = 0.03527
## alternative hypothesis: true rho is not equal to 0
## sample estimates:
##       rho 
## 0.2108001</code></pre>
<ol start="7" style="list-style-type: decimal">
<li>Постройте диаграмму рассеяния с помощью ggplot2. Цветом закодирйте пол респондента</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(back, <span class="kw">aes</span>(<span class="dt">x =</span> BodyWeightKG, <span class="dt">y =</span> BackpackWeightKG))<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">colour =</span> Sex), <span class="dt">alpha =</span> <span class="fl">0.5</span>, <span class="dt">size =</span> <span class="dv">2</span>)</code></pre></div>
<p><img src="sirius_advanced_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
</div>
<div id="lm" class="section level2">
<h2><span class="header-section-number">1.2</span> Простая линейная регрессия</h2>
<p>Вы уже умеете считать коэффициент корреляции Пирсона:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">back[,<span class="kw">cor.test</span>(BackpackWeightKG, BodyWeightKG)]</code></pre></div>
<pre><code>## 
##  Pearson&#39;s product-moment correlation
## 
## data:  BackpackWeightKG and BodyWeightKG
## t = 1.9088, df = 98, p-value = 0.05921
## alternative hypothesis: true correlation is not equal to 0
## 95 percent confidence interval:
##  -0.007360697  0.371918344
## sample estimates:
##       cor 
## 0.1893312</code></pre>
<p>Простая линейная регрессия - это примерно то же самое. В синтаксисе линейной регрессии уже не обойтись без формул, это такой специальный тип данных в R:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">class</span>(y <span class="op">~</span><span class="st"> </span>x)</code></pre></div>
<pre><code>## [1] &quot;formula&quot;</code></pre>
<div id="formula" class="section level3">
<h3><span class="header-section-number">1.2.1</span> Формула</h3>
<p>Если видите эту волнистую линию - тильду, то значит перед Вами формула.</p>
<p>Давайте исследуем зависимость размера рюкзака от массы тела. В простой лингейной регрессии, в отличие от корреляции, есть направленность: одна переменная является как бы независимой переменной (предиктором), другая - как бы объясняемой переменной (outcome). Это может немного запутать: если одна переменная предиктор, а другая объясняется этим предиктором, то кажется, что они должны быть обязательно связаны причинно-следственной связью. Это не так: обозначения условны, более того, Вы можете поменять переменные местами и практически ничего не изменится! Короче говоря, “линейная регрессия” не дает никакой магической каузальной силы переменным.</p>
</div>
<div id="lm" class="section level3">
<h3><span class="header-section-number">1.2.2</span> Функция lm()</h3>
<p>Давайте посчитаем линейную регрессию функцией lm().</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">model &lt;-<span class="st"> </span><span class="kw">lm</span>(BackpackWeightKG <span class="op">~</span><span class="st"> </span>BodyWeightKG, <span class="dt">data =</span> back)
model</code></pre></div>
<pre><code>## 
## Call:
## lm(formula = BackpackWeightKG ~ BodyWeightKG, data = back)
## 
## Coefficients:
##  (Intercept)  BodyWeightKG  
##      2.71125       0.03713</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(model)</code></pre></div>
<pre><code>## 
## Call:
## lm(formula = BackpackWeightKG ~ BodyWeightKG, data = back)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -4.4853 -1.7629 -0.4681  1.2893  9.8803 
## 
## Coefficients:
##              Estimate Std. Error t value Pr(&gt;|t|)  
## (Intercept)   2.71125    1.37483   1.972   0.0514 .
## BodyWeightKG  0.03713    0.01945   1.909   0.0592 .
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 2.581 on 98 degrees of freedom
## Multiple R-squared:  0.03585,    Adjusted R-squared:  0.02601 
## F-statistic: 3.644 on 1 and 98 DF,  p-value: 0.05921</code></pre>
<p><code>print(model)</code> или просто <code>model</code> выводит коэфициенты линейной регрессии - это коэффициенты прямой, которая лучше всего подогнанна к данным. Как измеряется качество этой подгонки? В расстоянии точек исходных точек до прямой. По идее, расстояние до прямой нужно было бы считать просто по модулю. И так делают, хоть и очень редко. Обычно в линейной регрессии используются квадратичные расстояния точек до прямой для оценки расстояния (метод наименьших квадратов - ordinary least squares). Это дает кучу клевых математических свойств, например, возможность легко аналитически найти коэффициенты прямой линейной регрессии.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">back[, body <span class="op">:</span><span class="er">=</span><span class="st"> </span>BodyWeightKG]
back[, bp <span class="op">:</span><span class="er">=</span><span class="st"> </span>BackpackWeightKG]
<span class="kw">library</span>(ggplot2)
<span class="kw">ggplot</span>(<span class="dt">data =</span> back,<span class="kw">aes</span>(<span class="dt">x =</span> body, <span class="dt">y =</span> bp))<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">alpha =</span> <span class="fl">0.3</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">slope =</span> <span class="fl">0.03713</span>, <span class="dt">intercept =</span> <span class="fl">2.71125</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">140</span>))</code></pre></div>
<p><img src="sirius_advanced_files/figure-html/unnamed-chunk-14-1.png" width="672" /></p>
<p>Функция <code>predict()</code> позволяет скормить модели новые данные и получить предсказания для новых значений предикторов. Попробуем поиграть с этим немного. Допустим, предскажем вес рюкзака для студента весом в 100 кг:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">predict</span>(model, <span class="dt">newdata =</span> <span class="kw">data.frame</span>(<span class="dt">BodyWeightKG =</span> <span class="dv">100</span>))</code></pre></div>
<pre><code>##        1 
## 6.424229</code></pre>
<p>Мы можем даже попробовать какие-нибудь экстремальные значения для предикторов. Например, сколько будет весить рюкзак студента весом 1000 кг?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">predict</span>(model, <span class="dt">newdata =</span> <span class="kw">data.frame</span>(<span class="dt">BodyWeightKG =</span> <span class="dv">1000</span>))</code></pre></div>
<pre><code>##      1 
## 39.841</code></pre>
<p>Очевидно, что в этом не очень много смысла: студент весом 1000 кг не сможет ходить на занятия, поэтому и про вес рюкзака как-то не имеет смысл спрашивать. Это проблема экстрополяции: линейная регрессия позволяет более-менее достоверно предсказывать значения внутри диапазона значений, на которых была построена модель. Еще один “странный” пример - студент весом 0 кг.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">predict</span>(model, <span class="dt">newdata =</span> <span class="kw">data.frame</span>(<span class="dt">BodyWeightKG =</span> <span class="dv">0</span>))</code></pre></div>
<pre><code>##        1 
## 2.711255</code></pre>
<p>Здесь бессмысленность происходящего еще очевиднее. Конечно, вес студента не может быть равен нулю, иначе это не студент вовсе. Однако это позволяет понять, что такое intercept модели - это значение зависимой переменой в случае, если предиктор равен нулю. А коэффициент предиктора означает, насколько килограммов увеличивается вес рюкзака при увеличении веса студента на 1 кг: на 0.0371297. Не очень много!</p>
</div>
<div id="interpret" class="section level3">
<h3><span class="header-section-number">1.2.3</span> Интерпретация вывода линейной регрессии</h3>
<p>Давайте еще раз посмотрим на summary(model):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(model)</code></pre></div>
<pre><code>## 
## Call:
## lm(formula = BackpackWeightKG ~ BodyWeightKG, data = back)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -4.4853 -1.7629 -0.4681  1.2893  9.8803 
## 
## Coefficients:
##              Estimate Std. Error t value Pr(&gt;|t|)  
## (Intercept)   2.71125    1.37483   1.972   0.0514 .
## BodyWeightKG  0.03713    0.01945   1.909   0.0592 .
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 2.581 on 98 degrees of freedom
## Multiple R-squared:  0.03585,    Adjusted R-squared:  0.02601 
## F-statistic: 3.644 on 1 and 98 DF,  p-value: 0.05921</code></pre>
<p>Теперь мы понимаем, что это за коэффициенты. Однако это всего лишь их оценка. Это значит, что мы допускаем, что в реальности есть некие настоящие коэффициенты линейной регрессии, а каждый раз собирая новые данные, они будут посчитаны как немного разные. Короче говоря, эти коэффициенты - те же статистики, со своим выборочным распределением и стандартными ошибками. На основе чего и высчитывается p-value для каждого коэффициента - вероятность получить такой и более отклоняющийся от нуля коэффициент при верности нулевой гипотезы - независимости зависимой переменной от предиктора.</p>
<p>Кроме p-value, у линейной регрессии есть R<sup>2</sup> - доля объясненной дисперсии. Как ее посчитать? Для начала давайте сохраним как отдельные колонки ошибки (необъясненную часть модели) и предсказанные значения (они означают объясненную часть модели). Можно убедиться, что сумма предсказанных значений и ошибок будет равна зависимой переменной.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">model<span class="op">$</span>residuals</code></pre></div>
<pre><code>##           1           2           3           4           5           6 
## -0.73414413 -2.36666022 -0.19634292 -2.60017426 -2.11403371 -4.48531686 
##           7           8           9          10          11          12 
## -1.94561603 -4.01261202 -2.63272245 -3.82508188 -1.35615417  4.11950245 
##          13          14          15          16          17          18 
## -0.58483892 -0.58483892  0.62663298 -0.66904776  0.74339000 -1.75808589 
##          19          20          21          22          23          24 
## -0.28055176 -3.22218430  3.49749241  1.66855186 -0.16379474  0.64006870 
##          25          26          27          28          29          30 
## -2.72260803  2.75872534 -1.60878068 -2.80114012  5.42861891 -2.76859193 
##          31          32          33          34          35          36 
## -0.61738711  2.07161893 -0.90256180 -1.97816422  0.86014703  2.55775948 
##          37          38          39          40          41          42 
##  1.28119121 -0.41642125 -3.50735900 -1.49088831 -1.52457185  0.91180768 
##          43          44          45          46          47          48 
## -0.36476060  1.31373940 -0.53317827 -2.38009594 -2.14544654 -2.96955779 
##          49          50          51          52          53          54 
## -0.51974255 -0.70159594  3.04390004 -1.69298952  4.86054022  1.34628758 
##          55          56          57          58          59          60 
##  0.74339000  2.57460125 -0.36476060 -3.55901965 -0.98677064  1.08022535 
##          61          62          63          64          65          66 
## -1.12264013 -0.70159594 -0.75325660 -1.44036301 -0.97333492  9.88033377 
##          67          68          69          70          71          72 
##  0.59294945  1.11277354 -3.90929072 -2.54851361 -3.02121845  3.32907473 
##          73          74          75          76          77          78 
##  1.11277354  1.53381772 -1.77719836  6.20334021 -3.57245537 -1.18773650 
##          79          80          81          82          83          84 
##  1.90320125 -0.19634292  5.68124542  5.73290607 -2.38009594 -0.02792525 
##          85          86          87          88          89          90 
##  3.71757073  0.91180768 -0.78466943  1.36540005  3.49749241  1.59891409 
##          91          92          93          94          95          96 
##  2.92714302  2.75872534 -0.55115539  0.57497233  0.55585986  0.86014703 
##          97          98          99         100 
## -3.27384496  0.08883177 -0.98677064  1.22953056</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">back<span class="op">$</span>residuals =<span class="st"> </span><span class="kw">residuals</span>(model)
back<span class="op">$</span>fitted =<span class="st"> </span><span class="kw">fitted</span>(model)

back[, bp <span class="op">-</span><span class="st"> </span>(fitted <span class="op">+</span><span class="st"> </span>residuals)]</code></pre></div>
<pre><code>##   [1]  0.000000e+00 -4.440892e-16  0.000000e+00 -4.440892e-16  4.440892e-16
##   [6] -4.440892e-16 -4.440892e-16  2.220446e-16  0.000000e+00  1.110223e-16
##  [11] -4.440892e-16  0.000000e+00  0.000000e+00  0.000000e+00  0.000000e+00
##  [16]  0.000000e+00  0.000000e+00  0.000000e+00  0.000000e+00  0.000000e+00
##  [21]  0.000000e+00  0.000000e+00  0.000000e+00  0.000000e+00  0.000000e+00
##  [26]  0.000000e+00  4.440892e-16  4.440892e-16  0.000000e+00  0.000000e+00
##  [31]  0.000000e+00  0.000000e+00  0.000000e+00 -4.440892e-16 -8.881784e-16
##  [36]  0.000000e+00  0.000000e+00  0.000000e+00 -2.220446e-16 -4.440892e-16
##  [41] -4.440892e-16  0.000000e+00  0.000000e+00  0.000000e+00  0.000000e+00
##  [46]  0.000000e+00  4.440892e-16  0.000000e+00  0.000000e+00  0.000000e+00
##  [51]  0.000000e+00 -4.440892e-16  0.000000e+00  0.000000e+00  0.000000e+00
##  [56]  0.000000e+00  0.000000e+00 -4.440892e-16  0.000000e+00  0.000000e+00
##  [61] -8.881784e-16  0.000000e+00  0.000000e+00 -4.440892e-16  0.000000e+00
##  [66]  0.000000e+00  0.000000e+00  0.000000e+00 -3.330669e-16  0.000000e+00
##  [71]  4.440892e-16  0.000000e+00  0.000000e+00  0.000000e+00  0.000000e+00
##  [76]  0.000000e+00 -3.330669e-16  4.440892e-16  0.000000e+00  0.000000e+00
##  [81]  0.000000e+00  0.000000e+00  0.000000e+00  0.000000e+00  0.000000e+00
##  [86]  0.000000e+00  0.000000e+00 -8.881784e-16  0.000000e+00 -8.881784e-16
##  [91]  0.000000e+00  0.000000e+00  0.000000e+00  0.000000e+00  0.000000e+00
##  [96] -8.881784e-16  0.000000e+00  0.000000e+00  0.000000e+00  0.000000e+00</code></pre>
<p>Соответственно, вся сумма объясненной дисперсии разделяется на объясненую и необъясненную. Полная дисперсия (total sum of squares = TSS) может быть посчитана как сумма квадратов разниц со средним. Необъясненная дисперсия - это сумма квадратов ошибок - residual sum of squares (RSS).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rss &lt;-<span class="st"> </span>back[, <span class="kw">sum</span>(residuals<span class="op">^</span><span class="dv">2</span>)]
rss</code></pre></div>
<pre><code>## [1] 652.7272</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tss &lt;-<span class="st"> </span>back[, <span class="kw">sum</span>((bp <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(bp))<span class="op">^</span><span class="dv">2</span>)]
tss</code></pre></div>
<pre><code>## [1] 676.995</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="dv">1</span><span class="op">-</span><span class="st"> </span>rss<span class="op">/</span>tss</code></pre></div>
<pre><code>## [1] 0.03584628</code></pre>
<p>Это очень мало, мы объяснили всего 3.5846285% дисперсии. Собственно, и p-value больше, чем 0,05. При этом этот p-value тот же, что и при коэффициента корреляции Пирсона. А R<sup>2</sup> - это квадрат коэффициента корреляции Пирсона, если речь идет только об одном предикторе.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(model)</code></pre></div>
<pre><code>## 
## Call:
## lm(formula = BackpackWeightKG ~ BodyWeightKG, data = back)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -4.4853 -1.7629 -0.4681  1.2893  9.8803 
## 
## Coefficients:
##              Estimate Std. Error t value Pr(&gt;|t|)  
## (Intercept)   2.71125    1.37483   1.972   0.0514 .
## BodyWeightKG  0.03713    0.01945   1.909   0.0592 .
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 2.581 on 98 degrees of freedom
## Multiple R-squared:  0.03585,    Adjusted R-squared:  0.02601 
## F-statistic: 3.644 on 1 and 98 DF,  p-value: 0.05921</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">cor.test</span>(back<span class="op">$</span>bp, back<span class="op">$</span>body)<span class="op">$</span>estimate<span class="op">^</span><span class="dv">2</span></code></pre></div>
<pre><code>##        cor 
## 0.03584628</code></pre>
</div>
<div id="lm_a" class="section level3">
<h3><span class="header-section-number">1.2.4</span> Допущения линейной регрессии</h3>
<p>Как и в случае с другими параметрическими методами, линейная регрессия имеет определенные допущения относительно используемых данных. Если они не соблюдаются, то все наши расчеты уровня значимости могут некорректными.</p>
<blockquote>
<p>Очень важно ставить вопрос о том, насколько результаты будут некорректными. Как сильно нарушения допущений будет влиять на модель? Ответ на этот вопрос может быть контринтуитивен. Например, достаточно большие отклонения от нормальности нам обычно не стражны при условии того, что выборка достаточно большая.</p>
</blockquote>
<p>Допущения линейной регрессии связаны с ошибками: они должны быть нормально распределены, а разброс ошибок должен не уменьшаться и не увеличиваться в зависимости от предсказанных значений. Это то, что называется гомоскедастичностью или гомогенностью (когда все хорошо) и гетероскедастичностью или гетерогенностью (когда все плохо).</p>
<p>Если мы применим функцию plot(), то получим 4 скаттерплота:</p>
<ol style="list-style-type: decimal">
<li><p><em>Зависимость ошибок от предсказанных значений.</em> На что здесь смотреть? На симметричность относительно нижней и верхней части графика, на то, что разброс примерно одинаковый слева и справа.</p></li>
<li><p><em>Q-Q plot.</em> Здесь все довольно просто: если ошибки являются выборкой из нормального распределения, то они выстраиваются в прямую линию. Если это мало похоже на прямую линию, то имеет место отклонение от нормальности.</p></li>
<li><p><em>Scale-Location plot.</em> Этот график очень похож на график 1, только по оси у используются квадратные корни модуля ошибки. Еще один способ исследовать гетеро(гомо)скедастичность и находить выбросы.</p></li>
<li><p><em>Residuals-Leverage plot.</em> Здесь по оси х - расстояние Кука, а по оси у - стандартизированный размер выбросов. Расстояние Кука показывает high-leverage points - точки, которые имеют экстремальные предсказанные значения, то есть очень большие или очень маленькие значения по предикторам. Для линейной регрессии такие значения имеют большее значение, чем экстремальные точки по предсказываемой переменной. Особенно сильное влияние имеют точки, которые имеют экстремальные значения и по предикторам, и по предсказываемой переменной. Одна такая точка может поменять направление регрессионной прямой! Расстояние Кука отражает уровень leverage, а стандартизированные ошибки отражают экстремальные значения по у (вернее, экстремальные отклонения от предсказанных значений). В этом графике нужно смотреть на точки с правой стороны графика, особенно если они находятся высоко или низко по оси у.</p></li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(model)</code></pre></div>
<p><img src="sirius_advanced_files/figure-html/unnamed-chunk-23-1.png" width="672" /><img src="sirius_advanced_files/figure-html/unnamed-chunk-23-2.png" width="672" /><img src="sirius_advanced_files/figure-html/unnamed-chunk-23-3.png" width="672" /><img src="sirius_advanced_files/figure-html/unnamed-chunk-23-4.png" width="672" /></p>
<p>Давайте теперь нарисуем регрессионную прямую на скаттерплоте:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="dt">data =</span> back,<span class="kw">aes</span>(<span class="dt">x =</span> body, <span class="dt">y =</span> bp))<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">alpha =</span> <span class="fl">0.3</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">slope =</span> model<span class="op">$</span>coefficients[<span class="dv">2</span>], <span class="dt">intercept =</span> model<span class="op">$</span>coefficients[<span class="dv">1</span>])</code></pre></div>
<p><img src="sirius_advanced_files/figure-html/unnamed-chunk-24-1.png" width="672" /></p>
<p><strong>Самостоятельное задание:</strong></p>
<ol style="list-style-type: decimal">
<li><p>На практике как экстремальные точки часто выбирают среднее плюс минус два (или три стандартных отклонения). Напишите функцию <code>is_outlier()</code>, которая возвращает <code>TRUE</code>, если значение выходит за 2 стандартных отклонения от среднего.</p></li>
<li><p>Затем измените функцию <code>is_outlier()</code> так, чтобы можно было бы самостоятельно вводить количество стандартных отклонений с помощью параметра <code>n =</code>. Пусть по умолчанию это будет 3. Но проверьте, ято все работает и на 2!</p></li>
<li><p>Теперь измените функцию <code>is_outlier()</code> так, чтобы можно было выбирать функцию для меры центральности (<code>centr =</code>, по умолчанию - среднее) и функцию для меры разброса (<code>vary =</code>, по умолчанию - стандартное отклонение). Проверьте, что это работает на медиане и 3 median absolute deviation. Как Вы думаете, какой из вариантов подходит больше? Почему?</p></li>
</ol>
<blockquote>
<p>О, да, в R функция тоже может быть использована в качестве аргумента функции. Впрочем, это не первый случай, когда мы с этим сталкиваемся. Другой пример - функции семейства <code>*apply()</code>. Заметьте - там тоже в качестве аргумента выступала функция (как объект), а не просто название функции как строковая переменная. В этом задании нужно сделать так же.</p>
</blockquote>
</div>
<div id="outliers" class="section level3">
<h3><span class="header-section-number">1.2.5</span> Влияние выбросов на линейную модель</h3>
<p>Давайте теперь попробуем посмотреть, как изменится модель, если выкинуть high leverage points (экстремальные значения по предиктору - body) и что будет, если выкинуть экстремальные значения по у. Обычная линия - регрессионная прямая для модели со всеми точками, штрихованная линия - регрессионная прямая для модели без экстремальных значений по предиктору, пунктирная линия - регрессионная прямая для модели без экстремальных значений по предсказываемой переменной.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">back[, body_outlier <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">is_outlier</span>(body)]
back[, bp_outlier <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">is_outlier</span>(bp)]
model1 &lt;-<span class="st"> </span><span class="kw">lm</span>(BackpackWeightKG <span class="op">~</span><span class="st"> </span>BodyWeightKG, <span class="dt">data =</span> back[<span class="op">!</span><span class="kw">is_outlier</span>(body),])
<span class="kw">summary</span>(model1)</code></pre></div>
<pre><code>## 
## Call:
## lm(formula = BackpackWeightKG ~ BodyWeightKG, data = back[!is_outlier(body), 
##     ])
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -4.6526 -1.7471 -0.3773  1.1699  9.0854 
## 
## Coefficients:
##              Estimate Std. Error t value Pr(&gt;|t|)   
## (Intercept)   0.48577    1.65749   0.293  0.77011   
## BodyWeightKG  0.07128    0.02413   2.953  0.00397 **
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 2.548 on 94 degrees of freedom
## Multiple R-squared:  0.08491,    Adjusted R-squared:  0.07517 
## F-statistic: 8.722 on 1 and 94 DF,  p-value: 0.003971</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">model2 &lt;-<span class="st"> </span><span class="kw">lm</span>(BackpackWeightKG <span class="op">~</span><span class="st"> </span>BodyWeightKG, <span class="dt">data =</span> back[<span class="op">!</span><span class="kw">is_outlier</span>(bp),])
<span class="kw">summary</span>(model2)</code></pre></div>
<pre><code>## 
## Call:
## lm(formula = BackpackWeightKG ~ BodyWeightKG, data = back[!is_outlier(bp), 
##     ])
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -3.7843 -1.4343 -0.1363  1.4296  4.9122 
## 
## Coefficients:
##              Estimate Std. Error t value Pr(&gt;|t|)   
## (Intercept)   3.60560    1.13144   3.187  0.00196 **
## BodyWeightKG  0.01915    0.01610   1.190  0.23716   
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 2.087 on 93 degrees of freedom
## Multiple R-squared:  0.01499,    Adjusted R-squared:  0.004402 
## F-statistic: 1.416 on 1 and 93 DF,  p-value: 0.2372</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="dt">data =</span> back, <span class="kw">aes</span>(<span class="dt">x =</span> body, <span class="dt">y =</span> bp, <span class="dt">colour =</span>bp_outlier, <span class="dt">shape =</span> body_outlier))<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">alpha =</span> <span class="fl">0.3</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">intercept =</span> model<span class="op">$</span>coefficients[<span class="dv">1</span>], <span class="dt">slope =</span> model<span class="op">$</span>coefficients[<span class="dv">2</span>])<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">intercept=</span> model1<span class="op">$</span>coefficients[<span class="dv">1</span>], 
              <span class="dt">slope =</span> model1<span class="op">$</span>coefficients[<span class="dv">2</span>], <span class="dt">linetype =</span> <span class="st">&quot;dashed&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">intercept=</span> model2<span class="op">$</span>coefficients[<span class="dv">1</span>], 
              <span class="dt">slope =</span> model2<span class="op">$</span>coefficients[<span class="dv">2</span>], <span class="dt">linetype =</span> <span class="st">&quot;dotted&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">theme_minimal</span>()</code></pre></div>
<p><img src="sirius_advanced_files/figure-html/unnamed-chunk-29-1.png" width="672" /></p>
</div>
</div>
<div id="lm_mult" class="section level2">
<h2><span class="header-section-number">1.3</span> Множественная линейная регрессия</h2>
<p>В множественной линейной регрессионной регрессии у нас появляется несколько предикторов. Какая модель лучше: где есть много предикторов или где мало предикторов? С одной стороны, чем больше предикторов, тем лучше: каждый новый предиктор может объяснить чуть больше необъясненной дисперсиии. С другой стороны, если эта прибавка маленькая (а она всегда будет не меньше нуля), то, возможно, новый предиктор просто объясняет “случайный шум”. В действительности, если у нас будет достаточно много предикторов, то мы сможем объяснить любые данные! Парадоксальным образом такая модель будет давать очень плохие данные на новой выборке - это то, что в машинном обучении называют переобучением (overfitting). Идеальная модель будет включать минимум предикторов, которые лучше всего объясненяют исследуемую переменную. Это что-то вроде <a href="https://ru.wikipedia.org/wiki/Бритва_Оккама">бритвы Оккама</a> в статистике.</p>
<p>Поэтому часто используются показатели качества модели, которые “наказывают” модель за большое количество предикторов. Например, adjusted R<sup>2</sup>:</p>
<p><span class="math display">\[R_{adj} = 1 - (1 - R^2) \frac{n -1}{n - p - 1}\]</span></p>
<p>Здесь <em>n</em> - это количество наблюдений, <em>p</em> - количество параметров.</p>
<p>Итак, добавим новый предиктор - <em>Units</em>. Это количество кредитов, которые студенты взяли в четверти<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a>. Можно предположить, что чем больше у студента набрано кредитов, тем более тяжелый у нее/него рюкзак. Давайте добавим это как второй предиктор. Для этого нужно просто записать второй предиктор в формуле через плюс.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">model3 &lt;-<span class="st"> </span><span class="kw">lm</span>(bp <span class="op">~</span><span class="st"> </span>body <span class="op">+</span><span class="st"> </span>Units, <span class="dt">data =</span> back)
<span class="kw">summary</span>(model3)</code></pre></div>
<pre><code>## 
## Call:
## lm(formula = bp ~ body + Units, data = back)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -4.6221 -1.8347 -0.5023  1.2519 10.0623 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)  
## (Intercept)  0.28481    2.16170   0.132   0.8955  
## body         0.04391    0.01990   2.207   0.0297 *
## Units        0.13703    0.09456   1.449   0.1505  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 2.566 on 97 degrees of freedom
## Multiple R-squared:  0.05628,    Adjusted R-squared:  0.03682 
## F-statistic: 2.892 on 2 and 97 DF,  p-value: 0.06025</code></pre>
<p>Множественная линейная регрессия имеет еще одно допущение: отстутсвие мультиколлинеарности. Это значит, что предикторы не должны коррелировать друг с другом.</p>
<p>Для измерения мультколлинеарности существует variance inflation factor (VIF-фактор). Считается он просто: для предиктора <span class="math inline">\(i\)</span> считается линейная регрессия, где все остальные предикторы предсказывают предиктор <span class="math inline">\(i\)</span>.</p>
<p>Сам VIF-фактор считается на основе полученного R<sup>2</sup> регрессии:</p>
<p><span class="math display">\[VIF_i = \frac{1}{1 - R_i^2}\]</span></p>
<p>Если R<sub>i</sub><sup>2</sup> большой, то и VIF<sub>i</sub> выходит большим. Это означает, что предиктор сам по себе хорошо объясняется другими предикторами. Какой VIF считать большим? Здесь нет единого мнения, но если он выше 3 и особенно если он выше 10, то с этим нужно что-то делать.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">car<span class="op">::</span><span class="kw">vif</span>(model3)</code></pre></div>
<pre><code>##    body   Units 
## 1.05858 1.05858</code></pre>
<p>В нашем случае это не так. Но если бы VIF был большим для какого-либо предиктора, то можно было бы либо попробовать его выкинуть или же использовать анализ главных компонент, о котором пойдет речь в один из следующих дней.</p>
<!--chapter:end:01-Week2Day1_lm.Rmd-->
</div>
</div>
<div id="d2" class="section level1">
<h1><span class="header-section-number">2</span> Неделя 2, День 2</h1>
<div id="anova" class="section level2">
<h2><span class="header-section-number">2.1</span> Дисперсионный анализ (ANOVA)</h2>
<p>Дисперсионный анализ или ANOVA<a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a> - один из самых распространенных методов статистического анализа в психологии и многих других дисциплинах. Дисперсионный анализ очень хорошо подходит для анализа данных, полученных в эксперименте - методе организации исследования, при котором исследователь напрямую управляет уровнями независимой переменной. Терминологическая связь между дисперсионным анализом и планированием эксперимента настолько тесная, что многие итермины пересекаются, поэтому нужно быть осторожными. Как и в случае с линейной регрессией, если мы что-то называем “независимой переменной” (или “фактором”), это не порождает никакой каузальной связи.</p>
<p>Еще одна важная вещь, которую нужно понимать про дисперсионный анализ, это то, что у этого метода очень запутывающее название: из названия кажется, что этот статистический метод для сравнения дисперсий. Нет, это не так (хотя такие статистические тесты тоже есть, и они нам сегодня пригодятся!). Нет, это просто сравнение средних в случае, если есть больше, чем 2 группы для сравнения.</p>
<p>У дисперсионного анализа очень много разновидностей, для которых придумали множество названий. “Обычная” ANOVA называется One-Way ANOVA, она же межгрупповая ANOVA, это аналог независимого т-теста для нескольких групп.</p>
<p>Давайте начнем сразу с проведения теста. Мы будем использовать <a href="https://www.sheffield.ac.uk/polopoly_fs/1.570199!/file/stcp-Rdataset-Diet.csv">данные с курса по статистике Университета Шеффилда про эффективность диет</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(data.table)
diet &lt;-<span class="st"> </span><span class="kw">fread</span>(<span class="st">&quot;data/stcp-Rdataset-Diet.csv&quot;</span>)</code></pre></div>
<p>Сделаем небольшой препроцессинг данных. Создадим дополнительные “факторные” переменные, создадим переменную, в которой будет разница массы “до” и “после”, удалим <code>NA</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">diet[, weight.loss <span class="op">:</span><span class="er">=</span><span class="st"> </span>weight6weeks <span class="op">-</span><span class="st"> </span>pre.weight]
diet[, Dietf <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(Diet, <span class="dt">labels =</span> LETTERS[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>])]
diet[, Person <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(Person)]
diet &lt;-<span class="st"> </span>diet[<span class="kw">complete.cases</span>(diet),]</code></pre></div>
<div id="aov" class="section level3">
<h3><span class="header-section-number">2.1.1</span> Функция aov()</h3>
<p>Попробуем сразу провести дисперсионных анализ с помощью функции <code>aov()</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">aov_model &lt;-<span class="st"> </span><span class="kw">aov</span>(weight.loss <span class="op">~</span><span class="st"> </span>Dietf, diet)
aov_model</code></pre></div>
<pre><code>## Call:
##    aov(formula = weight.loss ~ Dietf, data = diet)
## 
## Terms:
##                    Dietf Residuals
## Sum of Squares   60.5270  410.4018
## Deg. of Freedom        2        73
## 
## Residual standard error: 2.371064
## Estimated effects may be unbalanced</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(aov_model)</code></pre></div>
<pre><code>##             Df Sum Sq Mean Sq F value Pr(&gt;F)   
## Dietf        2   60.5  30.264   5.383 0.0066 **
## Residuals   73  410.4   5.622                  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>Мы получили что-то похожее на результат применения функции <code>lm()</code>. Правда, лаконичнее, но с новыми столбцами <code>Sum Sq</code>, <code>Mean Sq</code> и новой статистикой <em>F</em> вместо <em>t</em>. Что будет, если с теми же данными с той же формулой запустить <code>lm()</code> вместо <code>aov()</code>?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(<span class="kw">lm</span>(weight.loss <span class="op">~</span><span class="st"> </span>Dietf, diet))</code></pre></div>
<pre><code>## 
## Call:
## lm(formula = weight.loss ~ Dietf, data = diet)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -5.7000 -1.6519 -0.1759  1.4420  5.3680 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  -3.3000     0.4840  -6.818 2.26e-09 ***
## DietfB        0.0320     0.6776   0.047  0.96246    
## DietfC       -1.8481     0.6652  -2.778  0.00694 ** 
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 2.371 on 73 degrees of freedom
## Multiple R-squared:  0.1285, Adjusted R-squared:  0.1047 
## F-statistic: 5.383 on 2 and 73 DF,  p-value: 0.006596</code></pre>
<p><code>lm()</code> превратил <code>Dietf</code> в две переменные, но <em>F</em> и p-value у двух моделей одинаковые! Кроме того, функция <code>aov()</code> является, по сути, просто “оберткой” над <code>lm()</code>:</p>
<blockquote>
<p>This provides a wrapper to lm for fitting linear models to balanced or unbalanced experimental designs.</p>
</blockquote>
</div>
<div id="anova_nhst" class="section level3">
<h3><span class="header-section-number">2.1.2</span> Тестирование значимости нулевой гипотезы в ANOVA.</h3>
<p>Как и в случае с другими статистическими тестами, мы можем выделить 4 этапа в тестировании значимости нулевой гипотезы в ANOVA:</p>
<ol style="list-style-type: decimal">
<li><strong>Формулирование нулевой и альтернативной гипотезы.</strong> Нулевая гипотеза говорит, что между средними в генеральной совокупности нет различий:</li>
</ol>
<p><span class="math display">\[H_0:\mu_1 = \mu_2 = ... = \mu_n\]</span> Можно было бы предположить, что ненулевая гипотеза звучит как “все средние не равны”, но вообще-то это не так. Альтернативная гипотеза в дисперсионном анализе звучит так:</p>
<p><span class="math display">\[H_1: \text{Не все средние равны}\]</span></p>
<ol start="2" style="list-style-type: decimal">
<li><strong>Подсчет статистики.</strong> Как мы уже видели раньше, в дисперсионном анализе используется новая для нас статистика <em>F</em>. Впрочем, мы ее видели, когда смотрели на аутпут функции <code>lm()</code>, когда делали линейную регрессию. Чтобы считать <em>F</em> (если вдруг мы хотим сделать это вручную), нужно построить талбицу ANOVA (ANOVA table).</li>
</ol>
<table>
<colgroup>
<col width="19%" />
<col width="11%" />
<col width="18%" />
<col width="27%" />
<col width="22%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Таблица ANOVA</th>
<th align="center">Степени свободы</th>
<th align="center">Суммы квадратов</th>
<th align="center">Средние квадраты</th>
<th align="center">F-статистика</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Межгрупповые</td>
<td align="center"><span class="math inline">\(df_{b}\)</span></td>
<td align="center"><span class="math inline">\(SS_{b}\)</span></td>
<td align="center"><span class="math inline">\(MS_{b} =\frac{SS_{b}}{df_{b}}\)</span></td>
<td align="center"><span class="math inline">\(F=\frac{MS_{b}}{MS_{w}}\)</span></td>
</tr>
<tr class="even">
<td align="left">Внутригрупповые</td>
<td align="center"><span class="math inline">\(df_{w}\)</span></td>
<td align="center"><span class="math inline">\(SS_{w}\)</span></td>
<td align="center"><span class="math inline">\(MS_{w} =\frac{SS_{w}}{df_{w}}\)</span></td>
<td align="center"></td>
</tr>
<tr class="odd">
<td align="left">Общие</td>
<td align="center"><span class="math inline">\(df_{t}\)</span></td>
<td align="center"><span class="math inline">\(SS_{t}= SS_{b} + SS_{w}\)</span></td>
<td align="center"></td>
<td align="center"></td>
</tr>
</tbody>
</table>
<p>Именно эту таблицу мы видели, когда использовали функцию <code>aov()</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(aov_model)</code></pre></div>
<pre><code>##             Df Sum Sq Mean Sq F value Pr(&gt;F)   
## Dietf        2   60.5  30.264   5.383 0.0066 **
## Residuals   73  410.4   5.622                  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>Вот как это все считается:</p>
<table>
<colgroup>
<col width="8%" />
<col width="8%" />
<col width="32%" />
<col width="17%" />
<col width="32%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Таблица ANOVA</th>
<th align="center">Степени свободы</th>
<th align="center">Суммы квадратов</th>
<th align="center">Средние квадраты</th>
<th align="center">F-статистика</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Между</td>
<td align="center"><span class="math inline">\(df_{b}=J-1\)</span></td>
<td align="center"><span class="math inline">\(SS_{b}= \sum\limits_{j=1}^J \sum\limits_{i=1}^{n_j} (\overline{x_j}-\overline{x})^2\)</span></td>
<td align="center"><span class="math inline">\(MS_{b} =\frac{SS_{b}}{df_{b}}\)</span></td>
<td align="center"><span class="math inline">\(F=\frac{MS_{b}}{MS_{w}}\)</span></td>
</tr>
<tr class="even">
<td align="left">Внутри</td>
<td align="center"><span class="math inline">\(df_{w}=N-J\)</span></td>
<td align="center"><span class="math inline">\(SS_{w}= \sum\limits_{j=1}^J \sum\limits_{i=1}^{n_j} (x_{ij}-\overline{x_j})^2\)</span></td>
<td align="center"><span class="math inline">\(MS_{w} =\frac{SS_{w}}{df_{w}}\)</span></td>
<td align="center"></td>
</tr>
<tr class="odd">
<td align="left">Общие</td>
<td align="center"><span class="math inline">\(df_{t}=N-1\)</span></td>
<td align="center"><span class="math inline">\(SS_{t}= \sum\limits_{j=1}^J \sum\limits_{i=1}^{n_j} (x_{ij}-\overline{x})^2\)</span></td>
<td align="center"></td>
<td align="center"></td>
</tr>
</tbody>
</table>
<p><span class="math inline">\(J\)</span> означает количество групп, <span class="math inline">\(N\)</span> - общее количество наблюдений во всех группах, <span class="math inline">\(n_j\)</span> означает количество наблюдений в группе j, а <span class="math inline">\(x_{ij}\)</span> - наблюдение под номером <span class="math inline">\(i\)</span> в группе <span class="math inline">\(j\)</span>.</p>
<p>Вариабельность обозначается <span class="math inline">\(SS\)</span> и означает “сумму квадратов” (sum of squares) - это то же, что и дисперсия, только мы не делим вме в конце на количество наблюдений (или количество наблюдений минус один): <span class="math display">\[SS = \sum\limits_{i=1}^{n_j} (x_{i}-\overline{x})^2\]</span></p>
<p>Здесь много формул, но суть довольно простая: мы разделяем вариабельность зависимой переменной на внутригрупповую и межгрупповую, считаем их соотношение, которое и будет <em>F</em>. В среднем, <em>F</em> будет равен 1 при верности нулевой гипотезы. Это означает, что и межгрупповая вариабельность, и внутригрупповая вариабельность - это просто шум. Но если же межгрупповая вариабельность - это не просто шум, то это соотношение будет сильно больше единицы.</p>
<ol start="3" style="list-style-type: decimal">
<li><strong>Подсчет p-value.</strong> В т-тесте мы смотрели, как статистика распределена при условии верности нулевой гипотезы. То есть что будет, если нулевая гипотеза верна, мы будем повторять эксперимент с точно таким же дизайном (и размером выборок) бесконечное количество раз и считать <em>F</em>.</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">betweendf &lt;-<span class="st"> </span><span class="dv">2</span>
withindf &lt;-<span class="st"> </span><span class="dv">73</span>
f &lt;-<span class="st"> </span><span class="kw">summary</span>(aov_model)[[<span class="dv">1</span>]]<span class="op">$</span>F[<span class="dv">1</span>]

v &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="fl">0.1</span>,<span class="dv">10</span>, <span class="fl">0.01</span>)
fdist &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">fvalues =</span> v, <span class="dt">pdf =</span> <span class="kw">df</span>(v, betweendf, withindf))

<span class="kw">library</span>(ggplot2)

label &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;F(&quot;</span>, betweendf, <span class="st">&quot;, &quot;</span>, withindf, <span class="st">&quot;) = &quot;</span>, <span class="kw">round</span>(f, <span class="dv">3</span>))

<span class="kw">ggplot</span>(fdist, <span class="kw">aes</span>(<span class="dt">x =</span> fvalues, <span class="dt">y =</span> pdf))<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> f)<span class="op">+</span>
<span class="st">  </span><span class="kw">annotate</span>(<span class="st">&quot;text&quot;</span>, <span class="dt">x =</span> f<span class="op">+</span><span class="dv">1</span>, <span class="dt">y =</span> <span class="fl">0.2</span>, <span class="dt">label =</span> label)<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">expand=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">theme_minimal</span>()<span class="op">+</span>
<span class="kw">theme</span>(<span class="dt">axis.line.y =</span> <span class="kw">element_blank</span>(),
      <span class="dt">axis.ticks.y =</span> <span class="kw">element_blank</span>(),
      <span class="dt">axis.text.y =</span> <span class="kw">element_blank</span>(),
      <span class="dt">axis.title.y =</span> <span class="kw">element_blank</span>())  </code></pre></div>
<div class="figure">
<img src="sirius_advanced_files/figure-html/unnamed-chunk-37-1.png" alt="\label{fig:fig1}F-распределение при верности нулевой гипотезы (см. детали в тексте)" width="60%" />
<p class="caption">
(#fig:unnamed-chunk-37)F-распределение при верности нулевой гипотезы (см. детали в тексте)
</p>
</div>
<p>Заметьте, распределение <em>F</em> несимметричное<a href="#fn3" class="footnoteRef" id="fnref3"><sup>3</sup></a>. Это значит, что мы всегда считаем считаем площадь от <em>F</em> до плюс бесконечности (без умножения на 2, как мы это делали в т-тесте):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="dv">1</span> <span class="op">-</span><span class="st"> </span><span class="kw">pf</span>(f, betweendf, withindf)</code></pre></div>
<pre><code>## [1] 0.006595853</code></pre>
<p>Это и есть наш p-value!</p>
<ol start="4" style="list-style-type: decimal">
<li><strong>Сравнение p-value с уровнем <span class="math inline">\(\alpha\)</span>.</strong> Самый простой этап: если наш p-value меньше, чем <span class="math inline">\(\alpha\)</span> (который обычно равен .05), то мы отвергаем нулевую гипотезу. Если нет - не отвергаем.</li>
</ol>
<p>В нашем случае это 0.0065959, что, очевидно, меньше, чем .05. Отвергаем нулевую гипотезу (о том, что нет различий), принимаем ненулевую (о том, что различия есть). Все!</p>
</div>
<div id="anova_posthoc" class="section level3">
<h3><span class="header-section-number">2.1.3</span> Post-hoc тесты</h3>
<p>Тем не менее, дисперсионного анализа недостаточно, чтобы решить, какие именно группы между собой различаются. Для этого нужно проводить post-hoc тесты (апостериорные тесты).</p>
<p>Post-hoc переводится с латыни как “после этого”. Post-hoc тесты проводятся, если в результате ANOVA Вы отвергли нулевую гипотезу. Собственно, пост-хоки никак не связаны с дисперсионным анализом на уровне расчетов - это абсолютно независимые тесты, но исторически так сложилось, что они известны именно как дополнительный этап ANOVA.</p>
<p>Самый простой вариант пост-хок теста - это попарные т-тесты с поправками на множественные сравнения:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">pairwise.t.test</span>(diet<span class="op">$</span>weight.loss, diet<span class="op">$</span>Dietf)</code></pre></div>
<pre><code>## 
##  Pairwise comparisons using t tests with pooled SD 
## 
## data:  diet$weight.loss and diet$Dietf 
## 
##   A     B    
## B 0.962 -    
## C 0.017 0.017
## 
## P value adjustment method: holm</code></pre>
<p>Второй подход связан с использованием специализированных тестов, таких как тест Тьюки (Tukey Honest Significant Differences = Tukey HSD). Для этого в R есть функция <code>TukeyHSD()</code>, которую нужно применять на объект <code>aov</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">TukeyHSD</span>(aov_model)</code></pre></div>
<pre><code>##   Tukey multiple comparisons of means
##     95% family-wise confidence level
## 
## Fit: aov(formula = weight.loss ~ Dietf, data = diet)
## 
## $Dietf
##          diff       lwr        upr     p adj
## B-A  0.032000 -1.589085  1.6530850 0.9987711
## C-A -1.848148 -3.439554 -0.2567422 0.0188047
## C-B -1.880148 -3.454614 -0.3056826 0.0152020</code></pre>
</div>
<div id="aov_as_lm" class="section level3">
<h3><span class="header-section-number">2.1.4</span> ANOVA и т-тест как частные случаи линейной регрессии</h3>
<p>Как мы уже видели, если применить <code>lm()</code> или <code>aov()</code> на одних и тех же данных с одной и той же формулой, то результат будет очень похожим. Но есть одно но: <code>lm()</code> создает из одного фактора две переменных-предиктора:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(<span class="kw">lm</span>(weight.loss <span class="op">~</span><span class="st"> </span>Dietf, diet))</code></pre></div>
<pre><code>## 
## Call:
## lm(formula = weight.loss ~ Dietf, data = diet)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -5.7000 -1.6519 -0.1759  1.4420  5.3680 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  -3.3000     0.4840  -6.818 2.26e-09 ***
## DietfB        0.0320     0.6776   0.047  0.96246    
## DietfC       -1.8481     0.6652  -2.778  0.00694 ** 
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 2.371 on 73 degrees of freedom
## Multiple R-squared:  0.1285, Adjusted R-squared:  0.1047 
## F-statistic: 5.383 on 2 and 73 DF,  p-value: 0.006596</code></pre>
<p>Дело в том, что мы не можем просто так загнать номинативную переменную в качестве предиктора в линейную регрессию. Мы можем это легко сделать, если у нас всего два уровня в номинативном предикторе. Тогда один из уровней можно обозначить за 0, другой - за 1. Такие переменные иногда называются “бинарными”. Тогда это легко использовать в линейной регрессии:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(<span class="kw">lm</span>(weight.loss <span class="op">~</span><span class="st"> </span>gender, diet))</code></pre></div>
<pre><code>## 
## Call:
## lm(formula = weight.loss ~ gender, data = diet)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -5.1848 -1.7264  0.2041  1.6846  5.9930 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  -3.8930     0.3846 -10.123  1.3e-15 ***
## gender       -0.1221     0.5836  -0.209    0.835    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 2.522 on 74 degrees of freedom
## Multiple R-squared:  0.0005914,  Adjusted R-squared:  -0.01291 
## F-statistic: 0.04379 on 1 and 74 DF,  p-value: 0.8348</code></pre>
<p>Можно ли так делать? Вполне! Допущения линейной регрессии касаются остатков, а не переменных самих по себе. Разве что это немного избыточно: линейная регрессия с бинарным предиктором - это фактически независимый т-тест:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">t.test</span>(weight.loss <span class="op">~</span><span class="st"> </span>gender, diet, <span class="dt">var.equal =</span> <span class="ot">TRUE</span>)</code></pre></div>
<pre><code>## 
##  Two Sample t-test
## 
## data:  weight.loss by gender
## t = 0.20925, df = 74, p-value = 0.8348
## alternative hypothesis: true difference in means is not equal to 0
## 95 percent confidence interval:
##  -1.040810  1.285067
## sample estimates:
## mean in group 0 mean in group 1 
##       -3.893023       -4.015152</code></pre>
<p>Как видите, p-value совпадают! А <em>t</em> статистика в квадрате - это <em>F</em> (при двух группах):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">t.test</span>(weight.loss <span class="op">~</span><span class="st"> </span>gender, diet, <span class="dt">var.equal =</span> <span class="ot">TRUE</span>)<span class="op">$</span>statistic<span class="op">^</span><span class="dv">2</span></code></pre></div>
<pre><code>##          t 
## 0.04378592</code></pre>
<p>Более того, те же самые результаты можно получить и с помощью коэффициента корреляции Пирсона:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">cor.test</span>(diet<span class="op">$</span>gender, diet<span class="op">$</span>weight.loss)</code></pre></div>
<pre><code>## 
##  Pearson&#39;s product-moment correlation
## 
## data:  diet$gender and diet$weight.loss
## t = -0.20925, df = 74, p-value = 0.8348
## alternative hypothesis: true correlation is not equal to 0
## 95 percent confidence interval:
##  -0.2484113  0.2022466
## sample estimates:
##         cor 
## -0.02431772</code></pre>
<p>Теперь должно быть понятно, почему все эти функции делают вроде бы разные статистические тесты, но выдают такой похожий результат - это фактически один и тот же метод! Все эти методы (и некоторые из тех, что будем рассматривать далее) можно рассматривать как разновидности множественной линейной регрессии.<a href="#fn4" class="footnoteRef" id="fnref4"><sup>4</sup></a></p>
</div>
<div id="dummy" class="section level3">
<h3><span class="header-section-number">2.1.5</span> Dummy coding</h3>
<p>Тем не менее, вопрос остается открытым: как превратить номинативную переменную в количественную и загнать ее в регрессию? Для этого можно использовать “фиктивное кодирование” (dummy coding):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">diet[, isA <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">as.numeric</span>(Dietf <span class="op">==</span><span class="st"> &quot;A&quot;</span>)]
diet[, isB <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">as.numeric</span>(Dietf <span class="op">==</span><span class="st"> &quot;B&quot;</span>)]
diet[, isC <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">as.numeric</span>(Dietf <span class="op">==</span><span class="st"> &quot;C&quot;</span>)]
diet[<span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>,<span class="dv">15</span><span class="op">:</span><span class="dv">16</span>,<span class="dv">35</span><span class="op">:</span><span class="dv">36</span>),<span class="kw">c</span>(<span class="st">&quot;Dietf&quot;</span>, <span class="st">&quot;isA&quot;</span>, <span class="st">&quot;isB&quot;</span>, <span class="st">&quot;isC&quot;</span>)]</code></pre></div>
<pre><code>##    Dietf isA isB isC
## 1:     A   1   0   0
## 2:     A   1   0   0
## 3:     B   0   1   0
## 4:     B   0   1   0
## 5:     C   0   0   1
## 6:     C   0   0   1</code></pre>
<p>Заметьте, что такое кодирование избыточно. Если мы знаем, что диет 3, а данная диета - это не диета В и не диета С, то это диета А. Значит, одна из созданных нами колонок - “лишняя”:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">diet[, isA <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]</code></pre></div>
<p>Используем новую колонки для линейной регрессии и сравним результаты:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(<span class="kw">lm</span>(weight.loss <span class="op">~</span><span class="st"> </span>isB <span class="op">+</span><span class="st"> </span>isC, diet))</code></pre></div>
<pre><code>## 
## Call:
## lm(formula = weight.loss ~ isB + isC, data = diet)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -5.7000 -1.6519 -0.1759  1.4420  5.3680 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  -3.3000     0.4840  -6.818 2.26e-09 ***
## isB           0.0320     0.6776   0.047  0.96246    
## isC          -1.8481     0.6652  -2.778  0.00694 ** 
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 2.371 on 73 degrees of freedom
## Multiple R-squared:  0.1285, Adjusted R-squared:  0.1047 
## F-statistic: 5.383 on 2 and 73 DF,  p-value: 0.006596</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(<span class="kw">lm</span>(weight.loss <span class="op">~</span><span class="st"> </span>Dietf, diet))</code></pre></div>
<pre><code>## 
## Call:
## lm(formula = weight.loss ~ Dietf, data = diet)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -5.7000 -1.6519 -0.1759  1.4420  5.3680 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  -3.3000     0.4840  -6.818 2.26e-09 ***
## DietfB        0.0320     0.6776   0.047  0.96246    
## DietfC       -1.8481     0.6652  -2.778  0.00694 ** 
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 2.371 on 73 degrees of freedom
## Multiple R-squared:  0.1285, Adjusted R-squared:  0.1047 
## F-statistic: 5.383 on 2 and 73 DF,  p-value: 0.006596</code></pre>
<p>То же самое!</p>
</div>
<div id="aov_a" class="section level3">
<h3><span class="header-section-number">2.1.6</span> Допущения ANOVA</h3>
<ol style="list-style-type: decimal">
<li><strong>Нормальность распределения ошибок:</strong></li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">hist</span>(<span class="kw">residuals</span>(aov_model))</code></pre></div>
<p><img src="sirius_advanced_files/figure-html/unnamed-chunk-49-1.png" width="672" /></p>
<p>Как мы видим, распределение не сильно далеко от нормального - этого вполне достаточно. ANOVA - это метод достаточно устойчивый к отклонениям от нормальности.</p>
<ol start="2" style="list-style-type: decimal">
<li><strong>Гомогенность дисперсий.</strong></li>
</ol>
<p>То есть их равенство. Можно посмотреть на распределение остатков:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">diet<span class="op">$</span>residuals &lt;-<span class="st"> </span><span class="kw">residuals</span>(aov_model)
<span class="kw">ggplot</span>(diet, <span class="kw">aes</span>(<span class="dt">x =</span> Dietf, <span class="dt">y =</span> residuals))<span class="op">+</span><span class="st"> </span><span class="kw">geom_jitter</span>(<span class="dt">width =</span> <span class="fl">0.1</span>, <span class="dt">alpha =</span> <span class="fl">0.5</span>)</code></pre></div>
<p><img src="sirius_advanced_files/figure-html/unnamed-chunk-50-1.png" width="672" /></p>
<p>Все выглядит неплохо: нет какой-то одной группы, у которой разброс сильно больше или меньше. Есть и более формальные способы проверить равенство дисперсий. Например, с помощью теста Ливиня (Levene’s test). Для того, чтобы его провести, мы воспользуемся новым пакетом <code>ez</code> (читать как “easy”). Этот пакет сильно упрощает проведение дисперсионного анализа, особенно для более сложных дизайнов.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;ez&quot;</span>)</code></pre></div>
<p>Синтаксис довольно простой: нужно указать, данные, зависимую переменную, переменную с ID, факторы. Необходимо прописать фактор в <code>between =</code> или <code>within =</code>. В данном случае - в <code>between =</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ez)</code></pre></div>
<pre><code>## Registered S3 methods overwritten by &#39;lme4&#39;:
##   method                          from
##   cooks.distance.influence.merMod car 
##   influence.merMod                car 
##   dfbeta.influence.merMod         car 
##   dfbetas.influence.merMod        car</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ez_model &lt;-<span class="st"> </span><span class="kw">ezANOVA</span>(<span class="dt">data =</span> diet,
        <span class="dt">dv=</span> weight.loss,
        <span class="dt">wid =</span> Person, 
        <span class="dt">between =</span> Dietf,
        <span class="dt">detailed =</span> T, 
        <span class="dt">return_aov =</span> T)</code></pre></div>
<pre><code>## Warning: You have removed one or more Ss from the analysis. Refactoring
## &quot;Person&quot; for ANOVA.</code></pre>
<pre><code>## Warning: Data is unbalanced (unequal N per group). Make sure you specified
## a well-considered value for the type argument to ezANOVA().</code></pre>
<pre><code>## Coefficient covariances computed by hccm()</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ez_model</code></pre></div>
<pre><code>## $ANOVA
##   Effect DFn DFd      SSn      SSd        F           p p&lt;.05       ges
## 1  Dietf   2  73 60.52701 410.4018 5.383104 0.006595853     * 0.1285269
## 
## $`Levene&#39;s Test for Homogeneity of Variance`
##   DFn DFd      SSn      SSd         F         p p&lt;.05
## 1   2  73 2.040419 160.8859 0.4629076 0.6312856      
## 
## $aov
## Call:
##    aov(formula = formula(aov_formula), data = data)
## 
## Terms:
##                    Dietf Residuals
## Sum of Squares   60.5270  410.4018
## Deg. of Freedom        2        73
## 
## Residual standard error: 2.371064
## Estimated effects may be unbalanced</code></pre>
<p>Если при проведении теста Ливиня мы получаем <em>p &lt; .05</em>, то мы отбрасываем нулевую гипотезу о равенстве дисперсий. В данном случае мы не можем ее отбросить и поэтому принимаем<a href="#fn5" class="footnoteRef" id="fnref5"><sup>5</sup></a></p>
<p>Полученный объект (если поставить <code>return_aov = T</code>) содержит еще и объект <code>aov()</code> - на случай, если у Вас есть функции, которые работают с этим классом:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">TukeyHSD</span>(ez_model<span class="op">$</span>aov)</code></pre></div>
<pre><code>##   Tukey multiple comparisons of means
##     95% family-wise confidence level
## 
## Fit: aov(formula = formula(aov_formula), data = data)
## 
## $Dietf
##          diff       lwr        upr     p adj
## B-A  0.032000 -1.589085  1.6530850 0.9987711
## C-A -1.848148 -3.439554 -0.2567422 0.0188047
## C-B -1.880148 -3.454614 -0.3056826 0.0152020</code></pre>
<ol start="3" style="list-style-type: decimal">
<li><strong>Примерно одинаковое количество испытуемых в разных группах.</strong> Здесь у нас все в порядке:</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">diet[,.N, by =<span class="st"> </span>Dietf]</code></pre></div>
<pre><code>##    Dietf  N
## 1:     A 24
## 2:     B 25
## 3:     C 27</code></pre>
<p>Небольшие различия в размерах групп - это ОК, тем более, что на практике такое очень часто случается: кого-то пришлось выкинуть из анализа, для какой-то строчки были потеряны данные и т.д. Однако больших различий в размерах групп стоит избегать. Самое плохое, когда группы различаются значительно по размеру (более чем в 2 раза) и стандартные отклонения отличаются значительно (более чем в 2 раза).</p>
</div>
<div id="fact_aov" class="section level3">
<h3><span class="header-section-number">2.1.7</span> Многофакторный дисперсионный анализ (Factorial ANOVA)</h3>
<p>На практике можно встретить One-Way ANOVA (однофакторную ANOVA) довольно редко. Обычно в исследованиях встречается многофакторный дисперсионный анализ, в котором проверяется влияние сразу нескольких факторов. В научных статьях это обозначается примерно так: “3х2 ANOVA”. Это означает, что был проведен двухфакторный дисперсионный анализ, причем в одном факторе было три уровня, во втором - два. В нашем случае это будут факторы “Диета” и “Пол”. Это означает, что у нас две гипотезы: о влиянии диеты на потерю веса и о влиянии пола на потерю веса. Кроме того, появляется гипотеза о взаимодействии факторов - то есть о том, что разные диеты по разному влияют на потерю веса для разных полов.</p>
<p>Взаимодействие двух факторов хорошо видно на графике с линиями: если две линии параллельны, то взаимодействия нет. Если они не параллельны (пересекаются, сходятся, расходятся), то взаимодействие есть.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">diet[, genderf<span class="op">:</span><span class="er">=</span><span class="kw">factor</span>(gender, <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;ж&quot;</span>, <span class="st">&quot;м&quot;</span>))]
sem &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="kw">sd</span>(x)<span class="op">/</span><span class="kw">sqrt</span>(<span class="kw">length</span>(x))
pivot &lt;-<span class="st"> </span>diet[,.(<span class="dt">meanloss =</span> <span class="kw">mean</span>(weight.loss), <span class="dt">se =</span> <span class="kw">sem</span>(weight.loss)), by =<span class="st"> </span>.(Dietf, genderf)]

<span class="kw">library</span>(ggplot2)
pd =<span class="st"> </span><span class="kw">position_dodge</span>(<span class="fl">0.05</span>)
<span class="kw">ggplot</span>(pivot, <span class="kw">aes</span>(<span class="dt">x =</span> Dietf, <span class="dt">y =</span> meanloss, <span class="dt">colour =</span> genderf))<span class="op">+</span>
<span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group =</span> genderf), <span class="dt">position =</span> pd)<span class="op">+</span>
<span class="kw">geom_pointrange</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> meanloss <span class="op">-</span><span class="st"> </span>se, <span class="dt">ymax =</span> meanloss <span class="op">+</span>se), <span class="dt">position =</span> pd)</code></pre></div>
<p><img src="sirius_advanced_files/figure-html/unnamed-chunk-55-1.png" width="672" /></p>
<p>Как видно по картинке, разница в эффективности диеты С по сравнению с другими видна только для женщин.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ezANOVA</span>(<span class="dt">data =</span> diet,
        <span class="dt">dv=</span> weight.loss,
        <span class="dt">wid =</span> Person, 
        <span class="dt">between =</span> .(Dietf, gender),
        <span class="dt">detailed =</span> T, 
        <span class="dt">return_aov =</span> T)</code></pre></div>
<pre><code>## Warning: You have removed one or more Ss from the analysis. Refactoring
## &quot;Person&quot; for ANOVA.</code></pre>
<pre><code>## Warning: &quot;gender&quot; will be treated as numeric.</code></pre>
<pre><code>## Warning: Data is unbalanced (unequal N per group). Make sure you specified
## a well-considered value for the type argument to ezANOVA().</code></pre>
<pre><code>## Coefficient covariances computed by hccm()</code></pre>
<pre><code>## Warning: At least one numeric between-Ss variable detected, therefore no
## assumption test will be returned.</code></pre>
<pre><code>## $ANOVA
##         Effect DFn DFd        SSn     SSd          F          p p&lt;.05
## 1        Dietf   2  70 60.4172197 376.329 5.61902602 0.00545568     *
## 2       gender   1  70  0.1686958 376.329 0.03137868 0.85990976      
## 3 Dietf:gender   2  70 33.9040683 376.329 3.15320438 0.04884228     *
##           ges
## 1 0.138334829
## 2 0.000448066
## 3 0.082645860
## 
## $aov
## Call:
##    aov(formula = formula(aov_formula), data = data)
## 
## Terms:
##                    Dietf   gender Dietf:gender Residuals
## Sum of Squares   60.5270   0.1687      33.9041  376.3290
## Deg. of Freedom        2        1            2        70
## 
## Residual standard error: 2.318648
## Estimated effects may be unbalanced</code></pre>
<p>Итак, теперь мы проверяем три гипотезы вместо одной. Действительно, взаимодействие диеты и пола оказалось значимым, как и ожидалось.</p>
</div>
<div id="rm_aov" class="section level3">
<h3><span class="header-section-number">2.1.8</span> Дисперсионный анализ с повторными измерениями (Repeated-measures ANOVA)</h3>
<p>Если обычный дисперсионный анализ - это аналог независимого т-теста для нескольких групп, то дисперсионный анализ с повторными измерениями - это аналог зависимого т-теста. В функции <code>ezANOVA()</code> для проведения дисперсионного анализа с повторными измерениями нужно просто поставить нужным параметром внутригрупповую переменную. Это означает, что в данном случае мы должны иметь данные в длинном формате, для чего мы воспользуемся функцией <code>melt()</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dietlong &lt;-<span class="st"> </span><span class="kw">melt</span>(diet,
<span class="dt">measure =</span> <span class="kw">c</span>(<span class="st">&quot;pre.weight&quot;</span>, <span class="st">&quot;weight6weeks&quot;</span>),
<span class="dt">variable =</span> <span class="st">&quot;time&quot;</span>,
<span class="dt">value =</span> <span class="st">&quot;weight&quot;</span>)</code></pre></div>
<pre><code>## Warning in melt.data.table(diet, measure = c(&quot;pre.weight&quot;,
## &quot;weight6weeks&quot;), : &#39;measure.vars&#39; [pre.weight, weight6weeks] are not all
## of the same type. By order of hierarchy, the molten data value column will
## be of type &#39;double&#39;. All measure variables not of type &#39;double&#39; will be
## coerced too. Check DETAILS in ?melt.data.table for more on coercion.</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dietlongC &lt;-<span class="st"> </span><span class="kw">droplevels</span>(dietlong[Dietf <span class="op">==</span><span class="st"> &quot;C&quot;</span>,])</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ezANOVA</span>(dietlongC,
        <span class="dt">dv =</span> weight, 
        <span class="dt">wid =</span> Person,
        <span class="dt">within =</span> time)</code></pre></div>
<pre><code>## $ANOVA
##   Effect DFn DFd        F            p p&lt;.05       ges
## 2   time   1  26 124.6949 2.030459e-11     * 0.0986036</code></pre>
</div>
<div id="mixed_aov" class="section level3">
<h3><span class="header-section-number">2.1.9</span> Смешанный дисперсионный анализ (Mixed between-within subjects ANOVA)</h3>
<p>Нам никто не мешает совмещать и внутригруппоые, и межгрупповые факторы вместе.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ezANOVA</span>(dietlong,
        <span class="dt">dv =</span> weight, 
        <span class="dt">wid =</span> Person,
        <span class="dt">within =</span> time,
        <span class="dt">between =</span> Dietf)</code></pre></div>
<pre><code>## Warning: You have removed one or more Ss from the analysis. Refactoring
## &quot;Person&quot; for ANOVA.</code></pre>
<pre><code>## Warning: Data is unbalanced (unequal N per group). Make sure you specified
## a well-considered value for the type argument to ezANOVA().</code></pre>
<pre><code>## $ANOVA
##       Effect DFn DFd           F            p p&lt;.05         ges
## 2      Dietf   2  73   0.8280758 4.409507e-01       0.021710057
## 3       time   1  73 210.5004045 3.346036e-23     * 0.059209996
## 4 Dietf:time   2  73   5.3831045 6.595853e-03     * 0.003208607</code></pre>
<p>Здесь нас интересует взаимодействие между факторами. Результаты, полученные для этой гипотезы, идентичны результатам по обычному дисперсионному анализу на разницу до и после - по сути это одно и то же.</p>
</div>
<div id="aov_sum" class="section level3">
<h3><span class="header-section-number">2.1.10</span> Заключение</h3>
<p>Мы разобрали много разных вариантов дисперсионного анализа. И это неудивительно - дисперсионный анализ является одним из самых распространенных статистических методов, в особенности в экспериментальных науках. При этом дисперсионный анализ можно представить как частный случай множественной линейной регрессии!</p>
<!--chapter:end:02-Week2Day2_aov.Rmd-->
</div>
</div>
</div>
<div id="d2_rmd" class="section level1">
<h1><span class="header-section-number">3</span> Неделя 2, День 2, продолжение</h1>
<div id="rmd" class="section level2">
<h2><span class="header-section-number">3.1</span> RMarkdown</h2>
<pre><code>![Если картинка не загрузилась, будет этот текст](https://d33wubrfki0l68.cloudfront.net/61d189fd9cdf955058415d3e1b28dd60e1bd7c9b/b739c/lesson-images/rmarkdownflow.png)</code></pre>
<div class="figure">
<img src="https://d33wubrfki0l68.cloudfront.net/61d189fd9cdf955058415d3e1b28dd60e1bd7c9b/b739c/lesson-images/rmarkdownflow.png" alt="Если картинка не загрузилась, будет этот текст" />
<p class="caption">Если картинка не загрузилась, будет этот текст</p>
</div>
<p>Вот так делать заголовки:</p>
<pre><code># R Markdown

## Что такое RMarkdown

## Чанки с кодом </code></pre>
<p>Это чанк с кодом. Он отделяется ``` с обоих сторон и {r}. Это означает, что внутри находится код на R, который должен быть выполнен:</p>
<p>``` {r}<br />
2+2<br />
```</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="dv">2</span><span class="op">+</span><span class="dv">2</span></code></pre></div>
<pre><code>## [1] 4</code></pre>
<div id="chunk" class="section level3">
<h3><span class="header-section-number">3.1.1</span> Настройки чанка</h3>
<p>У чанка с кодом есть набор настроек. Самый важные из них такие:</p>
<ul>
<li><p><em>echo</em>: будет ли показан сам код</p></li>
<li><p><em>message</em> и <em>warning</em>: будут ли показаны сообщения и предупреждения, всплывающие во время исполнения кода</p></li>
<li><p><em>eval</em>: будет ли испольняться код внутри чанка</p></li>
</ul>
</div>
<div id="chunks" class="section level3">
<h3><span class="header-section-number">3.1.2</span> Настройка нескольких чанков</h3>
<p>Все эти настройки можно настроить как для отдельных чанков, так и для все чанков сразу:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(<span class="dt">echo =</span> <span class="ot">TRUE</span>, <span class="dt">message =</span> <span class="ot">FALSE</span>, <span class="dt">warning =</span> <span class="ot">FALSE</span>)</code></pre></div>
</div>
<div id="python" class="section level3">
<h3><span class="header-section-number">3.1.3</span> Чанки с Python!</h3>
<p>Вместо {r} нужно написать {python}</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">x <span class="op">=</span> <span class="st">&#39;hello, python !&#39;</span>
<span class="bu">print</span> (x.split(<span class="st">&quot; &quot;</span>))</code></pre></div>
<pre><code>## [&#39;hello,&#39;, &#39;python&#39;, &#39;!&#39;]</code></pre>
</div>
<div id="inline" class="section level3">
<h3><span class="header-section-number">3.1.4</span> Код вне чанков (inline code)</h3>
<p>Число пи равно ` r pi `:</p>
<p><code>Число пи равно 3.1415927</code></p>
</div>
<div id="md" class="section level3">
<h3><span class="header-section-number">3.1.5</span> Синтаксис Markdown (без R)</h3>
<div id="md_high" class="section level4">
<h4><span class="header-section-number">3.1.5.1</span> Выделение текста</h4>
<pre><code>*Курсив* 
_Тоже курсив_
**Полужирный**
__Тоже полужирный__</code></pre>
<p><em>Курсив</em> <em>Тоже курсив</em> <strong>Полужирный</strong> <strong>Тоже полужирный</strong></p>
</div>
<div id="headers" class="section level4">
<h4><span class="header-section-number">3.1.5.2</span> Заголовки разных уровней</h4>
<pre><code>## Заголовки разных уровней

### Мне заголовок

#### И моему сыну тоже

##### И моему!

###### OK, boomer
</code></pre>
</div>
<div id="md_lists" class="section level4">
<h4><span class="header-section-number">3.1.5.3</span> Списки</h4>
<ul>
<li><p>Первый вариант списка выглядит так:</p></li>
<li>Можно и с подсписком</li>
<li><p>Почему бы и нет?</p></li>
</ul>
<ol style="list-style-type: decimal">
<li>Кому нужен порядок</li>
<li>Тот списки номерует</li>
</ol>
</div>
<div id="md_cite" class="section level4">
<h4><span class="header-section-number">3.1.5.4</span> Цитаты</h4>
<p>Цитата:</p>
<blockquote>
<p>Я устал<br />
Который год во мне живет нарвал</p>
</blockquote>
</div>
</div>
<div id="rmd_tables" class="section level3">
<h3><span class="header-section-number">3.1.6</span> Таблицы</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(data.table)
go &lt;-<span class="st"> </span><span class="kw">fread</span>(<span class="st">&quot;data/iGLAS for R course.csv&quot;</span>)
go[<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>]</code></pre></div>
<pre><code>##     StartDate   EndDate Status      IPAddress
## 1:  1/15/2017 1/16/2017      0   144.139.7.52
## 2:  1/27/2017 1/27/2017      0  31.54.151.215
## 3:  1/24/2017 1/24/2017      0   176.62.130.7
## 4: 01/10/2017 1/23/2017      0 86.161.181.218</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(knitr)
<span class="kw">kable</span>(go[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>])</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">StartDate</th>
<th align="left">EndDate</th>
<th align="right">Status</th>
<th align="left">IPAddress</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">1/15/2017</td>
<td align="left">1/16/2017</td>
<td align="right">0</td>
<td align="left">144.139.7.52</td>
</tr>
<tr class="even">
<td align="left">1/27/2017</td>
<td align="left">1/27/2017</td>
<td align="right">0</td>
<td align="left">31.54.151.215</td>
</tr>
<tr class="odd">
<td align="left">1/24/2017</td>
<td align="left">1/24/2017</td>
<td align="right">0</td>
<td align="left">176.62.130.7</td>
</tr>
<tr class="even">
<td align="left">01/10/2017</td>
<td align="left">1/23/2017</td>
<td align="right">0</td>
<td align="left">86.161.181.218</td>
</tr>
<tr class="odd">
<td align="left">12/11/2016</td>
<td align="left">12/11/2016</td>
<td align="right">0</td>
<td align="left">31.211.8.249</td>
</tr>
</tbody>
</table>
<div id="dynamic_tables" class="section level4">
<h4><span class="header-section-number">3.1.6.1</span> Динамические таблицы</h4>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(DT)
<span class="kw">datatable</span>(go[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">5</span>])</code></pre></div>
<div id="htmlwidget-a4a4622165b5d7f4b379" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-a4a4622165b5d7f4b379">{"x":{"filter":"none","data":[["1","2","3","4","5"],["1/15/2017","1/27/2017","1/24/2017","01/10/2017","12/11/2016"],["1/16/2017","1/27/2017","1/24/2017","1/23/2017","12/11/2016"],[0,0,0,0,0],["144.139.7.52","31.54.151.215","176.62.130.7","86.161.181.218","31.211.8.249"],[100,6,67,6,100]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>StartDate<\/th>\n      <th>EndDate<\/th>\n      <th>Status<\/th>\n      <th>IPAddress<\/th>\n      <th>Progress<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[3,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="vis" class="section level3">
<h3><span class="header-section-number">3.1.7</span> Визуализации</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ggplot2)
<span class="kw">library</span>(Stat2Data)
<span class="kw">library</span>(data.table)
<span class="kw">data</span>(<span class="st">&quot;Backpack&quot;</span>)
back &lt;-<span class="st"> </span><span class="kw">as.data.table</span>(Backpack)

ggplot_scatter &lt;-<span class="st"> </span><span class="kw">ggplot</span>(back, <span class="kw">aes</span>(<span class="dt">x =</span> BodyWeight, <span class="dt">y =</span> BackpackWeight))<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">colour =</span> Sex), <span class="dt">alpha =</span> <span class="fl">0.5</span>, <span class="dt">size =</span> <span class="dv">2</span>)
ggplot_scatter</code></pre></div>
<p><img src="sirius_advanced_files/figure-html/unnamed-chunk-64-1.png" width="672" /></p>
</div>
<div id="din_vis" class="section level3">
<h3><span class="header-section-number">3.1.8</span> Динамические визуализации в plotly</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(plotly)
<span class="kw">ggplotly</span>(ggplot_scatter)</code></pre></div>
<div id="htmlwidget-b38458b3e85126882a06" style="width:672px;height:480px;" class="plotly html-widget"></div>
<script type="application/json" data-for="htmlwidget-b38458b3e85126882a06">{"x":{"data":[{"x":[125,120,180,185,130,120,135,125,145,105,125,117,205,140,165,145,120,135,165,145,140,143,145,135,130,165,140,115,128,150,150,116,145,144,130,140,125,150,140,127,150,125,125,144,105,125,130,120,175,145,115,110,130,135,128],"y":[9,10,8,4,5,2,8,12,13,6,10,14,15,5,6,10,15,9,14,17,14,8,8,13,10,15,10,5,6,5,10,21,13,17,10,9,13,10,8,12,14,5,14,25,2,8,15,10,25,24,5,10,19,13,9],"text":["Sex: Female<br />BodyWeight: 125<br />BackpackWeight:  9","Sex: Female<br />BodyWeight: 120<br />BackpackWeight: 10","Sex: Female<br />BodyWeight: 180<br />BackpackWeight:  8","Sex: Female<br />BodyWeight: 185<br />BackpackWeight:  4","Sex: Female<br />BodyWeight: 130<br />BackpackWeight:  5","Sex: Female<br />BodyWeight: 120<br />BackpackWeight:  2","Sex: Female<br />BodyWeight: 135<br />BackpackWeight:  8","Sex: Female<br />BodyWeight: 125<br />BackpackWeight: 12","Sex: Female<br />BodyWeight: 145<br />BackpackWeight: 13","Sex: Female<br />BodyWeight: 105<br />BackpackWeight:  6","Sex: Female<br />BodyWeight: 125<br />BackpackWeight: 10","Sex: Female<br />BodyWeight: 117<br />BackpackWeight: 14","Sex: Female<br />BodyWeight: 205<br />BackpackWeight: 15","Sex: Female<br />BodyWeight: 140<br />BackpackWeight:  5","Sex: Female<br />BodyWeight: 165<br />BackpackWeight:  6","Sex: Female<br />BodyWeight: 145<br />BackpackWeight: 10","Sex: Female<br />BodyWeight: 120<br />BackpackWeight: 15","Sex: Female<br />BodyWeight: 135<br />BackpackWeight:  9","Sex: Female<br />BodyWeight: 165<br />BackpackWeight: 14","Sex: Female<br />BodyWeight: 145<br />BackpackWeight: 17","Sex: Female<br />BodyWeight: 140<br />BackpackWeight: 14","Sex: Female<br />BodyWeight: 143<br />BackpackWeight:  8","Sex: Female<br />BodyWeight: 145<br />BackpackWeight:  8","Sex: Female<br />BodyWeight: 135<br />BackpackWeight: 13","Sex: Female<br />BodyWeight: 130<br />BackpackWeight: 10","Sex: Female<br />BodyWeight: 165<br />BackpackWeight: 15","Sex: Female<br />BodyWeight: 140<br />BackpackWeight: 10","Sex: Female<br />BodyWeight: 115<br />BackpackWeight:  5","Sex: Female<br />BodyWeight: 128<br />BackpackWeight:  6","Sex: Female<br />BodyWeight: 150<br />BackpackWeight:  5","Sex: Female<br />BodyWeight: 150<br />BackpackWeight: 10","Sex: Female<br />BodyWeight: 116<br />BackpackWeight: 21","Sex: Female<br />BodyWeight: 145<br />BackpackWeight: 13","Sex: Female<br />BodyWeight: 144<br />BackpackWeight: 17","Sex: Female<br />BodyWeight: 130<br />BackpackWeight: 10","Sex: Female<br />BodyWeight: 140<br />BackpackWeight:  9","Sex: Female<br />BodyWeight: 125<br />BackpackWeight: 13","Sex: Female<br />BodyWeight: 150<br />BackpackWeight: 10","Sex: Female<br />BodyWeight: 140<br />BackpackWeight:  8","Sex: Female<br />BodyWeight: 127<br />BackpackWeight: 12","Sex: Female<br />BodyWeight: 150<br />BackpackWeight: 14","Sex: Female<br />BodyWeight: 125<br />BackpackWeight:  5","Sex: Female<br />BodyWeight: 125<br />BackpackWeight: 14","Sex: Female<br />BodyWeight: 144<br />BackpackWeight: 25","Sex: Female<br />BodyWeight: 105<br />BackpackWeight:  2","Sex: Female<br />BodyWeight: 125<br />BackpackWeight:  8","Sex: Female<br />BodyWeight: 130<br />BackpackWeight: 15","Sex: Female<br />BodyWeight: 120<br />BackpackWeight: 10","Sex: Female<br />BodyWeight: 175<br />BackpackWeight: 25","Sex: Female<br />BodyWeight: 145<br />BackpackWeight: 24","Sex: Female<br />BodyWeight: 115<br />BackpackWeight:  5","Sex: Female<br />BodyWeight: 110<br />BackpackWeight: 10","Sex: Female<br />BodyWeight: 130<br />BackpackWeight: 19","Sex: Female<br />BodyWeight: 135<br />BackpackWeight: 13","Sex: Female<br />BodyWeight: 128<br />BackpackWeight:  9"],"type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgba(248,118,109,1)","opacity":0.5,"size":7.55905511811024,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(248,118,109,1)"}},"hoveron":"points","name":"Female","legendgroup":"Female","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[195,155,240,170,160,170,170,175,165,170,145,270,160,150,190,145,160,155,220,170,155,190,185,175,180,220,195,125,180,180,150,160,135,170,175,150,160,168,155,210,165,195,130,140,170],"y":[8,6,5,8,21,11,11,11,5,20,11,10,18,8,25,7,11,4,13,19,8,16,5,10,11,12,35,2,6,20,14,8,14,20,16,18,18,11,13,15,14,6,11,9,15],"text":["Sex: Male<br />BodyWeight: 195<br />BackpackWeight:  8","Sex: Male<br />BodyWeight: 155<br />BackpackWeight:  6","Sex: Male<br />BodyWeight: 240<br />BackpackWeight:  5","Sex: Male<br />BodyWeight: 170<br />BackpackWeight:  8","Sex: Male<br />BodyWeight: 160<br />BackpackWeight: 21","Sex: Male<br />BodyWeight: 170<br />BackpackWeight: 11","Sex: Male<br />BodyWeight: 170<br />BackpackWeight: 11","Sex: Male<br />BodyWeight: 175<br />BackpackWeight: 11","Sex: Male<br />BodyWeight: 165<br />BackpackWeight:  5","Sex: Male<br />BodyWeight: 170<br />BackpackWeight: 20","Sex: Male<br />BodyWeight: 145<br />BackpackWeight: 11","Sex: Male<br />BodyWeight: 270<br />BackpackWeight: 10","Sex: Male<br />BodyWeight: 160<br />BackpackWeight: 18","Sex: Male<br />BodyWeight: 150<br />BackpackWeight:  8","Sex: Male<br />BodyWeight: 190<br />BackpackWeight: 25","Sex: Male<br />BodyWeight: 145<br />BackpackWeight:  7","Sex: Male<br />BodyWeight: 160<br />BackpackWeight: 11","Sex: Male<br />BodyWeight: 155<br />BackpackWeight:  4","Sex: Male<br />BodyWeight: 220<br />BackpackWeight: 13","Sex: Male<br />BodyWeight: 170<br />BackpackWeight: 19","Sex: Male<br />BodyWeight: 155<br />BackpackWeight:  8","Sex: Male<br />BodyWeight: 190<br />BackpackWeight: 16","Sex: Male<br />BodyWeight: 185<br />BackpackWeight:  5","Sex: Male<br />BodyWeight: 175<br />BackpackWeight: 10","Sex: Male<br />BodyWeight: 180<br />BackpackWeight: 11","Sex: Male<br />BodyWeight: 220<br />BackpackWeight: 12","Sex: Male<br />BodyWeight: 195<br />BackpackWeight: 35","Sex: Male<br />BodyWeight: 125<br />BackpackWeight:  2","Sex: Male<br />BodyWeight: 180<br />BackpackWeight:  6","Sex: Male<br />BodyWeight: 180<br />BackpackWeight: 20","Sex: Male<br />BodyWeight: 150<br />BackpackWeight: 14","Sex: Male<br />BodyWeight: 160<br />BackpackWeight:  8","Sex: Male<br />BodyWeight: 135<br />BackpackWeight: 14","Sex: Male<br />BodyWeight: 170<br />BackpackWeight: 20","Sex: Male<br />BodyWeight: 175<br />BackpackWeight: 16","Sex: Male<br />BodyWeight: 150<br />BackpackWeight: 18","Sex: Male<br />BodyWeight: 160<br />BackpackWeight: 18","Sex: Male<br />BodyWeight: 168<br />BackpackWeight: 11","Sex: Male<br />BodyWeight: 155<br />BackpackWeight: 13","Sex: Male<br />BodyWeight: 210<br />BackpackWeight: 15","Sex: Male<br />BodyWeight: 165<br />BackpackWeight: 14","Sex: Male<br />BodyWeight: 195<br />BackpackWeight:  6","Sex: Male<br />BodyWeight: 130<br />BackpackWeight: 11","Sex: Male<br />BodyWeight: 140<br />BackpackWeight:  9","Sex: Male<br />BodyWeight: 170<br />BackpackWeight: 15"],"type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgba(0,191,196,1)","opacity":0.5,"size":7.55905511811024,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(0,191,196,1)"}},"hoveron":"points","name":"Male","legendgroup":"Male","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null}],"layout":{"margin":{"t":26.2283105022831,"r":7.30593607305936,"b":40.1826484018265,"l":37.2602739726027},"plot_bgcolor":"rgba(235,235,235,1)","paper_bgcolor":"rgba(255,255,255,1)","font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187},"xaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[96.75,278.25],"tickmode":"array","ticktext":["100","150","200","250"],"tickvals":[100,150,200,250],"categoryorder":"array","categoryarray":["100","150","200","250"],"nticks":null,"ticks":"outside","tickcolor":"rgba(51,51,51,1)","ticklen":3.65296803652968,"tickwidth":0.66417600664176,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.689497716895},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(255,255,255,1)","gridwidth":0.66417600664176,"zeroline":false,"anchor":"y","title":{"text":"BodyWeight","font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187}},"hoverformat":".2f"},"yaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[0.35,36.65],"tickmode":"array","ticktext":["10","20","30"],"tickvals":[10,20,30],"categoryorder":"array","categoryarray":["10","20","30"],"nticks":null,"ticks":"outside","tickcolor":"rgba(51,51,51,1)","ticklen":3.65296803652968,"tickwidth":0.66417600664176,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.689497716895},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(255,255,255,1)","gridwidth":0.66417600664176,"zeroline":false,"anchor":"x","title":{"text":"BackpackWeight","font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187}},"hoverformat":".2f"},"shapes":[{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","x0":0,"x1":1,"y0":0,"y1":1}],"showlegend":true,"legend":{"bgcolor":"rgba(255,255,255,1)","bordercolor":"transparent","borderwidth":1.88976377952756,"font":{"color":"rgba(0,0,0,1)","family":"","size":11.689497716895},"y":0.913385826771654},"annotations":[{"text":"Sex","x":1.02,"y":1,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187},"xref":"paper","yref":"paper","textangle":-0,"xanchor":"left","yanchor":"bottom","legendTitle":true}],"hovermode":"closest","barmode":"relative"},"config":{"doubleClick":"reset","showSendToCloud":false},"source":"A","attrs":{"12baf33552a3":{"colour":{},"x":{},"y":{},"type":"scatter"}},"cur_data":"12baf33552a3","visdat":{"12baf33552a3":["function (y) ","x"]},"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.2,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
</div>
<div id="html" class="section level3">
<h3><span class="header-section-number">3.1.9</span> Вставлять HTML</h3>
<iframe width="966" height="543" src="https://www.youtube.com/embed/hHW1oY26kxQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe>
<!--chapter:end:021-Week2Day2_RMD.Rmd-->
</div>
</div>
</div>
<div id="d2" class="section level1">
<h1><span class="header-section-number">4</span> Неделя 2, День 3</h1>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(data.table)</code></pre></div>
<div id="text" class="section level2">
<h2><span class="header-section-number">4.1</span> Введение в работу с текстом</h2>
<p>Работа с текстом - это отдельная и сложная задача. И у R все необходимые инструменты для этого!</p>
<p>Всю работу со строками (и текстом в целом) можно условно поделить на три уровня:</p>
<ol style="list-style-type: decimal">
<li>Базовые операции (до регулярных выражений)</li>
<li>Регулярные выражения</li>
<li>Natural language processing</li>
</ol>
<p>Мы начнем с базовых операций. В R есть много функций для работы со строками. В принципе, их достаточно для того, чтобы делать весьма сложные вещи, но как и часто это бывает с R, есть дополнительные пакеты, которые не столько расширяют функционал, сколько делают нашу жизнь удобнее.</p>
<p>Основных таких пакета два: <code>stringi</code> и <code>stringr</code>. Давайте сразу их установим:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;stringi&quot;</span>)
<span class="kw">install.packages</span>(<span class="st">&quot;stringr&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(stringi)
<span class="kw">library</span>(stringr)</code></pre></div>
<p><code>stringi</code> - это базовый пакет, который имеет очень широкий функционал. Функции из этого пакета начинаются на <code>stri_</code>. <code>stringr</code> - это пакет, который является “оберткой” пакета <code>stringi</code>. Функции пакета <code>stringr</code> начинаются на <code>str_</code>. <code>stringr</code> - более “минималистичный”: в нем меньше функций, чем в <code>stringi</code>. А еще <code>stringr</code> - это часть <code>tidyverse</code>, но этот пакет вполне можно использовать и без <code>tidyverse</code>, например, работая в <code>data.table</code>.</p>
<p>Тем не менее, для более-менее продвинутой работы с текстом придется выучить специальный язык - “регулярные выражения” (regular expressions или просто regex). Регулярные выражения реализованы на многих языках, в том числе в R. Но мы пока обойдемся наиболее простыми функциями, которые покроют большую часть того, что нам нужно уметь делать при работе с текстом.</p>
<p>Ну а после освоения базовых возможностей и регулярных выражений можно кидаться в естественную обработку языка и делать всякие топик моделлинги и прочие сентимент анализы. Впрочем, можно туда запрыгивать сразу, но обладая базовым инструментарием работы со строковыми данными, все эти штуки делать будет гораздо проще и эффективнее. Итак, поехали.</p>
</div>
<div id="text_base" class="section level2">
<h2><span class="header-section-number">4.2</span> Базовые операции с текстом</h2>
<p>Строковые данные (<code>character</code>) - один из базовых типов данных в R.</p>
<p>Для того, чтобы создать строковую переменную нужно использовать кавычки. Можно одинарные:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="st">&#39;Всем привет!&#39;</span></code></pre></div>
<pre><code>## [1] &quot;Всем привет!&quot;</code></pre>
<p>Можно двойные:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="st">&quot;Всем привет!&quot;</span></code></pre></div>
<pre><code>## [1] &quot;Всем привет!&quot;</code></pre>
<p>Разницы никакой! Главное использовать один вид кавычек для одного значения вектора. И еще: если использовать один вид кавычек для задания значения переменной, то другой вид кавычек можно использовать “внутри”:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="st">&quot;Всем &#39;привет&#39;!&quot;</span></code></pre></div>
<pre><code>## [1] &quot;Всем &#39;привет&#39;!&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="st">&#39;Всем &quot;привет&quot;!&#39;</span></code></pre></div>
<pre><code>## [1] &quot;Всем \&quot;привет\&quot;!&quot;</code></pre>
<p>Пустую строку можно сделать с помощью функции <code>character()</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">character</span>(<span class="dv">1</span>)</code></pre></div>
<pre><code>## [1] &quot;&quot;</code></pre>
<p>А вот это уже похоже на пассивную агрессию:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="st">&quot;С тобой все в порядке?&quot;</span></code></pre></div>
<pre><code>## [1] &quot;С тобой все в порядке?&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">character</span>(<span class="dv">5</span>)</code></pre></div>
<pre><code>## [1] &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot;</code></pre>
<p>Конечно, можно превращать другие переменные в строки:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">as.character</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)</code></pre></div>
<pre><code>##  [1] &quot;1&quot;  &quot;2&quot;  &quot;3&quot;  &quot;4&quot;  &quot;5&quot;  &quot;6&quot;  &quot;7&quot;  &quot;8&quot;  &quot;9&quot;  &quot;10&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">as.character</span>(<span class="ot">TRUE</span>)</code></pre></div>
<pre><code>## [1] &quot;TRUE&quot;</code></pre>
<div id="text_c" class="section level3">
<h3><span class="header-section-number">4.2.1</span> Соединение и разъединение строк</h3>
<p>Как соединить строки? Очевидным способом будет попробовать функцию <code>c()</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">c</span>(<span class="st">&quot;Всем&quot;</span>, <span class="st">&quot;Привет&quot;</span>)</code></pre></div>
<pre><code>## [1] &quot;Всем&quot;   &quot;Привет&quot;</code></pre>
<p>И вроде бы это то, что нужно, но если посмотрите внимательно, то увидите, что оба слова выделены в кавычки. Короче говоря, мы просто соединили два значения в вектор (ну или два вектора длиной один в вектор длиной два).</p>
<p>Для того, чтобы соединить строковые значения, есть функция <code>paste()</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">paste</span>(<span class="st">&quot;Всем&quot;</span>, <span class="st">&quot;Привет&quot;</span>)</code></pre></div>
<pre><code>## [1] &quot;Всем Привет&quot;</code></pre>
<p>Вот это то, что нужно!</p>
<p>У функции <code>paste()</code> есть параметр <code>sep =</code> - разделитель, который по умолчанию является пробелом - <code>sep = &quot; &quot;</code>, но его можно поменять на любой другой, например:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">paste</span>(<span class="st">&quot;Всем&quot;</span>, <span class="st">&quot;Привет&quot;</span>, <span class="dt">sep =</span> <span class="st">&quot;хэй!&quot;</span>)</code></pre></div>
<pre><code>## [1] &quot;Всемхэй!Привет&quot;</code></pre>
<p>Обычно, правда, нам не нужно придумывать такие ухищренные разделители, а нужно, чтобы его вообще не было:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">paste</span>(<span class="st">&quot;Всем&quot;</span>, <span class="st">&quot;Привет&quot;</span>, <span class="dt">sep =</span> <span class="st">&quot;&quot;</span>)</code></pre></div>
<pre><code>## [1] &quot;ВсемПривет&quot;</code></pre>
<p>Есть функция <code>paste0()</code>, которая является оберткой над обычным <code>paste()</code>, но уже с <code>sep = &quot;&quot;</code> по умолчанию:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">paste0</span>(<span class="st">&quot;Всем&quot;</span>, <span class="st">&quot;Привет&quot;</span>)</code></pre></div>
<pre><code>## [1] &quot;ВсемПривет&quot;</code></pre>
<p>Теперь попробуем создать простой <code>data.table</code> с буквами. Буквы латиницы зашиты в R как константы:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">let &lt;-<span class="st"> </span><span class="kw">data.table</span>(<span class="dt">small =</span> letters[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>], <span class="dt">big =</span> LETTERS[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>])
let</code></pre></div>
<pre><code>##     small big
##  1:     a   A
##  2:     b   B
##  3:     c   C
##  4:     d   D
##  5:     e   E
##  6:     f   F
##  7:     g   G
##  8:     h   H
##  9:     i   I
## 10:     j   J</code></pre>
<p>Давайте теперь попробуем создать колонку <code>both</code>, где объединим обе колонки с помощью какого-нибудь разделителя:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">let[, both <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">paste</span>(small, big, <span class="dt">sep =</span> <span class="st">&quot;_&quot;</span>)]
let</code></pre></div>
<pre><code>##     small big both
##  1:     a   A  a_A
##  2:     b   B  b_B
##  3:     c   C  c_C
##  4:     d   D  d_D
##  5:     e   E  e_E
##  6:     f   F  f_F
##  7:     g   G  g_G
##  8:     h   H  h_H
##  9:     i   I  i_I
## 10:     j   J  j_J</code></pre>
<p>Ага! Если немного присмотреться, то можно заметить, что функция <code>paste()</code> “склеивает” несколько векторов и выдает на выходе вектор такой же длины. А вот чтобы соединить значения одного вектора в одно значение, нужно воспользоваться параметром <code>collapse =</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">let[, <span class="kw">paste</span>(small, big, <span class="dt">sep =</span> <span class="st">&quot;+&quot;</span>, <span class="dt">collapse =</span> <span class="st">&quot; -&gt; &quot;</span>)]</code></pre></div>
<pre><code>## [1] &quot;a+A -&gt; b+B -&gt; c+C -&gt; d+D -&gt; e+E -&gt; f+F -&gt; g+G -&gt; h+H -&gt; i+I -&gt; j+J&quot;</code></pre>
<p>Есть и более продвинутый способ соединения строк, который происходит еще из C и очень популярен в Python. Для этого есть функция <code>sprintf()</code>. Вот пример того, как это работает:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sprintf</span>(<span class="st">&quot;Добро пожаловать в %s, на дворе %i год&quot;</span>, <span class="st">&quot;СИРИУС&quot;</span>, <span class="kw">year</span>(<span class="kw">Sys.Date</span>()))</code></pre></div>
<pre><code>## [1] &quot;Добро пожаловать в СИРИУС, на дворе 2020 год&quot;</code></pre>
<p>Это может быть удобно, если, например, Вы хотите в большую строчку вставить какую-то информацию из переменных.</p>
<p>Ну и наконец, самый продвинутый способ соединять строчки - это пакет <code>glue</code>. О да, для того, чтобы делать простые вещи очень просто нужно осваивать целый пакет! Но не беспокойтесь, у этого пакета очень интуитивно понятный синтаксис, который удобнее (на мой взгляд), чем <code>sprintf()</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;glue&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(glue)
let[, <span class="kw">glue</span>(<span class="st">&quot;{1:.N} буква латинского алфавита: {let$big}(заглавная) - {let$small}(строчная)&quot;</span>)]</code></pre></div>
<pre><code>## 1 буква латинского алфавита: A(заглавная) - a(строчная)
## 2 буква латинского алфавита: B(заглавная) - b(строчная)
## 3 буква латинского алфавита: C(заглавная) - c(строчная)
## 4 буква латинского алфавита: D(заглавная) - d(строчная)
## 5 буква латинского алфавита: E(заглавная) - e(строчная)
## 6 буква латинского алфавита: F(заглавная) - f(строчная)
## 7 буква латинского алфавита: G(заглавная) - g(строчная)
## 8 буква латинского алфавита: H(заглавная) - h(строчная)
## 9 буква латинского алфавита: I(заглавная) - i(строчная)
## 10 буква латинского алфавита: J(заглавная) - j(строчная)</code></pre>
<p>Теперь осталось научиться разъединять строковые значения. Для этого в пакете <code>data.table</code> есть функция <code>tstrsplit()</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">let[, <span class="kw">tstrsplit</span>(both, <span class="st">&quot;_&quot;</span>)]</code></pre></div>
<pre><code>##     V1 V2
##  1:  a  A
##  2:  b  B
##  3:  c  C
##  4:  d  D
##  5:  e  E
##  6:  f  F
##  7:  g  G
##  8:  h  H
##  9:  i  I
## 10:  j  J</code></pre>
</div>
<div id="text_len" class="section level3">
<h3><span class="header-section-number">4.2.2</span> Подсчет длины строк</h3>
<p>Чтобы посчитать количество знаков, можно воспользоваться функцией <code>nchar()</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">nchar</span>(<span class="kw">c</span>(<span class="st">&quot;Всем&quot;</span>, <span class="st">&quot;привет&quot;</span>))</code></pre></div>
<pre><code>## [1] 4 6</code></pre>
<p>В качестве самостоятельного задания загрузите датасет со всеми текстами песен Дэвида Боуи, взятых с сайта [Genius.com]:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">b &lt;-<span class="st"> </span><span class="kw">fread</span>(<span class="st">&quot;data/bowie2.csv&quot;</span>)
b</code></pre></div>
<pre><code>##      song_id                                song_name
##   1: 4193889                                     1917
##   2:  338950                                     1984
##   3: 1181295                                1984/Dodo
##   4: 4131335                         1984 (Live 1974)
##   5: 4178509                          1984 (Live &#39;74)
##  ---                                                 
## 657: 4178274               Ziggy Stardust (Live 1972)
## 658: 4133052               Ziggy Stardust (Live 1973)
## 659: 4131908               Ziggy Stardust (Live 1978)
## 660: 2002305       Ziggy Stardust (Live &#39;73) [Stereo]
## 661: 4128663 Ziggy Stardust (Live, Glastonbury, 2000)
##                                                                 song_lyrics_url
##   1:                                 https://genius.com/David-bowie-1917-lyrics
##   2:                                 https://genius.com/David-bowie-1984-lyrics
##   3:                            https://genius.com/David-bowie-1984-dodo-lyrics
##   4:                       https://genius.com/David-bowie-1984-live-1974-lyrics
##   5:                         https://genius.com/David-bowie-1984-live-74-lyrics
##  ---                                                                           
## 657:             https://genius.com/David-bowie-ziggy-stardust-live-1972-lyrics
## 658:             https://genius.com/David-bowie-ziggy-stardust-live-1973-lyrics
## 659:             https://genius.com/David-bowie-ziggy-stardust-live-1978-lyrics
## 660:        https://genius.com/David-bowie-ziggy-stardust-live-73-stereo-lyrics
## 661: https://genius.com/David-bowie-ziggy-stardust-live-glastonbury-2000-lyrics
##      annotation_count artist_id artist_name
##   1:                1      9534 David Bowie
##   2:               11      9534 David Bowie
##   3:                6      9534 David Bowie
##   4:                0      9534 David Bowie
##   5:                0      9534 David Bowie
##  ---                                       
## 657:                0      9534 David Bowie
## 658:                0      9534 David Bowie
## 659:                0      9534 David Bowie
## 660:                1      9534 David Bowie
## 661:                0      9534 David Bowie
##                                  artist_url
##   1: https://genius.com/artists/David-bowie
##   2: https://genius.com/artists/David-bowie
##   3: https://genius.com/artists/David-bowie
##   4: https://genius.com/artists/David-bowie
##   5: https://genius.com/artists/David-bowie
##  ---                                       
## 657: https://genius.com/artists/David-bowie
## 658: https://genius.com/artists/David-bowie
## 659: https://genius.com/artists/David-bowie
## 660: https://genius.com/artists/David-bowie
## 661: https://genius.com/artists/David-bowie
##                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    lyrics
##   1:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
##   2:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            Someday they won&#39;t let you, now you must agree The times they are a-telling and the changing isn&#39;t free You&#39;ve read it in the tea leaves, and the tracks are on TV Beware the savage jaw of 1984 They&#39;ll split your pretty cranium, and fill it full of air And tell that you&#39;re eighty, but brother, you won&#39;t care You&#39;ll be shooting up on anything, tomorrow&#39;s neverthere Beware the savage jaw of 1984 Come see, come see, remember me? We played out an all night movie role You said it would last, but I guess we enrolled In 1984 (who could ask for more) 1984 (who could ask for mor-or-or-or-ore) (Mor-or-or-or-ore) I&#39;m looking for a vehicle, I&#39;m looking for a ride I&#39;m looking for a party, I&#39;m looking for a side I&#39;m looking for the treason that I knew in &#39;65 Beware the savage jaw of 1984 Come see, come see, remember me? We played out an all night movie role You said it would last, but I guess we enrolled In 1984 (who could ask for more) 1984 (who could ask for mor-or-or-or-ore) (Mor-or-or-or-ore) 1984
##   3: Someday they won&#39;t let you, now you must agree The times they are a-telling, and the changing isn&#39;t free You&#39;ve read it in the tea leaves, the tracks are on tv Beware the savage jaw Of 1984 They&#39;ll break your pretty cranium, and fill it full of air And tell you that you&#39;re eighty, but lover you won&#39;t care You&#39;ll be shooting up this huge world, like tomorrow&#39;s wasn&#39;t there Beware the savage jaw Of 1984 (come see, come see, remember me? ) We played out an all night movie role You said it would last, but I guess we&#39;ve grown In 1984 (who could ask for more) 1984 (who could ask for more) Now we can talk in confidence Did you guess that we&#39;ve been done wrong Lies jumped the queue to be first in line Such a shameless design He thinks he&#39;s well screened from the man at the top It&#39;s a shame that his children disagree They cooly decide to sell him down the line Daddy&#39;s brainwashing time He&#39;s a do do, no no didn&#39;t hear it from me He&#39;s a do do, no no didn&#39;t hear it from me She doesn&#39;t recall her blessed childhood out of yore When a unit was a figure not a she When lovers chose each other seems the perk&#39;s are due Another memo to screw She&#39;s a do do, no no didn&#39;t hear it from me She&#39;s a do do, no no didn&#39;t hear it from me Can you wipe your nose my child without them slotting in your file a photograph Will you sleep in fear tonight wake to find the scorching light of neighbour jim Come to, turn you in But the do do, no no, didn&#39;t hear it from me Another do do, no no, didn&#39;t hear it from me Another do do, no no, didn&#39;t hear it from me Another do do, no no, didn&#39;t hear from me Come see, come see, remember me? We played out an all night movie role You said it would last, but I guess we enrolled In 1984 (who could ask for more) 1984 (who could ask for mor-or-or-or-ore) (mor-or-or-or-ore) 198 4 1984 1984 (mor-or-or-or-ore) 1984 1984 (mor-or-or-or-ore) 1984 1984 (mor-or-or-or-ore)
##   4:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          Someday they won&#39;t let you So now you must agree The times they are a-telling And the changing isn&#39;t free You&#39;ve read it in the tea leaves, and the tracks are on TV Beware the savage jaw of 1984 They&#39;ll split your pretty cranium, and fill it full of air And tell that you&#39;re eighty, but brother, you won&#39;t care You&#39;ll be shooting up on anything, tomorrow&#39;s never there Beware the savage jaw Of 1984 (Come see, come see, remember me?) We played out an all night movie role You said it would last, but I guess we enrolled In 1984 (Who could ask for more?) 1984 (Who could ask for mor-or-or-or-ore?) (Mor-or-or-or-ore) I&#39;m looking for a vehicle, I&#39;m looking for a ride I&#39;m looking for a party, I&#39;m looking for a side I&#39;m looking for the reason that I knew in &#39;65 Beware the savage jaw of 1984 (Come see, come see, remember me?) We played out an all night movie role You said it would last, but I guess we enrolled In 1984 (Who could ask for more?) 1984 (Who could ask for mor-or-or-or-ore?) (Mor-or-or-or-ore) 1984 (Who could ask for more?) 1984 (Who could ask for more?) 1984 (Who could ask for more?)
##   5:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Someday they won&#39;t let you So now you must agree The times they are a-telling And the changing isn&#39;t free You&#39;ve read it in the tea leaves, and the tracks are on TV Beware the savage jaw of 1984 They&#39;ll split your pretty cranium, and fill it full of air And tell that you&#39;re eighty, but brother, you won&#39;t care You&#39;ll be shooting up on anything, tomorrow&#39;s neverthere Beware the savage jaw of 1984 Come see, come see, remember me? We played out an all night movie role You said it would last, but I guess we enrolled In 1984 (Who could ask for more?) 1984 (Who could ask for...) (Mor-or-or-or-ore) I&#39;m looking for a vehicle, I&#39;m looking for a ride I&#39;m looking for a party, I&#39;m looking for a side I&#39;m looking for the reason that I knew in &#39;65 Beware the savage jaw of 1984 Come see, come see, remember me? We played out an all night movie role You said it would last, but I guess we enrolled In 1984 (Who could ask for more?) 1984 (Who could ask for mor-or-or-or-ore?) (Mor-or-or-or-ore) 1984 (Who could ask for mor-or-or-or-ore?) 1984 (Who could ask for mor-or-or-or-ore?) 1984 (Who could ask for mor-or-or-or-ore?) 1984 (Who could ask for more?)
##  ---                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
## 657:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            Ooh yeah Uh! Now Ziggy played guitar Jamming good with Weird and Gilly And The Spiders from Mars And he played it left hand But he made it too far Became the special man Then we were Ziggy&#39;s Band Now Ziggy really sang Screwed up eyes and screwed down hairdo Like some cat from Japan Oh he could kill ’em by smiling He could leave &#39;em to hang He came on so loaded man Well hung, snow white tan So where were the spiders While the fly tried to break our balls? Just the beer light to guide us So we bitched about his fans And should we crush his sweet hands? Ziggy played for time Jiving us that we were Voodoo The kids was just crass He was the nazz With God-given ass He took it all too far But boy could he play guitar Making love with his ego Ziggy sucked up into his mind, ah Like a leper messiah When the kids had killed a man I had to break up the band Oh yeah Now Ziggy played guitar
## 658:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     Oh yeah Ah Now Ziggy played guitar Jamming good with Weird and Gilly And The Spiders from Mars Well he played it left hand But made it too far Became the special man Then we were Ziggy&#39;s Band Ziggy really sang Screwed up eyes and screwed down hairdo Like some cat from Japan Oh he could lick &#39;em by smiling He could leave &#39;em to hang Well he came on so loaded man Well hung, snow white tan So where were the spiders While the fly tried to break our balls? Just the beer light to guide us So we bitched about his fans And should we crush his sweet hands? Oh yeah! Ziggy played for time Jiving us that we were Voodoo The kids was just crass He was the nazz With God-given ass But he took it all too far But boy could he play guitar Making love with his ego (Oh, yeah) Ziggy sucked up into his mind (Ah) Like a leper messiah When the kids had killed a man I had to break up the band Oh yeah Oooh Ohh-hoo-hoo Now Ziggy played guitar
## 659:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          Oh yeah Ziggy played guitar Jamming good with Weird and Gilly And The Spiders from Mars He played it left hand But made it too far Became the special man Then we were Ziggy&#39;s Band Ziggy really sang Screwed up eyes and screwed down hairdo Like some cat from Japan Oh he could lick &#39;em by smiling He could leave &#39;em to hang He came on so loaded man Well hung, snow white tan So where were the spiders While the fly tried to break our balls? Just the beer light to guide us So we bitched about his fans And should we crush his sweet hands? Oh yeah Ziggy played for time Jiving us that we were Voodoo The kids was just crass He was the naz With God-given ass Well he took it all too far But boy could he play guitar Making love with his ego Ziggy sucked up into his mind Like some leper messiah When the kids had killed a man I had to break up the band Oh yeah Oh-ooh-hoo And Ziggy played guitar
## 660:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                Oh Oh, yeah Ziggy played guitar Jamming good with Weird and Gilly And the Spiders from Mars He played it left hand But made it too far Became the special man Then we were Ziggy&#39;s band Ziggy really sang Screwed-up eyes and screwed-down hairdo Like some cat from Japan He could lick &#39;em by smiling He could leave &#39;em to hang They came on so loaded, man Well-hung and snow-white tan So where were the spiders While the fly tried to break our balls? Just the beer light to guide us So we bitched about his fans And should we crush his sweet hands? Oh Ziggy played for time Jiving us that we were voodoo The kids were just crass He was the nazz With God-given ass He took it all too far But, boy, could he play guitar Making love with his ego Ziggy sucked up into his mind, ah Like a leper messiah When the kids had killed the man I had to break up the band Oh, yeah Ooh Ziggy played guitar
## 661:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Oh yeah Now Ziggy played guitar Jamming good with Weird and Gilly And the Spiders from Mars He played it left hand But he made it too far Became the special man Then we were Ziggy&#39;s Band Ziggy really sang Screwed up eyes and screwed down hairdo Like some cat from Japan He could kill &#39;em by smiling He could leave &#39;em to hang Came on so loaded man Well hung, snow white tan So where were the spiders While the fly tried to break our balls? Just the beer light to guide us So we bitched about his fans And should we crush his sweet hands? Oh yeah Oh Ziggy played for time Jiving us that we were Voodoo The kids was just crass He was the naz With God-given ass He took it all too far But boy could he play guitar Making love with his ego Ziggy sucked up into his mind Like a leper messiah When the kids had killed a man I had to break up the band Oh yeah Oooh Oh hohoo Ziggy played guitar</code></pre>
<p>Текст песен находится в колонке <code>lyrics</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">b[, n_letters <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">nchar</span>(lyrics)]
b[<span class="kw">which.max</span>(n_letters),]</code></pre></div>
<pre><code>##    song_id
## 1: 3407882
##                                                                                                       song_name
## 1: The diary of Nathan Adler or the art-ritual murder of Baby Grace Blue: A non-linear Gothic Drama Hyper-cycle
##                                                                                                                                         song_lyrics_url
## 1: https://genius.com/David-bowie-the-diary-of-nathan-adler-or-the-art-ritual-murder-of-baby-grace-blue-a-non-linear-gothic-drama-hyper-cycle-annotated
##    annotation_count artist_id artist_name
## 1:                0      9534 David Bowie
##                                artist_url
## 1: https://genius.com/artists/David-bowie
##                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   lyrics
## 1: It was precisely 5.47am on the morning of Friday 31 of December 1999 that a dark spirited pluralist began the dissection of 14-year-old &quot;&quot;Baby Grace Blue&quot;&quot;. The arms of the victim were pin-cushioned with 16 hypodermic needles, pumping in four major preservatives, colouring agents, memory information transport fluids and some kind of green stuff. From the last and 17th, all blood and liquid was extracted. The stomach areas was carefully flapped open and the intestines removed, disentangled and re-knitted as it were, into a small net or web and hung between the pillars of the murder-location, the grand damp doorway of Oxford Town Museum of Modern Parts, New Jersey. The Limbs of Baby were then served from the torso. Each limb was implanted with a small, highly sophisticated, binary code translator which in turn was connected to small speakers attached to far ends of each limb. The self-contained mini amplifiers were then activated, amplifying the decoded memory  info-transport substances, revealing themselves as little clue haiku&#39;s, small verses detailing memories of other brutal acts, well documented by the ROMbloids. The limbs and their components were then hung upon the splayed web, slug-like prey of some unimaginable creature. The torso, by means of its bottom-most orifice, had been placed on a small support fastened to a marble base. It was shown to warring degrees of success depending upon where one stood from behind the web but in front of the Museum door itself, acting as both signifier and guardian to the act. It was definitely murder - but was it art? All this was to be the lead-up to the most provocative event in the whole sequence of serial-events that had started around November of that same year, plunging me into the most portentous chaos-abyss that a quiet lone hacker like myself could comprehend. My name is Nathan Adler, or Detective Professor Adler in my circuit. I&#39;m attached to the division of Art-Crime Inc., the recently instigated corporation funded by an endowment from the Arts Protectorate of London, it being felt that the investigation of art-crimes was in itself inseparable from other forms of expression and therefore worthy of support from this significant body. Nicolas Serota himself had deemed us, the small-fry of the division, worthy of an exhibit at last year&#39;s Biennale in Venice, three rooms of evidence and comparative study work which conclusively proved that the cow in Mark Tansey&#39;s &quot;&quot;The Innocent Bye Test&quot;&quot; could not differentiate between Paulus Potter&#39;s &quot;&quot;The Young Bull&quot;&quot; of 1647 (exactly 300 years before I was born, incidentally) and one of Monet&#39;s  grain stack paintings of the 1890&#39;s. The traditional art press deemed this extrapolation &quot;&quot;bullshit&quot;&quot; and removed itself to study the more formal ideas contained in Damien Hirst&#39;s &quot;&quot;Sheep In A Box&quot;&quot;. Art&#39;s a farmyard. It&#39;s my job to pick thru&#39; the manure heap looking for peppercorns. friday, december 31, 1999, 10.15 am As in any crime, my first position is to pursue the motive-gag. The recent spate, thru&#39; &#39;98-&#39;99, of concept-muggings pretty much had me pulling breath for an art-murder. It was a crime whose time was now. The precedents were all there. It had probably its beginnings in the &#39;70s with the Viennese castrationists and the blood-rituals of Nitsch. Public revulsion put the lid on that episode, but you can&#39;t keep a good down. Spurred on by Chris Burden&#39;s having himself shot by his collaborator in a gallery, tied up in a bag, thrown on a highway and then crucified upon the top of a Volkswagen, stories circulated thru&#39; the nasty-neon of N.Y. night that a young Korean artist was the self-declared patient of wee-hours surgery in cut and run operations at not-so-secret locations in the city. If you found out about it, you could go and watch this guy having bits and pieces removed under anaesthetic. A finger-joint one night, a limb another. By the dawning of the &#39;80s, rumour had it that he was down to a torso and one arm. He&#39;d asked to be left in a cave in the Catskills, fed every so often by his acolytes. He didn&#39;t do much after that. I guess he read a lot. Maybe wrote a whole bunch. I suppose you can never tell what an artist will do once he&#39;s peaked. Round this same time, Bowie the singer remarked on a copula goons who frequented the Berlin bars wearing full surgery regalia; caps, aprons, rubber gloves and masks. The cutting edge. Then came Damien Hirst with the Shark-Cow-Sheep thing. No humans, palatable ritual for the world-wide public. The acceptable face of gore. Meanwhile in the US, 1994, I was in town on the night of the Athey sacrifactions. thursday,  october 27,  1994 122 east village, manhattan Ron Athey,  performance artist not for the squeamish - former heroin addict-HIV positive, pushes what looks like a knitting needle repeatedly into his forehead,  a crown of blood, must hurt like hell. Stream red dribble-dribble. No screams. Face moves in pain. Carried upstage and scrubbed down in his own blood. The water. Now dresses in nice suit and tie. Now in black T-shirt and jean, carving, with a disposable scalpel, patterns, into the back of Darryl Carlton, a black man. Bloody blotted paper towels then hung on a washing line suspended over the heads of the audience Blood-prints from life. An extremely limited edition. When it was first performed back in March. &quot;&quot;Four Scenes In A Harsh Life&quot;&quot; exploited controversy shrapnel throughout the National Endowment For the Arts. &quot;&quot;We have taken every precaution with our disposal systems,&quot;&quot; an Athey spokesperson said. &quot;&quot;The towels containing the blood are immediately deposited in hazardous-waste bags. Each evening, the material will be driven to a hospital for final disposal&quot;&quot;. Athey says he is dealing with issues of self-loathing, suffering, healing and redemption. friday, december 31,  1999,  10.30 am museum of modern parts I&#39;m drinking up the Oxford Town, New Jersey fume. Salty and acid. Maybe I can get a handle on this thing back in Soho at the bureau. It used to be Rothko&#39;s studio, now the playground for all us Art-Crime folk, AC&#39; or &quot;&quot;the daubers&quot;&quot; as we&#39;re dubbed. Rothko himself, in a dark-deep-drunk one night, carefully removed his clothes, folded them up neatly, placing them upon a chair, lay upon the floor in a crucified position and after several attempts, found the soft blue pump of wrists and checked out. He&#39;d held the razor blades between wads of tissue paper so that he wouldn&#39;t cut his fingers. Deep thinker. Always was. 11.00 am &quot;&quot;dauber&quot;&quot;  hq,  soho The only names the Data bank can associate with Baby Grace are Leon Blank, Ramona A. Stone and Algeria Touchshriek. The rundowns are brief but not to the point: Ramona A. Stone: Female. Caucasian. Mid-40s. Assertive maintenance interest-drug dealer and Tyrannical Futurist. No convictions. Contacts: Leon Blank, Baby Grace Blue, Algeria Touchshriek. Leon Blank: Male. Mixed race. 22 years. Outsider Three convictions for petty theft, appropriation and plagiaries without license. Contacts: Baby Grace Blue, Algeria Touchshriek. Algeria Touchshriek: Male. Caucasian. 78 years. Owner of small establishment on Rail Yard, Oxford town, N.J. Deals in art-drugs and DNA prints. Fence for all apparitions of any medium. Harmless, lonely. Small cog, no wheels. Not much to go on but R.A.Stone weighs heavy on my memory. No problem, it&#39;ll come back. Best thing to do now is feed all relevant pieces into the Mack-Verbasiser, the Metarandom programme the re-strings real life facts as improbable virtual-fact. I may get a lead or two from that. 11.15 am Jesus Who. I hate typing. Anyhow, we&#39;ve got some real interesting solvents from Mack-random. How about this! Verbasiser download, first block: No convictions of assertive saints believed Caucasian way-out tyrannical evoked no images described Christian saints questions no female described christian tyrannical questions R.A.Stone christian machine believed no work is caucasian assertive saints assertive believed female  convictions martyrs and tyrannical are evoked Female described the fabric machine Slashing way out saints and martyrs and thrown downstairs Now the swirl begins. Now the image stack backs up and takes centre stage. Ramona A. Stone. I remember this thickness, this treacly liquid thought. But wait, I&#39;m ahead of myself. june 15, 1977 kreutzburg,  berlin It&#39;s two in the morning. I can&#39;t sleep for the screaming of some poor ostracized Turkish immigrant screaming his guts out from over the street. His hawking shriek sounds semi-stifled like he&#39;s got a pillow over his mouth. But the desperation comes through the spongy rubber like a knife. It cuts the breeze and bangs my eardrums. I take a walk past the fabric machine, turn left onto a street with no name, The caucasian suicide centre, naked and grimy, silhouetted by fungus yellow street lamps female slashing way-out saints for a dollar a time thrown downstairs if you can&#39;t take any more. Pure joy of retreat into death, led by the shepherdess. Anti mixed-race posters pasted upon their alter of pop-death icons party people. A zero with no name looks dull-eyed to Ms. Stone, the drone that says &quot;&quot;in the future, everything was up to itself&quot;&quot;. Yes. I remember Ramona. She set herself up as the no-future priestess of the Caucasian Suicide Temple, vomiting out her doctrine of death-as-eternal- party into the empty vessels of Berlin youth. The top floor rooms were the gateways to giving up to the holy ghost. She must have overseen more than 30 or 40 check-outs before the local squad twigged what was going down. october 28, 1994 New Yorker Magazine, advanced copy, celebrating fashion. It&#39;s a first of its kind since Tina Brown took over as editor. One look is all it took. It took the look and wrote a new book on what sophistaplites would take and bake. Guy Bourdin featured heavily in this new eDISHion. Since the advent of AIDS and the new morality, and, of course, his death, his dark sexy fatal style had fallen out of Vogue. An uncompromising photographer, he had found a twisty avenue through desire and death. A white female leg sticking gloomily out of a bath of black liquid enamel. Two glued up babes covered in tiny pearls. The glue prevented their skins from breathing and they pass out. &quot;&quot;Oh it would be beautiful.&quot;&quot; he is to have said. &quot;&quot;to photograph them dead in bed.&quot;&quot; He was a French Guy. Ha had known Man Ray. Loved Lewis Carroll. His first gig was doing hats for Vogue. He&#39;d place dead flies or bees on the faces of the models, or, female head wears hat crushed between three skinned calves heads, tongues lolling. Well, it was the &#39;50s, that was it was. The tight-collor &#39;50s seen through unspeakable hostility. He wanted but he couldn&#39;t paint. So he threw globs of revengeful hatred at his mobile subjects. He would systematically pull the phone cord out of the wall. He was never to be disturbed. Disturbed. Never. Everything and everyone died around him. One shoot focusing upon a women lying in bed was said to be a reconstruction of his estranged wife&#39;s death. Another picture has a women in a phone booth making some frantic call. Her hand is pressed whitely against the glass. Behind her and outside are two female bodies partially covered by the autumn leaves. His dream, so he told his friends, was to do shoots in the morgue, with the stiffs as mannequins, I don&#39;t know. I just read this stuff. Now his spirit was being resurrected. We&#39;re mystified by blood. It&#39;s our enemy now. We don&#39;t understand it. Can&#39;t live with it. Can&#39;t , well... y&#39;know? friday, december 31, 1999, 11.30 am After Surgery and investment in a bullet-proof mask, Ramona turned up in London, Canada as owner of a string of body-parts jewellery stores. Lamb penis necklaces, goat-scrotum purses, nipple earrings, that sort of thing. The word on the street, however, suggested that it was not in the best of interests to become one of her clients as occasionally, a customer would step into her shop and not come out again. The whistle blew after a much-loved and highly respected celebrity, known for being known, failed to show for a gallery-hanging of her mirrors. Other celebrities, equally known for being known, some only to each other, thought it was the most profound exhibit in years and couldn&#39;t take their eyes off the works. All the pieces sold within an hour, many for record prices. When the critic for Date magazine asked for an interview with the celebrity-artist, the gallery owner recalled that he hadn&#39;t seen her since earlier that day. She&#39;d mentioned that she would be going shopping for a diamond-encrusted umbilical cord as a celebratory thing to announce her pregnancy. She would be back in an hour. Just a quick stop at the &quot;&quot;Gallstone&quot;&quot;. 1986. That pregnancy would have produced a being that would be around 14 years of age. If it was still alive. To be continued...?
##    n_letters
## 1:     12837</code></pre>
<p>Это какой-то речетатив Боуи, который еще и очень непросто найти.</p>
<p>Какова средняя длина песен Боуи?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">b[, <span class="kw">mean</span>(n_letters)]</code></pre></div>
<pre><code>## [1] 1115.231</code></pre>
</div>
<div id="text_cut" class="section level3">
<h3><span class="header-section-number">4.2.3</span> Выделение подстрок и обрезание строк</h3>
<p>Еще одна полезная функция - <code>substr()</code>, она позволяет “вырезать” из <code>character</code> кусок от “сих” (<code>start =</code>) и до “сих” (<code>stop =</code>)</p>
<p>Выглядит это так:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">substr</span>(<span class="st">&quot;Не режь меня!&quot;</span>, <span class="dv">4</span>, <span class="dv">7</span>) <span class="co">#вырезаем от 4 знака до 7</span></code></pre></div>
<pre><code>## [1] &quot;режь&quot;</code></pre>
<p>Более продвинутый способ “обрезать” значения есть в пакете <code>stringr</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">b[, song_name_trunc <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">str_trunc</span>(song_name, <span class="dt">width =</span> <span class="dv">15</span>)]
<span class="kw">head</span>(b[, song_name_trunc], <span class="dv">10</span>)</code></pre></div>
<pre><code>##  [1] &quot;1917&quot;            &quot;1984&quot;            &quot;1984/Dodo&quot;      
##  [4] &quot;1984 (Live 1...&quot; &quot;1984 (Live &#39;74)&quot; &quot;5.15 The Ang...&quot;
##  [7] &quot;&#39;87 and Cry&quot;     &quot;&#39;87 and Cry,...&quot; &quot;Abdulmajid&quot;     
## [10] &quot;A Better Future&quot;</code></pre>
<p>В аргументе <code>width =</code> вы ставите максимально допустимую длину значения в векторе. Если значение длиннее, то конец отрезается, а вместо него присобачивается то, что задано в параметре <code>ellipsis =</code> (по умолчанию там стоит многоточие). Отрезается ровно столько, сколько нужно, чтобы начало и <code>ellipsis =</code> вместе были не больше чем <code>width =</code>. Эта функция очень удобна при создании графиков: очень неприятно, когда все не помещается из-за одного очень длинного названия.</p>
<p>Функция <code>str_pad()</code> позволяет добавить нужное количество пробелов (или других знаков):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">b[, song_name_pad <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">str_pad</span>(song_name, <span class="dv">20</span>)]
<span class="kw">head</span>(b[, song_name_pad], <span class="dv">10</span>)</code></pre></div>
<pre><code>##  [1] &quot;                1917&quot;      &quot;                1984&quot;     
##  [3] &quot;           1984/Dodo&quot;      &quot;    1984 (Live 1974)&quot;     
##  [5] &quot;     1984 (Live &#39;74)&quot;      &quot;5.15 The Angels Have Gone&quot;
##  [7] &quot;         &#39;87 and Cry&quot;      &quot;   &#39;87 and Cry, 2018&quot;     
##  [9] &quot;          Abdulmajid&quot;      &quot;     A Better Future&quot;</code></pre>
<p>Функция <code>str_trim()</code> делает обратную (и на практике более полезную вещь) - удаляет лишние пробелы слева и/или справа:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">b[, song_name_trimmed <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">str_trim</span>(song_name_pad)]</code></pre></div>
<p>Функция <code>str_squish()</code> делает еще круче: она еще и удаляет повторяющиеся пробелы внутри.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str_squish</span>(<span class="st">&quot; Привет,   всем&quot;</span>)</code></pre></div>
<pre><code>## [1] &quot;Привет, всем&quot;</code></pre>
</div>
<div id="text_to" class="section level3">
<h3><span class="header-section-number">4.2.4</span> Изменение регистра</h3>
<p>Чтобы перевести маленькие буквы в большие, нужно воспользоваться функцией <code>toupper()</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">toupper</span>(<span class="st">&quot;В чащах юга жил бы цитрус? Да, но фальшивый экземпляръ!&quot;</span>)</code></pre></div>
<pre><code>## [1] &quot;В ЧАЩАХ ЮГА ЖИЛ БЫ ЦИТРУС? ДА, НО ФАЛЬШИВЫЙ ЭКЗЕМПЛЯРЪ!&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tolower</span>(<span class="st">&quot;Съешь ещё этих мягких французских булок, да выпей же чаю&quot;</span>)</code></pre></div>
<pre><code>## [1] &quot;съешь ещё этих мягких французских булок, да выпей же чаю&quot;</code></pre>
<p>Ну а чтобы сделать первую букву каждого слова заглавной - <code>str_to_title()</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str_to_title</span>(<span class="st">&quot;Съешь ещё этих мягких французских булок, да выпей же чаю&quot;</span>)</code></pre></div>
<pre><code>## [1] &quot;Съешь Ещё Этих Мягких Французских Булок, Да Выпей Же Чаю&quot;</code></pre>
</div>
<div id="text_rand" class="section level3">
<h3><span class="header-section-number">4.2.5</span> Случайные последовательности</h3>
<p>Можно сделать случайные последовательности символов с помощью <code>stri_rand_strings()</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">42</span>)
<span class="kw">stri_rand_strings</span>(<span class="dt">n =</span> <span class="dv">5</span>, <span class="dt">length =</span> <span class="dv">5</span><span class="op">:</span><span class="dv">9</span>)</code></pre></div>
<pre><code>## [1] &quot;uwHpd&quot;     &quot;Wj8ehS&quot;    &quot;ivFSwy7&quot;   &quot;TYu8zw5V&quot;  &quot;OuRpjoOg0&quot;</code></pre>
<p>Можно задавать символы, допустимые для генерации таких “псевдослов” с помощью параметра <code>pattern =</code>. Например, если хотим использовать только строчные буквы латиницы, нужно использовать паттерн <code>&quot;[a-z]&quot;</code>. Так паттерны задаются в регулярных выражениях, к которым мы вернемся позже.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">stri_rand_strings</span>(<span class="dt">n =</span> <span class="dv">5</span>, <span class="dt">length =</span> <span class="dv">5</span><span class="op">:</span><span class="dv">9</span>, <span class="dt">pattern =</span> <span class="st">&quot;[a-z]&quot;</span>)</code></pre></div>
<pre><code>## [1] &quot;vafxp&quot;     &quot;jlazly&quot;    &quot;xqzqijk&quot;   &quot;ubtregnr&quot;  &quot;ztowehvsg&quot;</code></pre>
<blockquote>
<p>Строго говоря, это не то, что принято называть “псевдословами”. Под псевдословами подразумеваются такие последовательности, которые звучат как настоящие слова, но не имеют смысла. Например, “ошмаска” или “утурник”</p>
</blockquote>
<p>Ну а функция <code>stri_rand_shuffle()</code> принимает на вход строчку и возвращает ее же, но уже с перемешанными знаками.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">stri_rand_shuffle</span>(<span class="st">&quot;съешь ещё этих мягких французских булок, да выпей же чаю&quot;</span>)</code></pre></div>
<pre><code>## [1] &quot;еёхз денх лку пкщх квтсчреу йыьэоиаюжия, а шъгифаб  смце&quot;</code></pre>
</div>
<div id="text_sort" class="section level3">
<h3><span class="header-section-number">4.2.6</span> Сортировка</h3>
<p>Чтобы сортировать слова в алфавитном порядке, можно воспользоваться generic функцией <code>sort()</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sort</span>(<span class="kw">unlist</span>(<span class="kw">tstrsplit</span>(<span class="st">&quot;съешь ещё этих мягких французских булок, да выпей же чаю&quot;</span>, <span class="dt">split =</span> <span class="st">&quot; &quot;</span>)))</code></pre></div>
<pre><code>##  [1] &quot;булок,&quot;      &quot;выпей&quot;       &quot;да&quot;          &quot;ещё&quot;         &quot;же&quot;         
##  [6] &quot;мягких&quot;      &quot;съешь&quot;       &quot;французских&quot; &quot;чаю&quot;         &quot;этих&quot;</code></pre>
<blockquote>
<p>generic функция в R - это функция, которая по-разному работает для разных объектов (использует соответствующий данному классу метод). Когда функция получает объект, она первым делом смотрит, что это за класс, а потом действует исходя из класса объекта. Примеры это функции <code>print()</code>, <code>summary()</code> и <code>plot()</code> - они работают почти на любых объектах, но на всех выдают что-то свое.</p>
</blockquote>
<p><strong>Самостоятельное задание:</strong></p>
<ol style="list-style-type: decimal">
<li>Создайте <code>data.table</code> <code>mon</code> следующего вида:</li>
</ol>
<pre><code>##      n     Month
##  1:  1   January
##  2:  2  February
##  3:  3     March
##  4:  4     April
##  5:  5       May
##  6:  6      June
##  7:  7      July
##  8:  8    August
##  9:  9 September
## 10: 10   October
## 11: 11  November
## 12: 12  December</code></pre>
<blockquote>
<p>Названия месяцов - это еще одна константа, зашитая в R! Она называется <code>month.name</code>.</p>
</blockquote>
<ol start="2" style="list-style-type: decimal">
<li>Создайте колонку <code>info</code> следующего вида: “January is the 1 month” … “December is the 12 month”</li>
</ol>
<pre><code>##  [1] &quot;January is the 1 month&quot;   &quot;February is the 2 month&quot; 
##  [3] &quot;March is the 3 month&quot;     &quot;April is the 4 month&quot;    
##  [5] &quot;May is the 5 month&quot;       &quot;June is the 6 month&quot;     
##  [7] &quot;July is the 7 month&quot;      &quot;August is the 8 month&quot;   
##  [9] &quot;September is the 9 month&quot; &quot;October is the 10 month&quot; 
## [11] &quot;November is the 11 month&quot; &quot;December is the 12 month&quot;</code></pre>
<ol start="2" style="list-style-type: decimal">
<li>Сократите длину каждого месяца так, чтобы она была не больше 6 символов:</li>
</ol>
<pre><code>##  [1] &quot;Jan...&quot; &quot;Feb...&quot; &quot;March&quot;  &quot;April&quot;  &quot;May&quot;    &quot;June&quot;   &quot;July&quot;  
##  [8] &quot;August&quot; &quot;Sep...&quot; &quot;Oct...&quot; &quot;Nov...&quot; &quot;Dec...&quot;</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>Создайте в <code>mon</code> колонку <code>month</code>, где все эти месяца будут записаны с маленькой буквы.</li>
</ol>
<pre><code>##      n     Month     month
##  1:  1   January   january
##  2:  2  February  february
##  3:  3     March     march
##  4:  4     April     april
##  5:  5       May       may
##  6:  6      June      june
##  7:  7      July      july
##  8:  8    August    august
##  9:  9 September september
## 10: 10   October   october
## 11: 11  November  november
## 12: 12  December  december</code></pre>
<ol start="4" style="list-style-type: decimal">
<li>Создайте колонку <code>month_anagram</code>, в котором будут анаграммы названия каждого месяца (т.е. в данном случае - перемешанные) из колонки <code>month</code></li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">42</span>) <span class="co">#запустите, чтобы у нас одинаковые рандомизации получились</span></code></pre></div>
<pre><code>##      n     Month     month month_anagram
##  1:  1   January   january       yjuarna
##  2:  2  February  february      aefrbyur
##  3:  3     March     march         arhmc
##  4:  4     April     april         arilp
##  5:  5       May       may           mya
##  6:  6      June      june          eujn
##  7:  7      July      july          uylj
##  8:  8    August    august        tsaugu
##  9:  9 September september     seperembt
## 10: 10   October   october       orbcote
## 11: 11  November  november      rbmvonee
## 12: 12  December  december      bdemerec</code></pre>
<p>*5. Ну а теперь сложное задание - создайте функцию <code>is_anagram()</code>, которая проверяет, что два слова являются анаграммами.</p>
<blockquote>
<p>Подсказка: если в <code>tstrsplit()</code> использовать <code>split = &quot;&quot;</code>, то это разделит строку пол отдельным знакам.</p>
</blockquote>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">is_anagram</span>(<span class="st">&quot;спаниель&quot;</span>, <span class="st">&quot;апельсин&quot;</span>)</code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">is_anagram</span>(<span class="st">&quot;скол&quot;</span>, <span class="st">&quot;клок&quot;</span>)</code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<p>Затем эту функцию нужно применить на колонки <code>month</code> и <code>month_anagram</code>. Скорее всего, придется либо векторизовать функцию, либо применить <code>mapply()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mon[, <span class="kw">mapply</span>(is_anagram,month, month_anagram)]</code></pre></div>
<pre><code>##   january  february     march     april       may      june      july 
##      TRUE      TRUE      TRUE      TRUE      TRUE      TRUE      TRUE 
##    august september   october  november  december 
##      TRUE      TRUE      TRUE      TRUE      TRUE</code></pre>
</div>
</div>
<div id="regexp" class="section level2">
<h2><span class="header-section-number">4.3</span> Поиск паттернов и регулярные выражения</h2>
<p>Очень большая часть работы с текстом - это поиск паттернов. В самом элементарном виде - простых последовательностей.</p>
<div id="grep" class="section level3">
<h3><span class="header-section-number">4.3.1</span> grep(), gsub()</h3>
<p>Для этого в R есть очень много функций. Пожалуй, самая распространенная из них - функция <code>grep()</code>. Она выдает индексы значений вектора, в которых находится подходящая подстрока:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mon[, <span class="kw">grep</span>(<span class="st">&quot;ber&quot;</span>, month)]</code></pre></div>
<pre><code>## [1]  9 10 11 12</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mon[ <span class="kw">grep</span>(<span class="st">&quot;ber&quot;</span>, month),] <span class="co">#Следите за запятой!</span></code></pre></div>
<pre><code>##     n     Month     month month_anagram
## 1:  9 September september     seperembt
## 2: 10   October   october       orbcote
## 3: 11  November  november      rbmvonee
## 4: 12  December  december      bdemerec</code></pre>
<p>Можно возвращать и сами значения с помощью параметра <code>value = TRUE</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mon[, <span class="kw">grep</span>(<span class="st">&quot;ber&quot;</span>, month, <span class="dt">value =</span> <span class="ot">TRUE</span>)]</code></pre></div>
<pre><code>## [1] &quot;september&quot; &quot;october&quot;   &quot;november&quot;  &quot;december&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mon[, <span class="kw">grep</span>(<span class="st">&quot;ber&quot;</span>, month, <span class="dt">value =</span> <span class="ot">TRUE</span>, <span class="dt">invert =</span> <span class="ot">TRUE</span>)] <span class="co">#все остальные</span></code></pre></div>
<pre><code>## [1] &quot;january&quot;  &quot;february&quot; &quot;march&quot;    &quot;april&quot;    &quot;may&quot;      &quot;june&quot;    
## [7] &quot;july&quot;     &quot;august&quot;</code></pre>
<p>Ну а функция <code>gsub()</code> заменяет найденный паттерн на новый. Давайте сделаем год более веселым:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mon[, month_fun <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;ber&quot;</span>, <span class="st">&quot;berfest&quot;</span>, month)]</code></pre></div>
<p>Заметьте, первым параметром функции <code>grep()</code> идет <code>pattern =</code>, а не данные (вектор). Это довольно нетипичное поведение для R. Это “заимствованное” слово для R - изначально <code>grep()</code> появилась в UNIX очень давно и означала <em>«search <strong>g</strong>lobally for lines matching the <strong>r</strong>egular <strong>e</strong>xpression, and <strong>p</strong>rint them»</em>. Вот и настала пора поразбираться с регулярными выражениями.</p>
<blockquote>
<p>Функции <code>grep()</code> и <code>gsub()</code> могут использовать “избегая” регулярных выражений, для этого нужно задать параметр <code>fixed = TRUE</code>. Я очень рекомендую это делать, если Вы еще не освоились с регулярными выражениями, иначе результат этих функций будет казаться непредсказуемым.</p>
</blockquote>
</div>
<div id="reg" class="section level3">
<h3><span class="header-section-number">4.3.2</span> Регулярные выражения</h3>
<p>Регулярные выражения - это целый язык, который позволяет найти любой сложный паттерн в тексте. В основе всей сложной работы с текстом обычно лежат “регулярки”. Поэтому стоит ознакомиться хотя бы с их основами.</p>
<blockquote>
<p>Регулярные выражения реализованы в очень многих языках программирования, не только в R, так что это довольно универсальный навык.</p>
</blockquote>
<div class="figure">
<img src="images/reg.png" alt="reg.png" />
<p class="caption">reg.png</p>
</div>
<p>Учить их лучше всего интерактивно: очень удобно смотреть, что в тексте находится по введенному паттерну. В качестве примера я могу посоветовать ресурс <a href="https://regexone.com">regexone</a>. Потренироваться можно на [кроссворде] (<a href="https://regexcrossword.com/challenges/beginner/puzzles/1" class="uri">https://regexcrossword.com/challenges/beginner/puzzles/1</a>). Пакет <code>stringr</code> тоже предоставляет удобный инструмент: функции <code>str_view()</code> (показывает первый найденный паттерн) и <code>str_view_all()</code> (показывает все найденные паттерны). Первый аргумент в них - вектор с данными, второй - паттерн регулярных выражений. Если Все введено верно, то во вкладке Viewer окна RStudio появится данный вектор с выделенными паттернами.</p>
<p>Если нужно найти простую последовательность, то здесь все так же, как и обычно. Очень похоже на то, что Вы делаете, если нажимаете <code>Ctrl + F</code> и пытаетесь найти в тексте какое-то ключевое слово:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">names &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Саня&quot;</span>, <span class="st">&quot;Ваня&quot;</span>, <span class="st">&quot;Даня&quot;</span>, <span class="st">&quot;Женя&quot;</span>, <span class="st">&quot;Аня&quot;</span>, <span class="st">&quot;Андрей&quot;</span>, <span class="st">&quot;Леша&quot;</span>, <span class="st">&quot;Лера&quot;</span>, <span class="st">&quot;Витя&quot;</span>, <span class="st">&quot;Валера&quot;</span>)
<span class="kw">str_view_all</span>(names, <span class="st">&quot;аня&quot;</span>)</code></pre></div>
<div id="htmlwidget-caa9b4d351b92a03c694" style="width:960px;height:100%;" class="str_view html-widget"></div>
<script type="application/json" data-for="htmlwidget-caa9b4d351b92a03c694">{"x":{"html":"<ul>\n  <li>С<span class='match'>аня<\/span><\/li>\n  <li>В<span class='match'>аня<\/span><\/li>\n  <li>Д<span class='match'>аня<\/span><\/li>\n  <li>Женя<\/li>\n  <li>Аня<\/li>\n  <li>Андрей<\/li>\n  <li>Леша<\/li>\n  <li>Лера<\/li>\n  <li>Витя<\/li>\n  <li>Валера<\/li>\n<\/ul>"},"evals":[],"jsHooks":[]}</script>
<p>Заметьте, “Аня” осталась за бортом, потому что регулярные выражения case-sensitive. Скажем, мы хотим найти написанные как с большой, так и маленькой буквы паттерны “аня”. Здесь придут на помощь наборы - возможные варианты букв, которые мы ожидаем увидеть на нужном месте:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str_view_all</span>(names, <span class="st">&quot;[аА]ня&quot;</span>)</code></pre></div>
<div id="htmlwidget-ea0637cb95257bc4c47e" style="width:960px;height:100%;" class="str_view html-widget"></div>
<script type="application/json" data-for="htmlwidget-ea0637cb95257bc4c47e">{"x":{"html":"<ul>\n  <li>С<span class='match'>аня<\/span><\/li>\n  <li>В<span class='match'>аня<\/span><\/li>\n  <li>Д<span class='match'>аня<\/span><\/li>\n  <li>Женя<\/li>\n  <li><span class='match'>Аня<\/span><\/li>\n  <li>Андрей<\/li>\n  <li>Леша<\/li>\n  <li>Лера<\/li>\n  <li>Витя<\/li>\n  <li>Валера<\/li>\n<\/ul>"},"evals":[],"jsHooks":[]}</script>
<p>Ура, мы поймали Аню!</p>
<p>Наборы можно задавать в целом диапазоне. Например, чтобы задать все буквы кириллицы, нужно задать такой диапазон: <code>[а-яА-ЯёЁ]</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str_view_all</span>(names, <span class="st">&quot;[а-яА-ЯёЁ]ня&quot;</span>)</code></pre></div>
<div id="htmlwidget-07ae93ca6d53feb7020f" style="width:960px;height:100%;" class="str_view html-widget"></div>
<script type="application/json" data-for="htmlwidget-07ae93ca6d53feb7020f">{"x":{"html":"<ul>\n  <li>С<span class='match'>аня<\/span><\/li>\n  <li>В<span class='match'>аня<\/span><\/li>\n  <li>Д<span class='match'>аня<\/span><\/li>\n  <li>Ж<span class='match'>еня<\/span><\/li>\n  <li><span class='match'>Аня<\/span><\/li>\n  <li>Андрей<\/li>\n  <li>Леша<\/li>\n  <li>Лера<\/li>\n  <li>Витя<\/li>\n  <li>Валера<\/li>\n<\/ul>"},"evals":[],"jsHooks":[]}</script>
<p>Теперь мы поймали еще и Женю.</p>
<p>Символ <code>^</code> (внутри набора) означает, что мы ожидаем увидеть любые символы, кроме тех, что в наборе. Попробуйте догадаться, какие имена мы поймаем следующими паттернами: <code>&quot;[^а-яА-ЯёЁ]ня&quot;</code>, <code>&quot;[^а]ня&quot;</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str_view_all</span>(names, <span class="st">&quot;[^а-яА-ЯёЁ]ня&quot;</span>)</code></pre></div>
<div id="htmlwidget-22b37fd658262e543f1e" style="width:960px;height:100%;" class="str_view html-widget"></div>
<script type="application/json" data-for="htmlwidget-22b37fd658262e543f1e">{"x":{"html":"<ul>\n  <li>Саня<\/li>\n  <li>Ваня<\/li>\n  <li>Даня<\/li>\n  <li>Женя<\/li>\n  <li>Аня<\/li>\n  <li>Андрей<\/li>\n  <li>Леша<\/li>\n  <li>Лера<\/li>\n  <li>Витя<\/li>\n  <li>Валера<\/li>\n<\/ul>"},"evals":[],"jsHooks":[]}</script>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str_view_all</span>(names, <span class="st">&quot;[^а]ня&quot;</span>)</code></pre></div>
<div id="htmlwidget-957513afe3830fb6c436" style="width:960px;height:100%;" class="str_view html-widget"></div>
<script type="application/json" data-for="htmlwidget-957513afe3830fb6c436">{"x":{"html":"<ul>\n  <li>Саня<\/li>\n  <li>Ваня<\/li>\n  <li>Даня<\/li>\n  <li>Ж<span class='match'>еня<\/span><\/li>\n  <li><span class='match'>Аня<\/span><\/li>\n  <li>Андрей<\/li>\n  <li>Леша<\/li>\n  <li>Лера<\/li>\n  <li>Витя<\/li>\n  <li>Валера<\/li>\n<\/ul>"},"evals":[],"jsHooks":[]}</script>
<p>Иногда нужно найти один из двух паттернов - то есть реализовать что-то вроде логического ИЛИ. В регулярных выражениях тоже такое есть. Более того, для этого нужен тот же оператор, что и в R - <code>|</code>. Например, мы хотим найти все имена, заканчивающиеся на “ня” и начинающиеся на “Ле”:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str_view_all</span>(names, <span class="st">&quot;Ле|ня&quot;</span>)</code></pre></div>
<div id="htmlwidget-cd0e34c61f8e4238addd" style="width:960px;height:100%;" class="str_view html-widget"></div>
<script type="application/json" data-for="htmlwidget-cd0e34c61f8e4238addd">{"x":{"html":"<ul>\n  <li>Са<span class='match'>ня<\/span><\/li>\n  <li>Ва<span class='match'>ня<\/span><\/li>\n  <li>Да<span class='match'>ня<\/span><\/li>\n  <li>Же<span class='match'>ня<\/span><\/li>\n  <li>А<span class='match'>ня<\/span><\/li>\n  <li>Андрей<\/li>\n  <li><span class='match'>Ле<\/span>ша<\/li>\n  <li><span class='match'>Ле<\/span>ра<\/li>\n  <li>Витя<\/li>\n  <li>Валера<\/li>\n<\/ul>"},"evals":[],"jsHooks":[]}</script>
<p>Если бы паттерн включал бы в себя еще и варианты с маленькой буквы “л”, то мы бы поймали еще и Валеру:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str_view_all</span>(names, <span class="st">&quot;[лЛ]е|ня&quot;</span>)</code></pre></div>
<div id="htmlwidget-789eeebaadf7791ef3f8" style="width:960px;height:100%;" class="str_view html-widget"></div>
<script type="application/json" data-for="htmlwidget-789eeebaadf7791ef3f8">{"x":{"html":"<ul>\n  <li>Са<span class='match'>ня<\/span><\/li>\n  <li>Ва<span class='match'>ня<\/span><\/li>\n  <li>Да<span class='match'>ня<\/span><\/li>\n  <li>Же<span class='match'>ня<\/span><\/li>\n  <li>А<span class='match'>ня<\/span><\/li>\n  <li>Андрей<\/li>\n  <li><span class='match'>Ле<\/span>ша<\/li>\n  <li><span class='match'>Ле<\/span>ра<\/li>\n  <li>Витя<\/li>\n  <li>Ва<span class='match'>ле<\/span>ра<\/li>\n<\/ul>"},"evals":[],"jsHooks":[]}</script>
<p>Чтобы этого избежать, мы можем задать, что <code>&quot;[лЛ]е&quot;</code> должно быть в начале строки (с помощью знака <code>&quot;^&quot;</code>), а <code>&quot;ня&quot;</code> - в конце.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str_view_all</span>(names, <span class="st">&quot;^[лЛ]е|ня$&quot;</span>)</code></pre></div>
<div id="htmlwidget-51e4df7fe6d33978e88f" style="width:960px;height:100%;" class="str_view html-widget"></div>
<script type="application/json" data-for="htmlwidget-51e4df7fe6d33978e88f">{"x":{"html":"<ul>\n  <li>Са<span class='match'>ня<\/span><\/li>\n  <li>Ва<span class='match'>ня<\/span><\/li>\n  <li>Да<span class='match'>ня<\/span><\/li>\n  <li>Же<span class='match'>ня<\/span><\/li>\n  <li>А<span class='match'>ня<\/span><\/li>\n  <li>Андрей<\/li>\n  <li><span class='match'>Ле<\/span>ша<\/li>\n  <li><span class='match'>Ле<\/span>ра<\/li>\n  <li>Витя<\/li>\n  <li>Валера<\/li>\n<\/ul>"},"evals":[],"jsHooks":[]}</script>
<p>Что если мы хотим найти точку? Давайте попробуем использовать ее в регулярном выражении:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">hello &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;При 534вет.&quot;, &quot;</span>всем<span class="st">&quot;)</span>
<span class="st">str_view_all(hello, &quot;</span>.<span class="st">&quot;)</span></code></pre></div>
<div id="htmlwidget-85f1f2cb6fdbb21a7403" style="width:960px;height:100%;" class="str_view html-widget"></div>
<script type="application/json" data-for="htmlwidget-85f1f2cb6fdbb21a7403">{"x":{"html":"<ul>\n  <li><span class='match'>П<\/span><span class='match'>р<\/span><span class='match'>и<\/span><span class='match'> <\/span><span class='match'>5<\/span><span class='match'>3<\/span><span class='match'>4<\/span><span class='match'>в<\/span><span class='match'>е<\/span><span class='match'>т<\/span><span class='match'>.<\/span><\/li>\n  <li><span class='match'>в<\/span><span class='match'>с<\/span><span class='match'>е<\/span><span class='match'>м<\/span><\/li>\n<\/ul>"},"evals":[],"jsHooks":[]}</script>
<p>Что-то не то. Дело в том, что точка (как и уже знакомые нам некоторые другие символы - <code>[]|^$</code>) - это спецсимволы, которые имеют специальную функцию в регулярных выражениях. Конкретно точка означает “любой знак”. Но если нам нужно найти в тексте именно точку или другой спецсимвол, то его нужно <em>экранировать</em> с помощью специального паттерна “\” (вне R это “&quot;):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str_view_all</span>(hello, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">.&quot;</span>)</code></pre></div>
<div id="htmlwidget-5818a778cbc289da0981" style="width:960px;height:100%;" class="str_view html-widget"></div>
<script type="application/json" data-for="htmlwidget-5818a778cbc289da0981">{"x":{"html":"<ul>\n  <li>При 534вет<span class='match'>.<\/span><\/li>\n  <li>всем<\/li>\n<\/ul>"},"evals":[],"jsHooks":[]}</script>
<p>Для наиболее распространенных последовательностей есть специальные символы. С ними все наоборот, чтобы их использовать, нужно их экранировать. Например, <code>\\w</code> выдаст все цифробуквенные (alphanumeric) знаки:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str_view_all</span>(hello, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">w&quot;</span>)</code></pre></div>
<div id="htmlwidget-8b17791281bcda0c86bc" style="width:960px;height:100%;" class="str_view html-widget"></div>
<script type="application/json" data-for="htmlwidget-8b17791281bcda0c86bc">{"x":{"html":"<ul>\n  <li><span class='match'>П<\/span><span class='match'>р<\/span><span class='match'>и<\/span> <span class='match'>5<\/span><span class='match'>3<\/span><span class='match'>4<\/span><span class='match'>в<\/span><span class='match'>е<\/span><span class='match'>т<\/span>.<\/li>\n  <li><span class='match'>в<\/span><span class='match'>с<\/span><span class='match'>е<\/span><span class='match'>м<\/span><\/li>\n<\/ul>"},"evals":[],"jsHooks":[]}</script>
<p>А <code>\\W</code> - все кроме цифробуквенных знаков</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str_view_all</span>(hello, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">W&quot;</span>)</code></pre></div>
<div id="htmlwidget-573e5b3131db536e76be" style="width:960px;height:100%;" class="str_view html-widget"></div>
<script type="application/json" data-for="htmlwidget-573e5b3131db536e76be">{"x":{"html":"<ul>\n  <li>При<span class='match'> <\/span>534вет<span class='match'>.<\/span><\/li>\n  <li>всем<\/li>\n<\/ul>"},"evals":[],"jsHooks":[]}</script>
<p><code>\\d</code> - только цифры:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str_view_all</span>(hello, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">d&quot;</span>)</code></pre></div>
<div id="htmlwidget-a8fc3abc94522133f256" style="width:960px;height:100%;" class="str_view html-widget"></div>
<script type="application/json" data-for="htmlwidget-a8fc3abc94522133f256">{"x":{"html":"<ul>\n  <li>При <span class='match'>5<\/span><span class='match'>3<\/span><span class='match'>4<\/span>вет.<\/li>\n  <li>всем<\/li>\n<\/ul>"},"evals":[],"jsHooks":[]}</script>
<p><code>\\D</code> - кроме цифр:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str_view_all</span>(hello, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">s&quot;</span>)</code></pre></div>
<div id="htmlwidget-554e6af6f33f1d2071ca" style="width:960px;height:100%;" class="str_view html-widget"></div>
<script type="application/json" data-for="htmlwidget-554e6af6f33f1d2071ca">{"x":{"html":"<ul>\n  <li>При<span class='match'> <\/span>534вет.<\/li>\n  <li>всем<\/li>\n<\/ul>"},"evals":[],"jsHooks":[]}</script>
<p><code>\\s</code> - только пробелы:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str_view_all</span>(hello, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">S&quot;</span>)</code></pre></div>
<div id="htmlwidget-d98f990fcb8cca036f4a" style="width:960px;height:100%;" class="str_view html-widget"></div>
<script type="application/json" data-for="htmlwidget-d98f990fcb8cca036f4a">{"x":{"html":"<ul>\n  <li><span class='match'>П<\/span><span class='match'>р<\/span><span class='match'>и<\/span> <span class='match'>5<\/span><span class='match'>3<\/span><span class='match'>4<\/span><span class='match'>в<\/span><span class='match'>е<\/span><span class='match'>т<\/span><span class='match'>.<\/span><\/li>\n  <li><span class='match'>в<\/span><span class='match'>с<\/span><span class='match'>е<\/span><span class='match'>м<\/span><\/li>\n<\/ul>"},"evals":[],"jsHooks":[]}</script>
<p><code>\\S</code> - все кроме пробелов:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str_view_all</span>(hello, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">D&quot;</span>)</code></pre></div>
<div id="htmlwidget-0d46c0e3ac7375a041f1" style="width:960px;height:100%;" class="str_view html-widget"></div>
<script type="application/json" data-for="htmlwidget-0d46c0e3ac7375a041f1">{"x":{"html":"<ul>\n  <li><span class='match'>П<\/span><span class='match'>р<\/span><span class='match'>и<\/span><span class='match'> <\/span>534<span class='match'>в<\/span><span class='match'>е<\/span><span class='match'>т<\/span><span class='match'>.<\/span><\/li>\n  <li><span class='match'>в<\/span><span class='match'>с<\/span><span class='match'>е<\/span><span class='match'>м<\/span><\/li>\n<\/ul>"},"evals":[],"jsHooks":[]}</script>
<p>Следующий этап наращивания нашей мощи инструментария регулярных выражений - количество паттернов.</p>
<p>В общем виде оно задается с помощью фигурных скобочек:</p>
<ul>
<li>{n}: ровно n</li>
<li>{n,}: n или больше</li>
<li>{,m}: не больше m</li>
<li>{n,m}: между n и m</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">long &lt;-<span class="st"> &quot;1888 - самый длинный год, записанный в римских цифрах: MDCCCLXXXVIII&quot;</span>
<span class="kw">str_view_all</span>(long, <span class="st">&quot;C{3}&quot;</span>)</code></pre></div>
<div id="htmlwidget-268ec78007c4c7334b5c" style="width:960px;height:100%;" class="str_view html-widget"></div>
<script type="application/json" data-for="htmlwidget-268ec78007c4c7334b5c">{"x":{"html":"<ul>\n  <li>1888 - самый длинный год, записанный в римских цифрах: MD<span class='match'>CCC<\/span>LXXXVIII<\/li>\n<\/ul>"},"evals":[],"jsHooks":[]}</script>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str_view_all</span>(long, <span class="st">&quot;X{1,}&quot;</span>)</code></pre></div>
<div id="htmlwidget-a27b8109a487926fb958" style="width:960px;height:100%;" class="str_view html-widget"></div>
<script type="application/json" data-for="htmlwidget-a27b8109a487926fb958">{"x":{"html":"<ul>\n  <li>1888 - самый длинный год, записанный в римских цифрах: MDCCCL<span class='match'>XXX<\/span>VIII<\/li>\n<\/ul>"},"evals":[],"jsHooks":[]}</script>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str_view_all</span>(long, <span class="st">&quot;н{1,2}&quot;</span>)</code></pre></div>
<div id="htmlwidget-4f47fa3971af6ce2cf73" style="width:960px;height:100%;" class="str_view html-widget"></div>
<script type="application/json" data-for="htmlwidget-4f47fa3971af6ce2cf73">{"x":{"html":"<ul>\n  <li>1888 - самый дли<span class='match'>нн<\/span>ый год, записа<span class='match'>нн<\/span>ый в римских цифрах: MDCCCLXXXVIII<\/li>\n<\/ul>"},"evals":[],"jsHooks":[]}</script>
<p>Для самых распространенных вариантов количества искомых паттернов есть сокращения:</p>
<ul>
<li>? = 0 или 1</li>
<li><ul>
<li>= 1 или больше</li>
</ul></li>
<li><ul>
<li>= 0 или больше</li>
</ul></li>
</ul>
<p>Например, чтобы вытащить все последовательности, начинающиеся на “Л” и заканчивающиеся на “а” (включая Ла), нужно записать так:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str_view_all</span>(names, <span class="st">&quot;^Л.*а$&quot;</span>)</code></pre></div>
<div id="htmlwidget-8ba3efd4f89b00a8e97c" style="width:960px;height:100%;" class="str_view html-widget"></div>
<script type="application/json" data-for="htmlwidget-8ba3efd4f89b00a8e97c">{"x":{"html":"<ul>\n  <li>Саня<\/li>\n  <li>Ваня<\/li>\n  <li>Даня<\/li>\n  <li>Женя<\/li>\n  <li>Аня<\/li>\n  <li>Андрей<\/li>\n  <li><span class='match'>Леша<\/span><\/li>\n  <li><span class='match'>Лера<\/span><\/li>\n  <li>Витя<\/li>\n  <li>Валера<\/li>\n<\/ul>"},"evals":[],"jsHooks":[]}</script>
<p>Ну а что бы вытащить все последовательности, где стоит или не стоит какой-то символ, то записать нужно так:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str_view_all</span>(names, <span class="st">&quot;^Ле.?а$&quot;</span>)</code></pre></div>
<div id="htmlwidget-eb1f11f8ff6f96c10bbf" style="width:960px;height:100%;" class="str_view html-widget"></div>
<script type="application/json" data-for="htmlwidget-eb1f11f8ff6f96c10bbf">{"x":{"html":"<ul>\n  <li>Саня<\/li>\n  <li>Ваня<\/li>\n  <li>Даня<\/li>\n  <li>Женя<\/li>\n  <li>Аня<\/li>\n  <li>Андрей<\/li>\n  <li><span class='match'>Леша<\/span><\/li>\n  <li><span class='match'>Лера<\/span><\/li>\n  <li>Витя<\/li>\n  <li>Валера<\/li>\n<\/ul>"},"evals":[],"jsHooks":[]}</script>
<p><strong>Самостоятельное задание:</strong></p>
<ol style="list-style-type: decimal">
<li>Найдите время в формате “04:30”, “06:59”</li>
</ol>
<p>Проверьте на векторе <code>times</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">times &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;04:30&quot;</span>, <span class="st">&quot;06:59&quot;</span>,<span class="st">&quot;fg:55&quot;</span>,<span class="st">&quot;3345&quot;</span>)</code></pre></div>
<div id="htmlwidget-d99fa625690e1b6cd474" style="width:960px;height:100%;" class="str_view html-widget"></div>
<script type="application/json" data-for="htmlwidget-d99fa625690e1b6cd474">{"x":{"html":"<ul>\n  <li><span class='match'>04:30<\/span><\/li>\n  <li><span class='match'>06:59<\/span><\/li>\n  <li>fg:55<\/li>\n  <li>3345<\/li>\n<\/ul>"},"evals":[],"jsHooks":[]}</script>
<ol start="2" style="list-style-type: decimal">
<li>Найдите время в формате “04:30”, “06:59”, игнорируя “невозможное” время, например, “19:84”</li>
</ol>
<p>Проверьте на векторе <code>times</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">times &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;04:30&quot;</span>, <span class="st">&quot;06:59&quot;</span>,<span class="st">&quot;fg:55&quot;</span>,<span class="st">&quot;3345&quot;</span>, <span class="st">&quot;19:84&quot;</span>)</code></pre></div>
<div id="htmlwidget-39510841c6e2f7e86be9" style="width:960px;height:100%;" class="str_view html-widget"></div>
<script type="application/json" data-for="htmlwidget-39510841c6e2f7e86be9">{"x":{"html":"<ul>\n  <li><span class='match'>04:30<\/span><\/li>\n  <li><span class='match'>06:59<\/span><\/li>\n  <li>fg:55<\/li>\n  <li>3345<\/li>\n  <li>19:84<\/li>\n<\/ul>"},"evals":[],"jsHooks":[]}</script>
<ol start="3" style="list-style-type: decimal">
<li>Найдите время, которое может быть в других форматах: “4:20”, “20-10”, но не “20г21” или “2019”</li>
</ol>
<p>Проверьте на векторе <code>times</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">times &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;04:30&quot;</span>, <span class="st">&quot;06:59&quot;</span>,<span class="st">&quot;fg:55&quot;</span>,<span class="st">&quot;3345&quot;</span>, <span class="st">&quot;19:84&quot;</span>, <span class="st">&quot;20-10&quot;</span>, <span class="st">&quot;4:20&quot;</span>, <span class="st">&quot;20r21&quot;</span>, <span class="st">&quot;2019&quot;</span>)</code></pre></div>
<div id="htmlwidget-82e96e55616a19e5bfa8" style="width:960px;height:100%;" class="str_view html-widget"></div>
<script type="application/json" data-for="htmlwidget-82e96e55616a19e5bfa8">{"x":{"html":"<ul>\n  <li><span class='match'>04:30<\/span><\/li>\n  <li><span class='match'>06:59<\/span><\/li>\n  <li>fg:55<\/li>\n  <li>3345<\/li>\n  <li>19:84<\/li>\n  <li><span class='match'>20-10<\/span><\/li>\n  <li>4:20<\/li>\n  <li>20r21<\/li>\n  <li>2019<\/li>\n<\/ul>"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="text_next" class="section level2">
<h2><span class="header-section-number">4.4</span> А что дальше?</h2>
<p>Регулярные выражения - это супермощный инструмент. Однако он довольно непростой, да и выглядит совершенно монструозно. Хэдли Уикхэм приводит следующий пример реально используемого кода для поиска в тексте электронных почт:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="st">&quot;(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])*(?:(?:(?:[^()&lt;&gt;@,;:</span><span class="ch">\\</span><span class="st">&quot;</span>.\[\] \<span class="dv">000</span><span class="op">-</span>\<span class="dv">031</span>]<span class="op">+</span>(?<span class="op">:</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t]
)<span class="op">+</span><span class="er">|</span>\Z<span class="op">|</span>(?=[\[<span class="st">&quot;()&lt;&gt;@,;:</span><span class="ch">\\</span><span class="st">&quot;</span>.\[\]]))<span class="op">|</span><span class="st">&quot;(?:[^</span><span class="ch">\&quot;\r\\</span><span class="st">]|</span><span class="ch">\\</span><span class="st">.|(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">]))*&quot;</span>(?<span class="op">:</span>(?<span class="op">:</span>
\r\n)?[ \t])<span class="op">*</span><span class="er">)</span>(?<span class="op">:</span>\.(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>(?<span class="op">:</span>[<span class="op">^</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\] </span><span class="ch">\000</span><span class="st">-</span><span class="ch">\031</span><span class="st">]+(?:(?:(</span>
<span class="st">?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])+|\Z|(?=[\[&quot;</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\]]))|&quot;</span>(?<span class="op">:</span>[<span class="op">^</span>\<span class="st">&quot;</span><span class="ch">\r\\</span><span class="st">]|</span><span class="ch">\\</span><span class="st">.|(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span>
<span class="ch">\t</span><span class="st">]))*&quot;</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>))<span class="op">*</span><span class="er">@</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>(?<span class="op">:</span>[<span class="op">^</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\] </span><span class="ch">\000</span><span class="st">-\0</span>
<span class="st">31]+(?:(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])+|\Z|(?=[\[&quot;</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\]]))|\[([^\[\]</span><span class="ch">\r\\</span><span class="st">]|</span><span class="ch">\\</span><span class="st">.)*\</span>
<span class="st">](?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])*)(?:\.(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])*(?:[^()&lt;&gt;@,;:</span><span class="ch">\\</span><span class="st">&quot;</span>.\[\] \<span class="dv">000</span><span class="op">-</span>\<span class="dv">031</span>]<span class="op">+</span>
(?<span class="op">:</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">+</span><span class="er">|</span>\Z<span class="op">|</span>(?=[\[<span class="st">&quot;()&lt;&gt;@,;:</span><span class="ch">\\</span><span class="st">&quot;</span>.\[\]]))<span class="op">|</span>\[([<span class="op">^</span>\[\]\r\\]<span class="op">|</span>\\.)<span class="op">*</span>\](?<span class="op">:</span>
(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>))<span class="op">*</span><span class="er">|</span>(?<span class="op">:</span>[<span class="op">^</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\] </span><span class="ch">\000</span><span class="st">-</span><span class="ch">\031</span><span class="st">]+(?:(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])+|\Z</span>
<span class="st">|(?=[\[&quot;</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\]]))|&quot;</span>(?<span class="op">:</span>[<span class="op">^</span>\<span class="st">&quot;</span><span class="ch">\r\\</span><span class="st">]|</span><span class="ch">\\</span><span class="st">.|(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">]))*&quot;</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)
?[ \t])<span class="op">*</span>)<span class="op">*</span>\<span class="op">&lt;</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>(?<span class="op">:</span><span class="er">@</span>(?<span class="op">:</span>[<span class="op">^</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\] </span><span class="ch">\000</span><span class="st">-</span><span class="ch">\031</span><span class="st">]+(?:(?:(?:\</span>
<span class="st">r</span><span class="ch">\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])+|\Z|(?=[\[&quot;</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\]]))|\[([^\[\]</span><span class="ch">\r\\</span><span class="st">]|</span><span class="ch">\\</span><span class="st">.)*\](?:(?:</span><span class="ch">\r\n</span><span class="st">)?[</span>
<span class="st"> </span><span class="ch">\t</span><span class="st">])*)(?:\.(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])*(?:[^()&lt;&gt;@,;:</span><span class="ch">\\</span><span class="st">&quot;</span>.\[\] \<span class="dv">000</span><span class="op">-</span>\<span class="dv">031</span>]<span class="op">+</span>(?<span class="op">:</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)
?[ \t])<span class="op">+</span><span class="er">|</span>\Z<span class="op">|</span>(?=[\[<span class="st">&quot;()&lt;&gt;@,;:</span><span class="ch">\\</span><span class="st">&quot;</span>.\[\]]))<span class="op">|</span>\[([<span class="op">^</span>\[\]\r\\]<span class="op">|</span>\\.)<span class="op">*</span>\](?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t]
)<span class="op">*</span>))<span class="op">*</span>(?<span class="op">:</span>,<span class="op">@</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>(?<span class="op">:</span>[<span class="op">^</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\] </span><span class="ch">\000</span><span class="st">-</span><span class="ch">\031</span><span class="st">]+(?:(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[</span>
<span class="st"> </span><span class="ch">\t</span><span class="st">])+|\Z|(?=[\[&quot;</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\]]))|\[([^\[\]</span><span class="ch">\r\\</span><span class="st">]|</span><span class="ch">\\</span><span class="st">.)*\](?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])*</span>
<span class="st">)(?:\.(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])*(?:[^()&lt;&gt;@,;:</span><span class="ch">\\</span><span class="st">&quot;</span>.\[\] \<span class="dv">000</span><span class="op">-</span>\<span class="dv">031</span>]<span class="op">+</span>(?<span class="op">:</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t]
)<span class="op">+</span><span class="er">|</span>\Z<span class="op">|</span>(?=[\[<span class="st">&quot;()&lt;&gt;@,;:</span><span class="ch">\\</span><span class="st">&quot;</span>.\[\]]))<span class="op">|</span>\[([<span class="op">^</span>\[\]\r\\]<span class="op">|</span>\\.)<span class="op">*</span>\](?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>))<span class="op">*</span>)
<span class="op">*</span><span class="er">:</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span><span class="er">)</span>?(?<span class="op">:</span>[<span class="op">^</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\] </span><span class="ch">\000</span><span class="st">-</span><span class="ch">\031</span><span class="st">]+(?:(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])+</span>
<span class="st">|\Z|(?=[\[&quot;</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\]]))|&quot;</span>(?<span class="op">:</span>[<span class="op">^</span>\<span class="st">&quot;</span><span class="ch">\r\\</span><span class="st">]|</span><span class="ch">\\</span><span class="st">.|(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">]))*&quot;</span>(?<span class="op">:</span>(?<span class="op">:</span>\r
\n)?[ \t])<span class="op">*</span>)(?<span class="op">:</span>\.(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>(?<span class="op">:</span>[<span class="op">^</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\] </span><span class="ch">\000</span><span class="st">-</span><span class="ch">\031</span><span class="st">]+(?:(?:(?:</span>
<span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])+|\Z|(?=[\[&quot;</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\]]))|&quot;</span>(?<span class="op">:</span>[<span class="op">^</span>\<span class="st">&quot;</span><span class="ch">\r\\</span><span class="st">]|</span><span class="ch">\\</span><span class="st">.|(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span>
<span class="st">]))*&quot;</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>))<span class="op">*</span><span class="er">@</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>(?<span class="op">:</span>[<span class="op">^</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\] </span><span class="ch">\000</span><span class="st">-</span><span class="ch">\031</span>
<span class="st">]+(?:(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])+|\Z|(?=[\[&quot;</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\]]))|\[([^\[\]</span><span class="ch">\r\\</span><span class="st">]|</span><span class="ch">\\</span><span class="st">.)*\](</span>
<span class="st">?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])*)(?:\.(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])*(?:[^()&lt;&gt;@,;:</span><span class="ch">\\</span><span class="st">&quot;</span>.\[\] \<span class="dv">000</span><span class="op">-</span>\<span class="dv">031</span>]<span class="op">+</span>(?
<span class="op">:</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">+</span><span class="er">|</span>\Z<span class="op">|</span>(?=[\[<span class="st">&quot;()&lt;&gt;@,;:</span><span class="ch">\\</span><span class="st">&quot;</span>.\[\]]))<span class="op">|</span>\[([<span class="op">^</span>\[\]\r\\]<span class="op">|</span>\\.)<span class="op">*</span>\](?<span class="op">:</span>(?
<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>))<span class="op">*</span>\<span class="op">&gt;</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>)<span class="op">|</span>(?<span class="op">:</span>[<span class="op">^</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\] </span><span class="ch">\000</span><span class="st">-</span><span class="ch">\031</span><span class="st">]+(?:(?</span>
<span class="st">:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])+|\Z|(?=[\[&quot;</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\]]))|&quot;</span>(?<span class="op">:</span>[<span class="op">^</span>\<span class="st">&quot;</span><span class="ch">\r\\</span><span class="st">]|</span><span class="ch">\\</span><span class="st">.|(?:(?:</span><span class="ch">\r\n</span><span class="st">)?</span>
<span class="st">[ </span><span class="ch">\t</span><span class="st">]))*&quot;</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>)<span class="op">*</span><span class="er">:</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>(?<span class="op">:</span>(?<span class="op">:</span>(?<span class="op">:</span>[<span class="op">^</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\] </span>
<span class="ch">\000</span><span class="st">-</span><span class="ch">\031</span><span class="st">]+(?:(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])+|\Z|(?=[\[&quot;</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\]]))|&quot;</span>(?<span class="op">:</span>[<span class="op">^</span>\<span class="st">&quot;</span><span class="ch">\r\\</span><span class="st">]|</span>
<span class="ch">\\</span><span class="st">.|(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">]))*&quot;</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>)(?<span class="op">:</span>\.(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>(?<span class="op">:</span>[<span class="op">^</span>()<span class="op">&lt;</span><span class="er">&gt;</span>
<span class="er">@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\] </span><span class="ch">\000</span><span class="st">-</span><span class="ch">\031</span><span class="st">]+(?:(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])+|\Z|(?=[\[&quot;</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\]]))|&quot;</span>
(?<span class="op">:</span>[<span class="op">^</span>\<span class="st">&quot;</span><span class="ch">\r\\</span><span class="st">]|</span><span class="ch">\\</span><span class="st">.|(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">]))*&quot;</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>))<span class="op">*</span><span class="er">@</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t]
)<span class="op">*</span>(?<span class="op">:</span>[<span class="op">^</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\] </span><span class="ch">\000</span><span class="st">-</span><span class="ch">\031</span><span class="st">]+(?:(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])+|\Z|(?=[\[&quot;</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\
<span class="st">&quot;.\[\]]))|\[([^\[\]</span><span class="ch">\r\\</span><span class="st">]|</span><span class="ch">\\</span><span class="st">.)*\](?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])*)(?:\.(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])*(?</span>
<span class="st">:[^()&lt;&gt;@,;:</span><span class="ch">\\</span><span class="st">&quot;</span>.\[\] \<span class="dv">000</span><span class="op">-</span>\<span class="dv">031</span>]<span class="op">+</span>(?<span class="op">:</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">+</span><span class="er">|</span>\Z<span class="op">|</span>(?=[\[<span class="st">&quot;()&lt;&gt;@,;:</span><span class="ch">\\</span><span class="st">&quot;</span>.\[
\]]))<span class="op">|</span>\[([<span class="op">^</span>\[\]\r\\]<span class="op">|</span>\\.)<span class="op">*</span>\](?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>))<span class="op">*</span><span class="er">|</span>(?<span class="op">:</span>[<span class="op">^</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\] </span><span class="ch">\000</span><span class="st">-</span>
<span class="ch">\031</span><span class="st">]+(?:(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])+|\Z|(?=[\[&quot;</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\]]))|&quot;</span>(?<span class="op">:</span>[<span class="op">^</span>\<span class="st">&quot;</span><span class="ch">\r\\</span><span class="st">]|</span><span class="ch">\\</span><span class="st">.|(</span>
<span class="st">?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">]))*&quot;</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>)<span class="op">*</span>\<span class="op">&lt;</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>(?<span class="op">:</span><span class="er">@</span>(?<span class="op">:</span>[<span class="op">^</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;
<span class="op">:</span>\\<span class="st">&quot;.\[\] </span><span class="ch">\000</span><span class="st">-</span><span class="ch">\031</span><span class="st">]+(?:(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])+|\Z|(?=[\[&quot;</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\]]))|\[([</span>
<span class="st">^\[\]</span><span class="ch">\r\\</span><span class="st">]|</span><span class="ch">\\</span><span class="st">.)*\](?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])*)(?:\.(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])*(?:[^()&lt;&gt;@,;:</span><span class="ch">\\</span><span class="st">&quot;</span>
.\[\] \<span class="dv">000</span><span class="op">-</span>\<span class="dv">031</span>]<span class="op">+</span>(?<span class="op">:</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">+</span><span class="er">|</span>\Z<span class="op">|</span>(?=[\[<span class="st">&quot;()&lt;&gt;@,;:</span><span class="ch">\\</span><span class="st">&quot;</span>.\[\]]))<span class="op">|</span>\[([<span class="op">^</span>\[\
]\r\\]<span class="op">|</span>\\.)<span class="op">*</span>\](?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>))<span class="op">*</span>(?<span class="op">:</span>,<span class="op">@</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>(?<span class="op">:</span>[<span class="op">^</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\</span>
<span class="st">[\] </span><span class="ch">\000</span><span class="st">-</span><span class="ch">\031</span><span class="st">]+(?:(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])+|\Z|(?=[\[&quot;</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\]]))|\[([^\[\]\</span>
<span class="st">r</span><span class="ch">\\</span><span class="st">]|</span><span class="ch">\\</span><span class="st">.)*\](?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])*)(?:\.(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])*(?:[^()&lt;&gt;@,;:</span><span class="ch">\\</span><span class="st">&quot;</span>.\[\] 
\<span class="dv">000</span><span class="op">-</span>\<span class="dv">031</span>]<span class="op">+</span>(?<span class="op">:</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">+</span><span class="er">|</span>\Z<span class="op">|</span>(?=[\[<span class="st">&quot;()&lt;&gt;@,;:</span><span class="ch">\\</span><span class="st">&quot;</span>.\[\]]))<span class="op">|</span>\[([<span class="op">^</span>\[\]\r\\]
<span class="op">|</span>\\.)<span class="op">*</span>\](?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>))<span class="op">*</span>)<span class="op">*</span><span class="er">:</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>)?(?<span class="op">:</span>[<span class="op">^</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\] \0</span>
<span class="st">00-</span><span class="ch">\031</span><span class="st">]+(?:(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])+|\Z|(?=[\[&quot;</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\]]))|&quot;</span>(?<span class="op">:</span>[<span class="op">^</span>\<span class="st">&quot;</span><span class="ch">\r\\</span><span class="st">]|</span><span class="ch">\\</span>
<span class="st">.|(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">]))*&quot;</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>)(?<span class="op">:</span>\.(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>(?<span class="op">:</span>[<span class="op">^</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,
;<span class="op">:</span>\\<span class="st">&quot;.\[\] </span><span class="ch">\000</span><span class="st">-</span><span class="ch">\031</span><span class="st">]+(?:(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])+|\Z|(?=[\[&quot;</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\]]))|&quot;</span>(?
<span class="op">:</span>[<span class="op">^</span>\<span class="st">&quot;</span><span class="ch">\r\\</span><span class="st">]|</span><span class="ch">\\</span><span class="st">.|(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">]))*&quot;</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>))<span class="op">*</span><span class="er">@</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>
(?<span class="op">:</span>[<span class="op">^</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\] </span><span class="ch">\000</span><span class="st">-</span><span class="ch">\031</span><span class="st">]+(?:(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])+|\Z|(?=[\[&quot;</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.</span>
<span class="st">\[\]]))|\[([^\[\]</span><span class="ch">\r\\</span><span class="st">]|</span><span class="ch">\\</span><span class="st">.)*\](?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])*)(?:\.(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])*(?:[</span>
<span class="st">^()&lt;&gt;@,;:</span><span class="ch">\\</span><span class="st">&quot;</span>.\[\] \<span class="dv">000</span><span class="op">-</span>\<span class="dv">031</span>]<span class="op">+</span>(?<span class="op">:</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">+</span><span class="er">|</span>\Z<span class="op">|</span>(?=[\[<span class="st">&quot;()&lt;&gt;@,;:</span><span class="ch">\\</span><span class="st">&quot;</span>.\[\]
]))<span class="op">|</span>\[([<span class="op">^</span>\[\]\r\\]<span class="op">|</span>\\.)<span class="op">*</span>\](?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>))<span class="op">*</span>\<span class="op">&gt;</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>)(?<span class="op">:</span>,\s<span class="op">*</span>(
?<span class="op">:</span>(?<span class="op">:</span>[<span class="op">^</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\] </span><span class="ch">\000</span><span class="st">-</span><span class="ch">\031</span><span class="st">]+(?:(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])+|\Z|(?=[\[&quot;</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\
<span class="st">&quot;.\[\]]))|&quot;</span>(?<span class="op">:</span>[<span class="op">^</span>\<span class="st">&quot;</span><span class="ch">\r\\</span><span class="st">]|</span><span class="ch">\\</span><span class="st">.|(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">]))*&quot;</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>)(?<span class="op">:</span>\.(?<span class="op">:</span>(
?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>(?<span class="op">:</span>[<span class="op">^</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\] </span><span class="ch">\000</span><span class="st">-</span><span class="ch">\031</span><span class="st">]+(?:(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])+|\Z|(?=[</span>
<span class="st">\[&quot;</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\]]))|&quot;</span>(?<span class="op">:</span>[<span class="op">^</span>\<span class="st">&quot;</span><span class="ch">\r\\</span><span class="st">]|</span><span class="ch">\\</span><span class="st">.|(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">]))*&quot;</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t
])<span class="op">*</span>))<span class="op">*</span><span class="er">@</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>(?<span class="op">:</span>[<span class="op">^</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\] </span><span class="ch">\000</span><span class="st">-</span><span class="ch">\031</span><span class="st">]+(?:(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span>
<span class="st">])+|\Z|(?=[\[&quot;</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\]]))|\[([^\[\]</span><span class="ch">\r\\</span><span class="st">]|</span><span class="ch">\\</span><span class="st">.)*\](?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])*)(?</span>
<span class="st">:\.(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])*(?:[^()&lt;&gt;@,;:</span><span class="ch">\\</span><span class="st">&quot;</span>.\[\] \<span class="dv">000</span><span class="op">-</span>\<span class="dv">031</span>]<span class="op">+</span>(?<span class="op">:</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">+</span><span class="er">|</span>
\Z<span class="op">|</span>(?=[\[<span class="st">&quot;()&lt;&gt;@,;:</span><span class="ch">\\</span><span class="st">&quot;</span>.\[\]]))<span class="op">|</span>\[([<span class="op">^</span>\[\]\r\\]<span class="op">|</span>\\.)<span class="op">*</span>\](?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>))<span class="op">*</span><span class="er">|</span>(?<span class="op">:</span>
[<span class="op">^</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\] </span><span class="ch">\000</span><span class="st">-</span><span class="ch">\031</span><span class="st">]+(?:(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])+|\Z|(?=[\[&quot;</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\</span>
<span class="st">]]))|&quot;</span>(?<span class="op">:</span>[<span class="op">^</span>\<span class="st">&quot;</span><span class="ch">\r\\</span><span class="st">]|</span><span class="ch">\\</span><span class="st">.|(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">]))*&quot;</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>)<span class="op">*</span>\<span class="op">&lt;</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)
?[ \t])<span class="op">*</span>(?<span class="op">:</span><span class="er">@</span>(?<span class="op">:</span>[<span class="op">^</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\] </span><span class="ch">\000</span><span class="st">-</span><span class="ch">\031</span><span class="st">]+(?:(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])+|\Z|(?=[\[&quot;</span>
()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\]]))|\[([^\[\]</span><span class="ch">\r\\</span><span class="st">]|</span><span class="ch">\\</span><span class="st">.)*\](?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])*)(?:\.(?:(?:</span><span class="ch">\r\n</span><span class="st">)</span>
<span class="st">?[ </span><span class="ch">\t</span><span class="st">])*(?:[^()&lt;&gt;@,;:</span><span class="ch">\\</span><span class="st">&quot;</span>.\[\] \<span class="dv">000</span><span class="op">-</span>\<span class="dv">031</span>]<span class="op">+</span>(?<span class="op">:</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">+</span><span class="er">|</span>\Z<span class="op">|</span>(?=[\[<span class="st">&quot;()&lt;&gt;</span>
<span class="st">@,;:</span><span class="ch">\\</span><span class="st">&quot;</span>.\[\]]))<span class="op">|</span>\[([<span class="op">^</span>\[\]\r\\]<span class="op">|</span>\\.)<span class="op">*</span>\](?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>))<span class="op">*</span>(?<span class="op">:</span>,<span class="op">@</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[
 \t])<span class="op">*</span>(?<span class="op">:</span>[<span class="op">^</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\] </span><span class="ch">\000</span><span class="st">-</span><span class="ch">\031</span><span class="st">]+(?:(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])+|\Z|(?=[\[&quot;</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,
;<span class="op">:</span>\\<span class="st">&quot;.\[\]]))|\[([^\[\]</span><span class="ch">\r\\</span><span class="st">]|</span><span class="ch">\\</span><span class="st">.)*\](?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])*)(?:\.(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">]</span>
<span class="st">)*(?:[^()&lt;&gt;@,;:</span><span class="ch">\\</span><span class="st">&quot;</span>.\[\] \<span class="dv">000</span><span class="op">-</span>\<span class="dv">031</span>]<span class="op">+</span>(?<span class="op">:</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">+</span><span class="er">|</span>\Z<span class="op">|</span>(?=[\[<span class="st">&quot;()&lt;&gt;@,;:</span><span class="ch">\\</span>
<span class="st">&quot;</span>.\[\]]))<span class="op">|</span>\[([<span class="op">^</span>\[\]\r\\]<span class="op">|</span>\\.)<span class="op">*</span>\](?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>))<span class="op">*</span>)<span class="op">*</span><span class="er">:</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>)?
(?<span class="op">:</span>[<span class="op">^</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\] </span><span class="ch">\000</span><span class="st">-</span><span class="ch">\031</span><span class="st">]+(?:(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])+|\Z|(?=[\[&quot;</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.</span>
<span class="st">\[\]]))|&quot;</span>(?<span class="op">:</span>[<span class="op">^</span>\<span class="st">&quot;</span><span class="ch">\r\\</span><span class="st">]|</span><span class="ch">\\</span><span class="st">.|(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">]))*&quot;</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>)(?<span class="op">:</span>\.(?<span class="op">:</span>(?<span class="op">:</span>
\r\n)?[ \t])<span class="op">*</span>(?<span class="op">:</span>[<span class="op">^</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\] </span><span class="ch">\000</span><span class="st">-</span><span class="ch">\031</span><span class="st">]+(?:(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])+|\Z|(?=[\[</span>
<span class="st">&quot;</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\]]))|&quot;</span>(?<span class="op">:</span>[<span class="op">^</span>\<span class="st">&quot;</span><span class="ch">\r\\</span><span class="st">]|</span><span class="ch">\\</span><span class="st">.|(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">]))*&quot;</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])
<span class="op">*</span>))<span class="op">*</span><span class="er">@</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>(?<span class="op">:</span>[<span class="op">^</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\] </span><span class="ch">\000</span><span class="st">-</span><span class="ch">\031</span><span class="st">]+(?:(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])</span>
<span class="st">+|\Z|(?=[\[&quot;</span>()<span class="op">&lt;</span><span class="er">&gt;@</span>,;<span class="op">:</span>\\<span class="st">&quot;.\[\]]))|\[([^\[\]</span><span class="ch">\r\\</span><span class="st">]|</span><span class="ch">\\</span><span class="st">.)*\](?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])*)(?:\</span>
<span class="st">.(?:(?:</span><span class="ch">\r\n</span><span class="st">)?[ </span><span class="ch">\t</span><span class="st">])*(?:[^()&lt;&gt;@,;:</span><span class="ch">\\</span><span class="st">&quot;</span>.\[\] \<span class="dv">000</span><span class="op">-</span>\<span class="dv">031</span>]<span class="op">+</span>(?<span class="op">:</span>(?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">+</span><span class="er">|</span>\Z
<span class="op">|</span>(?=[\[<span class="st">&quot;()&lt;&gt;@,;:</span><span class="ch">\\</span><span class="st">&quot;</span>.\[\]]))<span class="op">|</span>\[([<span class="op">^</span>\[\]\r\\]<span class="op">|</span>\\.)<span class="op">*</span>\](?<span class="op">:</span>(?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>))<span class="op">*</span>\<span class="op">&gt;</span>(?<span class="op">:</span>(
?<span class="op">:</span>\r\n)?[ \t])<span class="op">*</span>))<span class="op">*</span>)?;\s<span class="op">*</span>)<span class="st">&quot;</span></code></pre></div>
<p>Обычно работа с текстовыми данными сводится к нескольким отдельным операциям. Например, нужно вытащить из HTML-файла все теги или наоборот избавиться от них. Для этого, конечно, есть специальные пакеты, например, <code>rvest</code>. Сделать <em>токенизацию</em>, то есть разбить текст на токены - значимые единицы текста (обычно слова) - пакет <code>tidytext</code>. Обычно затем нужно перевести эти слова в неопределенную форму (лемматизация) или отбросить окончания (стеммизация) - см. пакет <code>SnowballC</code>.</p>
<p>Есть удобные инструменты, которые все это делают сразу. Например, пакет <code>udpipe</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;udpipe&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(udpipe)</code></pre></div>
<p>Для примера возьмем одну песню Дэвида Боуи:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">heroes &lt;-<span class="st"> </span>b[<span class="kw">grep</span>(<span class="st">&quot;Heroes&quot;</span>,song_name)[<span class="dv">1</span>],lyrics]
tok_heroes &lt;-<span class="st"> </span><span class="kw">udpipe</span>(heroes, <span class="st">&quot;english&quot;</span>)
<span class="kw">head</span>(tok_heroes)</code></pre></div>
<pre><code>##   doc_id paragraph_id sentence_id          sentence start end term_id
## 1   doc1            1           1 I, I will be king     1   1       1
## 2   doc1            1           1 I, I will be king     2   2       2
## 3   doc1            1           1 I, I will be king     4   4       3
## 4   doc1            1           1 I, I will be king     6   9       4
## 5   doc1            1           1 I, I will be king    11  12       5
## 6   doc1            1           1 I, I will be king    14  17       6
##   token_id token lemma  upos xpos
## 1        1     I     I  PRON  PRP
## 2        2     ,     , PUNCT    ,
## 3        3     I     I  PRON  PRP
## 4        4  will  will   AUX   MD
## 5        5    be    be   AUX   VB
## 6        6  king  king  NOUN   NN
##                                        feats head_token_id dep_rel deps
## 1 Case=Nom|Number=Sing|Person=1|PronType=Prs             6   nsubj &lt;NA&gt;
## 2                                       &lt;NA&gt;             6   punct &lt;NA&gt;
## 3 Case=Nom|Number=Sing|Person=1|PronType=Prs             6   nsubj &lt;NA&gt;
## 4                               VerbForm=Fin             6     aux &lt;NA&gt;
## 5                               VerbForm=Inf             6     cop &lt;NA&gt;
## 6                                Number=Sing             0    root &lt;NA&gt;
##            misc
## 1 SpaceAfter=No
## 2          &lt;NA&gt;
## 3          &lt;NA&gt;
## 4          &lt;NA&gt;
## 5          &lt;NA&gt;
## 6          &lt;NA&gt;</code></pre>
<p>В результате мы имеем очень длинный датафрейм, каждая строчка которого - это слово или знак препинания. Выглядит не очень симпатично (на первый взгляд), но с этим очень удобно работать. Например, с помощью функции <code>merge()</code> можно присоединить к словам сентимент-словарь и сделать сентимент анализ песен Дэвида Боуи. Можно посчитать частотность слов в его песнях. Или же исследовать их сочетание - и сделать топик моделлинг. Освоив базовый инструментарий работы с текстом, перед Вами открывается увлекательный мир анализа естественного языка!</p>
</div>
<div id="fuzzy" class="section level2">
<h2><span class="header-section-number">4.5</span> Fuzzy matching</h2>
<p>Часто бывает, что два <code>character</code> значения совпадают не полностью. Например, в одном случае слово написано в единственном числе, а в другом - во множественном. Или того хуже - в одном случае слово написано с ошибкой. Такие ситуации особенно часто возникают при соединении несколько баз вместе или же когда данные вводятся вручную. Например, представим, что мы опросили людей, кто их любимый актер. Но вот незадача: некоторые написали имя любимого актера с ошибкой!</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">actors &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Benedict Cumberbatch&quot;</span>, <span class="st">&quot;Bandersnatch Cummerbund&quot;</span>, <span class="st">&quot;Bendenswitch Cumbersquash&quot;</span>, <span class="st">&quot;Bennendim Cumbendatch&quot;</span>, <span class="st">&quot;Bendandsnap Cucumbersnatch&quot;</span>, <span class="st">&quot;Kevin Smith&quot;</span>, <span class="st">&quot;Emma Stone&quot;</span>, <span class="st">&quot;Martin Freeman&quot;</span>)</code></pre></div>
<p>В этой ситуации нам поможет fuzzy matching - примерное (approximate) сопоставление с паттерном. Как же измеряется эта “примерная похожесть”? О, как и всегда в таких случаях, за этим стоит целая наука. Самая распространенный способ посчитать похожесть, точнее, непохожесть - это расстояние Левенштайна. Это количество операций, которые нужно сделать, чтобы получить из одной строки другую. Вот список допустимых операций:</p>
<ul>
<li>вставка ab → aNb</li>
<li>удаление aOb → ab</li>
<li>замена символа aOb → aNb</li>
<li>перестановка символов ab → ba</li>
</ul>
<p>Для работы с расстояниями есть встроенная в R функция <code>agrepl()</code>. Однако она дает довольно ограниченные возможности, поэтому мы воспользуемся пакетом <code>stringdist</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;stringdist&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(stringdist)</code></pre></div>
<p>Можно посчитать расстояние Левенштайна с помощью функции <code>stringdist()</code>, можно преобразовать расстояния в меры близости с помощью функции <code>stringsim()</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">stringdist</span>(<span class="st">&quot;Benedict Cumberbatch&quot;</span>, actors)</code></pre></div>
<pre><code>## [1]  0 13 11  6 11 14 18 16</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">stringsim</span>(<span class="st">&quot;Benedict Cumberbatch&quot;</span>, actors)</code></pre></div>
<pre><code>## [1] 1.0000000 0.4347826 0.5600000 0.7142857 0.5769231 0.3000000 0.1000000
## [8] 0.2000000</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">actors[<span class="kw">stringsim</span>(<span class="st">&quot;Benedict Cumberbatch&quot;</span>, actors)<span class="op">&gt;</span><span class="fl">0.4</span>]</code></pre></div>
<pre><code>## [1] &quot;Benedict Cumberbatch&quot;       &quot;Bandersnatch Cummerbund&quot;   
## [3] &quot;Bendenswitch Cumbersquash&quot;  &quot;Bennendim Cumbendatch&quot;     
## [5] &quot;Bendandsnap Cucumbersnatch&quot;</code></pre>
<p><strong>Самостоятельное задание:</strong></p>
<ol style="list-style-type: decimal">
<li>Найдите в скольки процентах песен Боуи использует слово “star” (в том числе и как часть слова).</li>
</ol>
<pre><code>## [1] 16.94402</code></pre>
<p>Ого, как много! 2. А теперь найдите все упоминания “star”, в том числе и как часть слова, в песнях Боуи. Посчитайте частоту встречаемости каждого из них.</p>
<pre><code>## 
## blackstar  filmstar  gangstar   popstar  pornstar      star  stardust 
##        19         1         3         1         1        97         5 
##     stare    stared    stares   starman  starring     stars     start 
##        30         4         5         5         2        65        18 
##   started  starting    starts    starve  starving superstar 
##        10         1         2         3         3         4</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>Найдите все варианты песни <code>&quot;Space Oddity&quot;</code> по данной версии с помощью fuzzy matching:</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">space &lt;-<span class="st"> </span>b[<span class="kw">grep</span>(<span class="st">&quot;Space Oddity&quot;</span>, song_name)[<span class="dv">1</span>], lyrics]</code></pre></div>
<p><img src="sirius_advanced_files/figure-html/unnamed-chunk-156-1.png" width="672" /></p>
<pre><code>##    song_id
## 1:  112817
## 2: 4664522
## 3: 4216423
## 4: 4216422
## 5: 4178279
## 6: 4133059
## 7: 4178522
##                                                                     song_name
## 1:                                                               Space Oddity
## 2: Space Oddity (Clareville Grove Demo) [2019 Remaster] (Ft. John Hutchinson)
## 3:                                   Space Oddity (demo - alternative lyrics)
## 4:                                                Space Oddity (demo excerpt)
## 5:                                                   Space Oddity (Live 1972)
## 6:                                                   Space Oddity (Live 1973)
## 7:                                                    Space Oddity (Live &#39;74)
##                                                                           song_lyrics_url
## 1:                                     https://genius.com/David-bowie-space-oddity-lyrics
## 2: https://genius.com/David-bowie-space-oddity-clareville-grove-demo-2019-remaster-lyrics
## 3:             https://genius.com/David-bowie-space-oddity-demo-alternative-lyrics-lyrics
## 4:                        https://genius.com/David-bowie-space-oddity-demo-excerpt-lyrics
## 5:                           https://genius.com/David-bowie-space-oddity-live-1972-lyrics
## 6:                           https://genius.com/David-bowie-space-oddity-live-1973-lyrics
## 7:                             https://genius.com/David-bowie-space-oddity-live-74-lyrics
##    annotation_count artist_id artist_name
## 1:               25      9534 David Bowie
## 2:                0      9534 David Bowie
## 3:                0      9534 David Bowie
## 4:                0      9534 David Bowie
## 5:                0      9534 David Bowie
## 6:                0      9534 David Bowie
## 7:                0      9534 David Bowie
##                                artist_url
## 1: https://genius.com/artists/David-bowie
## 2: https://genius.com/artists/David-bowie
## 3: https://genius.com/artists/David-bowie
## 4: https://genius.com/artists/David-bowie
## 5: https://genius.com/artists/David-bowie
## 6: https://genius.com/artists/David-bowie
## 7: https://genius.com/artists/David-bowie
##                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      lyrics
## 1:                                                                                                                                Ground Control to Major Tom Ground Control to Major Tom Take your protein pills and put your helmet on (Ten) Ground Control (Nine) to Major Tom (Eight, seven) (Six) Commencing (Five) countdown, engines on (Four, three, two) Check ignition (One) and may God&#39;s love (Lift off) be with you This is Ground Control to Major Tom You&#39;ve really made the grade And the papers want to know whose shirt you wear Now it&#39;s time to leave the capsule if you dare This is Major Tom to Ground Control I&#39;m stepping through the door And I&#39;m floating in a most peculiar way And the stars look very different today For here am I sitting in a tin can Far above the world Planet Earth is blue And there&#39;s nothing I can do Though I&#39;m past 100,000 miles I&#39;m feeling very still And I think my spaceship knows which way to go Tell my wife I love her very much She knows Ground Control to Major Tom Your circuit&#39;s dead, there&#39;s something wrong Can you hear me, Major Tom? Can you hear me, Major Tom? Can you hear me, Major Tom? Can you Here am I floating &#39;round my tin can Far above the moon Planet Earth is blue And there&#39;s nothing I can do
## 2:                                                                                                                                Ground Control to Major Tom Ground Control to Major Tom Take your protein pills And put your helmet on (Ten) Ground Control (Nine) to Major Tom (Eight) (Seven, six) Commencing (Five) countdown Engines on (Four, three, two) Check ignition (One) And may God&#39;s love (Blast off) be with you This is Ground Control to Major Tom You&#39;ve really made the grade And the papers want to know whose shirt you wear Now it&#39;s time to leave the capsule if you dare This is Major Tom to Ground Control I&#39;m stepping through the door And I&#39;m floating in a most peculiar way And the stars look very different today For here am I sitting in a tin can Far above the world Planet Earth is blue And there&#39;s nothing I can do Though I&#39;m past 100,000 miles I&#39;m feeling very still And I think my spaceship knows which way to go Tell my wife I love her very much She knows Ground Control to Major Tom Your circuit&#39;s dead, there&#39;s something wrong Can you hear me, Major Tom? Can you hear me, Major Tom? Can you hear me, Major Tom? Can you Here am I floating &#39;round my tin can Far above the moon Planet Earth is blue And there&#39;s nothing I can do
## 3:                                                                                                                                                                          John Hutchinson: Nice, nice David Bowie: Didn’t sound nice to me. Let’s remember to do that. Ok, Hutch (Begins playing) DB: Ope, hun. Yeah? JH: What a single! DB: We’re recording, now. Wait, Christie, don’t talk Ground Control to Major Tom Ground Control to Major Tom Take your protein pills And put your helmet on (10) Ground Control (Nine) to Major Tom (Eight) (Seven, six) Commencing (Five) countdown Engines on (Four, three, two) Check ignition (One) And may God&#39;s love (Blast off) be with you This is Major Tom to Ground Control I&#39;m feeling very still And I think my spaceship knows which way to go Tell my wife I love her very much She knows Though I&#39;m passed 100,000 miles I&#39;m feeling very still And I think my spaceship know what I must do And I think my life on earth is never trough Ground Control to Major Tom You&#39;re off your course, direction&#39;s wrong Can you hear me, Major Tom? Can you hear me, Major Tom? Can you hear me, Major Tom? Can you heee... ...eeere am I sitting in a tin can Far above the Moon The planet Earth is blue And there&#39;s nothing I can do…
## 4:                                                                                                                                                                                                                                                                                                                                                                                                     This is Major Tom to Ground Control, I’m stepping through the door And I’m floating in the most peculiar way Can I please get back inside now, if I may? For here am I floating ‘round my tin can Far above the world Planet earth is blue, and there’s nothing I can do This is Major Tom to Ground Control, I’m feeling very still And I think my spaceship knows which way to go Tell my wife I love her very much, she knows Though I’m past one hundred thousand miles, I’m feeling very still And I think my spaceship knows what i must do And I think my life on earth is nearly through Ground Control to Major Tom, you’re off your course Direction’s wrong Can you hear me, Major Tom? Can you hear me, Major Tom? Can you hear me, Major Tom? Can you- Here am I sitting in a tin can Far above the moon Planet earth is blue and there’s nothing I can do Do, do do do
## 5: Ground Control to Major Tom Ground Control to Major Tom Take your protein pills And put your helmet on (10) Ground Control (9) to Major Tom (8) (7, 6) Commencing (5) countdown Engines on (4, 3, 2) Check ignition (1) And may God&#39;s love (Liftoff) be with you Ahhh... This is Ground Control to Major Tom You’ve really made the grade And the papers want to know whose shirt you wear Now it&#39;s time to leave the capsule if you dare This is Major Tom to Ground Control I&#39;m stepping through the door And I’m floating in a most peculiar way And the stars look very different today For here am I sitting in a tin can Far above the world Planet Earth is blue And there&#39;s nothing I can do Though I&#39;m past one hundred thousand miles I&#39;m feeling very still And I think my spaceship knows which way to go Tell my wife I love her very much She knows Ground Control to Major Tom Your circuit&#39;s dead, there&#39;s something wrong Can you hear me, Major Tom? Can you hear me, Major Tom? Can you hear me, Major Tom? Can you- Here am I floating &#39;round my tin can Far above the moon Planet Earth is blue And there&#39;s nothing I can do Ohhh Duh-duh-duh-duh-duh-duh-duh-duh-duh-duh Cha-cha-cha-cha-cha-cha-cha-cha-cha-cha Cha-cha-cha-cha-cha-cha-cha-cha-cha-cha Thank You
## 6:                                                                                                                                                                                 Ground Control to Major Tom Ground Control to Major Tom Take your protein pills And put your helmet on Ground Control to Major Tom Commencing countdown Engines on Check ignition And may God&#39;s love be with you This is Ground Control to Major Tom You’ve really made the grade And the papers want to know who&#39;s shirt you wear Now it&#39;s time to leave the capsule if you dare This is Major Tom to Ground Control I’m stepping through the door And I&#39;m floating in a most peculiar way Now the stars look very different today For here am I sitting in my tin can Far above the world Planet Earth is blue And there&#39;s nothing I can do Though I&#39;m past one hundred thousand miles I&#39;m feeling very still And I think my spaceship knows which way to go Tell my wife I love her very much She knows Ground Control to Major Tom Your circuit&#39;s dead, there&#39;s something wrong Can you hear me, Major Tom? Can you hear me, Major Tom? Can you hear me, Major Tom? Can you Here am I floating &#39;round my tin can Far above the moon Planet Earth is blue And there’s nothing I can do Shhh... Shh...
## 7:                                                                                                                                                                                                 Ground Control to Major Tom Ground Control to Major Tom Take your protein pills And put your helmet on Ground Control to Major Tom Commencing countdown Engines on Check ignition And may God&#39;s love be with you This is Ground Control to Major Tom You&#39;ve really made the grade And the papers want to know whose shirt you wear Now it&#39;s time to leave the capsule if you dare This is Major Tom to Ground Control I&#39;m stepping through the door And I&#39;m floating in a most peculiar way And the stars look very different today For here am I sitting in a tin can Far above the world Planet Earth is blue And there&#39;s nothing I can do Though I&#39;m past one hundred thousand miles I&#39;m feeling very still And I think my spaceship knows which way to go Tell my wife I love her very much She knows Ground Control to Major Tom Your circuit&#39;s dead, there&#39;s something wrong Can you hear me, Major Tom? Can you hear me, Major Tom? Can you hear me, Major Tom? Can you Here am I floating &#39;round my tin can Far above the moon Planet Earth is blue And there&#39;s nothing I can do
##    n_letters song_name_trunc
## 1:      1113    Space Oddity
## 2:      1113 Space Oddity...
## 3:      1071 Space Oddity...
## 4:       852 Space Oddity...
## 5:      1240 Space Oddity...
## 6:      1064 Space Oddity...
## 7:      1048 Space Oddity...
##                                                                 song_name_pad
## 1:                                                               Space Oddity
## 2: Space Oddity (Clareville Grove Demo) [2019 Remaster] (Ft. John Hutchinson)
## 3:                                   Space Oddity (demo - alternative lyrics)
## 4:                                                Space Oddity (demo excerpt)
## 5:                                                   Space Oddity (Live 1972)
## 6:                                                   Space Oddity (Live 1973)
## 7:                                                    Space Oddity (Live &#39;74)
##                                                             song_name_trimmed
## 1:                                                               Space Oddity
## 2: Space Oddity (Clareville Grove Demo) [2019 Remaster] (Ft. John Hutchinson)
## 3:                                   Space Oddity (demo - alternative lyrics)
## 4:                                                Space Oddity (demo excerpt)
## 5:                                                   Space Oddity (Live 1972)
## 6:                                                   Space Oddity (Live 1973)
## 7:                                                    Space Oddity (Live &#39;74)
##          sim
## 1: 1.0000000
## 2: 0.9874214
## 3: 0.4294699
## 4: 0.4618149
## 5: 0.8282258
## 6: 0.8867925
## 7: 0.9092543</code></pre>
<!--chapter:end:03-Week2Day3_text.Rmd-->
</div>
</div>
<div id="d4" class="section level1">
<h1><span class="header-section-number">5</span> Неделя 2, День 4</h1>
<div id="multi" class="section level2">
<h2><span class="header-section-number">5.1</span> Многомерные методы анализа данных</h2>
<p>Сегодняшнее занятие будет посвящено многомерным методам анализа данных - методам работы с данными, в которых много переменных, т.е. колонок. Мы уже сталкивались с некоторыми многомерными методами, такими как множественная линейная регрессия. Поэтому вы знаете, что многомерность создает новые проблемы. Например, при множественных корреляциях или попарных сравнениях возникает проблема множественных сравнений, а при использовании множественной регрессии лишние предикторы могут ловить только шум и приводить к переобучению (если говорить в терминах машинного обучения). Короче говоря, больше - не значит лучше. Нужно четко понимать, зачем мы используем данные и что пытаемся измерить.</p>
<p>Однако в некоторых случаях мы в принципе не можем ничего интересного сделать с маленьким набором переменных. Много ли мы можем измерить личностным тестом с одним единственным вопросом? Можем ли мы точно оценить уровень интеллекта по успешности выполнения одного единственного задания? Очевидно, что нет. Более того, даже концепция интеллекта в современном его представлении появилась во многом благодаря разработке многомерных методов анализа! Ну или наоборот: исследования интеллекта подстегнули развитие многомерных методов.</p>
<p>Наши данные как раз очень многомерные. Это данные опроса с использованием очень большого количества вопросов. Мы возьмем только колонки, содержащие в названии “Op” - это ответы на всякие мировоззренческие вопросы, а это значит, что на них нет правильного ответа, а разные люди будут отвечать по-разному. Эти вопросы связаны с отношением к науке и технологиям, к “научному мировоззрению”. Например, “Scientific development is essential for improving people’s lives” и “Consuming genetically modified (GMO) food is perfectly safe”. Очевидно, что ответы на все эти вопросы будут как-то скоррелированы (положительно или отрицательно). С помощью таких методов как анализ главных компонент и факторный анализ можно уменьшить количество переменных и попытаться понять, что стоит на паттерном различий в ответах респондентов.</p>
<p><strong>Самостоятельное задание:</strong></p>
<ol style="list-style-type: decimal">
<li>Сделайте data.table opinion, в котором будут только колонки с <code>&quot;OP&quot;</code> или <code>&quot;Op&quot;</code> в названии.</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(data.table)
data &lt;-<span class="st"> </span><span class="kw">fread</span>(<span class="st">&quot;data/iGLAS for R course.csv&quot;</span>)</code></pre></div>
<p>Для этого можно воспользоваться регулярными выражениями!</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">op &lt;-<span class="st"> </span><span class="kw">grep</span>(<span class="st">&quot;iO[pP]&quot;</span>, <span class="kw">names</span>(data), <span class="dt">value =</span> <span class="ot">TRUE</span>)
opinion &lt;-<span class="st"> </span>data[, ..op]</code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Удалите все колонки, где слишком много NA, потом удалите строчки с NA:</li>
</ol>
<p>Разобьем задачу на части: сначала создадим функцию, которая считает частоту NA в колонке:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">frac_na &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="kw">mean</span>(<span class="kw">is.na</span>(x))</code></pre></div>
<p>Потом применим эту фунцкию, чтобы выделить названия колонок, в которых NA меньше половины:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">not_na_op &lt;-<span class="st"> </span><span class="kw">sapply</span>(opinion, frac_na) <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.5</span> 
opinion &lt;-<span class="st"> </span>opinion[, ..not_na_op]</code></pre></div>
<p>Осталось удалить относительно небольшое количество строчек с NA:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">opinion &lt;-<span class="st"> </span>opinion[<span class="kw">complete.cases</span>(opinion),]</code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Посчитайте матрицу корреляций opinion:</li>
</ol>
<p>Напоминаю, что это можно сделать несколькими способами. Конечно, можно просто коррелировать каждую пару переменных с каждой:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">opinion[, <span class="kw">cor.test</span>(iOp01, iOp03)]</code></pre></div>
<pre><code>## 
##  Pearson&#39;s product-moment correlation
## 
## data:  iOp01 and iOp03
## t = 4.3619, df = 4981, p-value = 1.316e-05
## alternative hypothesis: true correlation is not equal to 0
## 95 percent confidence interval:
##  0.03397746 0.08929939
## sample estimates:
##        cor 
## 0.06168581</code></pre>
<p>Из этих данных можно доставать значений корреляций - и так повторить для каждой пары переменных. Это не очень удобно. Можно сделать проще - с помощью функции <code>cor()</code> посчитать всю матрицу корреляций.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">opinion_cor &lt;-<span class="st"> </span><span class="kw">cor</span>(opinion)
opinion_cor</code></pre></div>
<pre><code>##                iOp01       iOp03       iOp04       iOp10        iOp11
## iOp01    1.000000000  0.06168581 -0.09790765  0.09710549 -0.005725227
## iOp03    0.061685805  1.00000000 -0.11774907  0.38227617 -0.125308613
## iOp04   -0.097907651 -0.11774907  1.00000000 -0.30967796  0.265454316
## iOp10    0.097105491  0.38227617 -0.30967796  1.00000000 -0.237845009
## iOp11   -0.005725227 -0.12530861  0.26545432 -0.23784501  1.000000000
## iOp02.5 -0.032672387 -0.10008960  0.30204766 -0.22103331  0.211416777
## iOp42    0.181658491  0.04159865  0.04141262 -0.03209103  0.082770905
## iOp43   -0.003794763 -0.02254635  0.12403584 -0.05257601  0.132697538
## iOp46    0.052547325  0.17397235 -0.14585023  0.22097407 -0.086064297
## iOp45    0.134881909  0.14934259 -0.41026076  0.28213000 -0.192350246
## iOP13.5 -0.040780421 -0.19078695  0.32713384 -0.29964666  0.215998965
## iOp44    0.004436168  0.03011891  0.07615861 -0.04030566  0.113388468
## iOp07.5  0.027425667 -0.07286297  0.18466025 -0.15426662  0.259294932
## iOp47   -0.012785049 -0.07423265  0.33009538 -0.27045062  0.312349968
## iOP12.5  0.168927842  0.12041632 -0.08985733  0.14446427 -0.068279608
##             iOp02.5        iOp42        iOp43       iOp46        iOp45
## iOp01   -0.03267239  0.181658491 -0.003794763  0.05254732  0.134881909
## iOp03   -0.10008960  0.041598655 -0.022546352  0.17397235  0.149342590
## iOp04    0.30204766  0.041412616  0.124035835 -0.14585023 -0.410260758
## iOp10   -0.22103331 -0.032091028 -0.052576008  0.22097407  0.282129998
## iOp11    0.21141678  0.082770905  0.132697538 -0.08606430 -0.192350246
## iOp02.5  1.00000000  0.136295690  0.124001544 -0.15602734 -0.209353362
## iOp42    0.13629569  1.000000000  0.232244315 -0.03223088 -0.006915756
## iOp43    0.12400154  0.232244315  1.000000000 -0.05692068 -0.047643316
## iOp46   -0.15602734 -0.032230885 -0.056920680  1.00000000  0.173623846
## iOp45   -0.20935336 -0.006915756 -0.047643316  0.17362385  1.000000000
## iOP13.5  0.39518963  0.134509434  0.098597768 -0.15017812 -0.214800604
## iOp44    0.07653149  0.099007929  0.108009257 -0.03229476 -0.046154797
## iOp07.5  0.23017497  0.207500065  0.248239874 -0.10794585 -0.083293739
## iOp47    0.25021173  0.161576936  0.113803852 -0.10644965 -0.241338330
## iOP12.5 -0.07638594  0.094466167 -0.032880878  0.14201499  0.093801862
##             iOP13.5        iOp44     iOp07.5        iOp47      iOP12.5
## iOp01   -0.04078042  0.004436168  0.02742567 -0.012785049  0.168927842
## iOp03   -0.19078695  0.030118914 -0.07286297 -0.074232647  0.120416318
## iOp04    0.32713384  0.076158609  0.18466025  0.330095376 -0.089857326
## iOp10   -0.29964666 -0.040305663 -0.15426662 -0.270450622  0.144464274
## iOp11    0.21599896  0.113388468  0.25929493  0.312349968 -0.068279608
## iOp02.5  0.39518963  0.076531485  0.23017497  0.250211729 -0.076385936
## iOp42    0.13450943  0.099007929  0.20750007  0.161576936  0.094466167
## iOp43    0.09859777  0.108009257  0.24823987  0.113803852 -0.032880878
## iOp46   -0.15017812 -0.032294760 -0.10794585 -0.106449653  0.142014989
## iOp45   -0.21480060 -0.046154797 -0.08329374 -0.241338330  0.093801862
## iOP13.5  1.00000000  0.100923055  0.21146886  0.315878637 -0.063165249
## iOp44    0.10092306  1.000000000  0.10301330  0.103123900 -0.014437449
## iOp07.5  0.21146886  0.103013296  1.00000000  0.296110105 -0.008059640
## iOp47    0.31587864  0.103123900  0.29611011  1.000000000  0.005139235
## iOP12.5 -0.06316525 -0.014437449 -0.00805964  0.005139235  1.000000000</code></pre>
<p>Ну а можно воспользоваться пакетом <code>&quot;psych&quot;</code>, который создаст специальный объект классов <code>&quot;psych&quot;</code> и <code>&quot;corr.test&quot;</code>. Внутри этого объекта будут и матрица корреляций и матрица p-values.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(psych)
opinion_corr &lt;-<span class="st"> </span><span class="kw">corr.test</span>(opinion)
<span class="kw">class</span>(opinion_corr)</code></pre></div>
<pre><code>## [1] &quot;psych&quot;     &quot;corr.test&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">class</span>(opinion_corr<span class="op">$</span>r)</code></pre></div>
<pre><code>## [1] &quot;matrix&quot;</code></pre>
<p>Если Вы решите проверить, совпадают ли результаты этих двух способов, то увидите, что, внезапно, нет:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">opinion_corr<span class="op">$</span>r <span class="op">==</span><span class="st"> </span>opinion_cor</code></pre></div>
<pre><code>##         iOp01 iOp03 iOp04 iOp10 iOp11 iOp02.5 iOp42 iOp43 iOp46 iOp45
## iOp01    TRUE FALSE  TRUE  TRUE  TRUE    TRUE  TRUE  TRUE FALSE FALSE
## iOp03   FALSE  TRUE FALSE  TRUE  TRUE   FALSE  TRUE FALSE  TRUE FALSE
## iOp04    TRUE FALSE  TRUE FALSE FALSE   FALSE  TRUE FALSE  TRUE FALSE
## iOp10    TRUE  TRUE FALSE  TRUE FALSE   FALSE FALSE FALSE FALSE  TRUE
## iOp11    TRUE  TRUE FALSE FALSE  TRUE   FALSE  TRUE FALSE FALSE  TRUE
## iOp02.5  TRUE FALSE FALSE FALSE FALSE    TRUE FALSE FALSE  TRUE  TRUE
## iOp42    TRUE  TRUE  TRUE FALSE  TRUE   FALSE  TRUE  TRUE FALSE  TRUE
## iOp43    TRUE FALSE FALSE FALSE FALSE   FALSE  TRUE  TRUE  TRUE  TRUE
## iOp46   FALSE  TRUE  TRUE FALSE FALSE    TRUE FALSE  TRUE  TRUE FALSE
## iOp45   FALSE FALSE FALSE  TRUE  TRUE    TRUE  TRUE  TRUE FALSE  TRUE
## iOP13.5 FALSE  TRUE FALSE  TRUE  TRUE   FALSE  TRUE FALSE  TRUE  TRUE
## iOp44    TRUE FALSE  TRUE FALSE FALSE   FALSE  TRUE FALSE  TRUE FALSE
## iOp07.5  TRUE FALSE FALSE FALSE  TRUE    TRUE FALSE FALSE  TRUE  TRUE
## iOp47   FALSE  TRUE  TRUE FALSE  TRUE   FALSE  TRUE FALSE  TRUE  TRUE
## iOP12.5 FALSE FALSE FALSE FALSE FALSE    TRUE FALSE  TRUE  TRUE FALSE
##         iOP13.5 iOp44 iOp07.5 iOp47 iOP12.5
## iOp01     FALSE  TRUE    TRUE FALSE   FALSE
## iOp03      TRUE FALSE   FALSE  TRUE   FALSE
## iOp04     FALSE  TRUE   FALSE  TRUE   FALSE
## iOp10      TRUE FALSE   FALSE FALSE   FALSE
## iOp11      TRUE FALSE    TRUE  TRUE   FALSE
## iOp02.5   FALSE FALSE    TRUE FALSE    TRUE
## iOp42      TRUE  TRUE   FALSE  TRUE   FALSE
## iOp43     FALSE FALSE   FALSE FALSE    TRUE
## iOp46      TRUE  TRUE    TRUE  TRUE    TRUE
## iOp45      TRUE FALSE    TRUE  TRUE   FALSE
## iOP13.5    TRUE FALSE    TRUE FALSE    TRUE
## iOp44     FALSE  TRUE    TRUE FALSE   FALSE
## iOp07.5    TRUE  TRUE    TRUE  TRUE   FALSE
## iOp47     FALSE FALSE    TRUE  TRUE   FALSE
## iOP12.5    TRUE FALSE   FALSE FALSE    TRUE</code></pre>
<p>Причина в том, что дробные числа хранятся в компьютере как степени двойки с разной степенью точности - поэтому могут возникать такие вот небольшие различия. А вот если округлить, то все значения окажутся одинаковыми:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">round</span>(opinion_corr<span class="op">$</span>r,<span class="dv">2</span>) <span class="op">==</span><span class="st"> </span><span class="kw">round</span>(opinion_cor,<span class="dv">2</span>)</code></pre></div>
<pre><code>##         iOp01 iOp03 iOp04 iOp10 iOp11 iOp02.5 iOp42 iOp43 iOp46 iOp45
## iOp01    TRUE  TRUE  TRUE  TRUE  TRUE    TRUE  TRUE  TRUE  TRUE  TRUE
## iOp03    TRUE  TRUE  TRUE  TRUE  TRUE    TRUE  TRUE  TRUE  TRUE  TRUE
## iOp04    TRUE  TRUE  TRUE  TRUE  TRUE    TRUE  TRUE  TRUE  TRUE  TRUE
## iOp10    TRUE  TRUE  TRUE  TRUE  TRUE    TRUE  TRUE  TRUE  TRUE  TRUE
## iOp11    TRUE  TRUE  TRUE  TRUE  TRUE    TRUE  TRUE  TRUE  TRUE  TRUE
## iOp02.5  TRUE  TRUE  TRUE  TRUE  TRUE    TRUE  TRUE  TRUE  TRUE  TRUE
## iOp42    TRUE  TRUE  TRUE  TRUE  TRUE    TRUE  TRUE  TRUE  TRUE  TRUE
## iOp43    TRUE  TRUE  TRUE  TRUE  TRUE    TRUE  TRUE  TRUE  TRUE  TRUE
## iOp46    TRUE  TRUE  TRUE  TRUE  TRUE    TRUE  TRUE  TRUE  TRUE  TRUE
## iOp45    TRUE  TRUE  TRUE  TRUE  TRUE    TRUE  TRUE  TRUE  TRUE  TRUE
## iOP13.5  TRUE  TRUE  TRUE  TRUE  TRUE    TRUE  TRUE  TRUE  TRUE  TRUE
## iOp44    TRUE  TRUE  TRUE  TRUE  TRUE    TRUE  TRUE  TRUE  TRUE  TRUE
## iOp07.5  TRUE  TRUE  TRUE  TRUE  TRUE    TRUE  TRUE  TRUE  TRUE  TRUE
## iOp47    TRUE  TRUE  TRUE  TRUE  TRUE    TRUE  TRUE  TRUE  TRUE  TRUE
## iOP12.5  TRUE  TRUE  TRUE  TRUE  TRUE    TRUE  TRUE  TRUE  TRUE  TRUE
##         iOP13.5 iOp44 iOp07.5 iOp47 iOP12.5
## iOp01      TRUE  TRUE    TRUE  TRUE    TRUE
## iOp03      TRUE  TRUE    TRUE  TRUE    TRUE
## iOp04      TRUE  TRUE    TRUE  TRUE    TRUE
## iOp10      TRUE  TRUE    TRUE  TRUE    TRUE
## iOp11      TRUE  TRUE    TRUE  TRUE    TRUE
## iOp02.5    TRUE  TRUE    TRUE  TRUE    TRUE
## iOp42      TRUE  TRUE    TRUE  TRUE    TRUE
## iOp43      TRUE  TRUE    TRUE  TRUE    TRUE
## iOp46      TRUE  TRUE    TRUE  TRUE    TRUE
## iOp45      TRUE  TRUE    TRUE  TRUE    TRUE
## iOP13.5    TRUE  TRUE    TRUE  TRUE    TRUE
## iOp44      TRUE  TRUE    TRUE  TRUE    TRUE
## iOp07.5    TRUE  TRUE    TRUE  TRUE    TRUE
## iOp47      TRUE  TRUE    TRUE  TRUE    TRUE
## iOP12.5    TRUE  TRUE    TRUE  TRUE    TRUE</code></pre>
<p>Давайте отдельно посмотрим на матрицу p-values (в нижнем углу - сами p-values, в верхнем - с коррекцией на множество сравнений):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">round</span>(opinion_corr<span class="op">$</span>p, <span class="dv">3</span>)</code></pre></div>
<pre><code>##         iOp01 iOp03 iOp04 iOp10 iOp11 iOp02.5 iOp42 iOp43 iOp46 iOp45
## iOp01   0.000 0.000 0.000 0.000     1   0.324 0.000 1.000 0.005 0.000
## iOp03   0.000 0.000 0.000 0.000     0   0.000 0.066 1.000 0.000 0.000
## iOp04   0.000 0.000 0.000 0.000     0   0.000 0.066 0.000 0.000 0.000
## iOp10   0.000 0.000 0.000 0.000     0   0.000 0.324 0.005 0.000 0.000
## iOp11   0.686 0.000 0.000 0.000     0   0.000 0.000 0.000 0.000 0.000
## iOp02.5 0.021 0.000 0.000 0.000     0   0.000 0.000 0.000 0.000 0.000
## iOp42   0.000 0.003 0.003 0.023     0   0.000 0.000 0.000 0.324 1.000
## iOp43   0.789 0.112 0.000 0.000     0   0.000 0.000 0.000 0.001 0.017
## iOp46   0.000 0.000 0.000 0.000     0   0.000 0.023 0.000 0.000 0.000
## iOp45   0.000 0.000 0.000 0.000     0   0.000 0.626 0.001 0.000 0.000
## iOP13.5 0.004 0.000 0.000 0.000     0   0.000 0.000 0.000 0.000 0.000
## iOp44   0.754 0.033 0.000 0.004     0   0.000 0.000 0.000 0.023 0.001
## iOp07.5 0.053 0.000 0.000 0.000     0   0.000 0.000 0.000 0.000 0.000
## iOp47   0.367 0.000 0.000 0.000     0   0.000 0.000 0.000 0.000 0.000
## iOP12.5 0.000 0.000 0.000 0.000     0   0.000 0.000 0.020 0.000 0.000
##         iOP13.5 iOp44 iOp07.5 iOp47 iOP12.5
## iOp01     0.072 1.000   0.529 1.000   0.000
## iOp03     0.000 0.368   0.000 0.000   0.000
## iOp04     0.000 0.000   0.000 0.000   0.000
## iOp10     0.000 0.075   0.000 0.000   0.000
## iOp11     0.000 0.000   0.000 0.000   0.000
## iOp02.5   0.000 0.000   0.000 0.000   0.000
## iOp42     0.000 0.000   0.000 0.000   0.000
## iOp43     0.000 0.000   0.000 0.000   0.324
## iOp46     0.000 0.324   0.000 0.000   0.000
## iOp45     0.000 0.023   0.000 0.000   0.000
## iOP13.5   0.000 0.000   0.000 0.000   0.000
## iOp44     0.000 0.000   0.000 0.000   1.000
## iOp07.5   0.000 0.000   0.000 0.000   1.000
## iOp47     0.000 0.000   0.000 0.000   1.000
## iOP12.5   0.000 0.308   0.569 0.717   0.000</code></pre>
</div>
<div id="heatmap" class="section level2">
<h2><span class="header-section-number">5.2</span> Хитмап корреляций</h2>
<p>Как видите, почти все коррелирует друг с другом, даже с учетом поправок. Такие множественные корреляции лучше всего смотреть с помощью хитмап-визуализации:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;corrplot&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(corrplot)
<span class="kw">corrplot</span>(opinion_cor, <span class="dt">method =</span> <span class="st">&quot;color&quot;</span>, <span class="dt">order =</span> <span class="st">&quot;hclust&quot;</span>)</code></pre></div>
<p><img src="sirius_advanced_files/figure-html/unnamed-chunk-169-1.png" width="672" /></p>
<p>Каждый квадратик - корреляция двух колонок. Синяя - положительная корреляция, красная - отрицательная. Чем насыщеннее цвет, тем сильнее корреляция (то есть выше значение по модулю). Колонки автоматически переставляются в нужном порядке для “группировки”.</p>
<p>На картинке можно увидеть, что есть две основных группы вопросов, которые положительно коррелируют внутри группы друг с другом и отрицательно - с вопросами из другой группы.</p>
<p>Различиные многомерные методы анализа позволяют нам выйти за пределы анализа отдельных пар корреляций и попытаться понять структуру, которая стоит за этой корреляционной матрицей. Поэтому во многих многомерных методах анализа данных именно матрица корреляций выступает в роли входных данных.</p>
</div>
<div id="pca" class="section level2">
<h2><span class="header-section-number">5.3</span> Анализ главных компонент (Principal component analysis)</h2>
<p>Анализ главных компонент (АГК) известен как метод “уменьшения размерности”. Представьте, что вам дан набор данных с большим количеством количеством похожих переменных… Ох, надо же, наш датасет как раз именно такой!</p>
<p>Действительно, подобная ситуация часто возникает в опросниковых данных. Для начала представим ответы на вопросы как точки в многомерном пространстве. Ну, многомерные пространтсва представлять сложно, но вот два измерения - вполне, получится стандартная диаграмма рассеяния.</p>
<p>Суть АГК в том, чтобы повернуть оси этого пространства так, чтобы первые оси объясняли как можно больший разброс данных, а последние - как можно меньший. Тогда мы могли бы отбросить последние оси и не очень-то много и потерять в данных.</p>
<p>Для двух осей это выглядит вот так:</p>
<div class="figure">
<img src="images/q7hip.gif" />

</div>
<p>Первая ось должна минимизировать красные расстояния. Вторая ось будет просто перпендикулярна первой оси.</p>
<blockquote>
<p>Математически, АГК - это нахождение собственных векторов и собственных значений матрицы корреляций или ковариаций. Собственные вектора - это такие особенные вектора матрицы, умножив которые на данную матрицу, можно получить тот же самый вектор (т.е. того же направления), но другой длины. А вот коэффициент множителя длины нового вектора - это собственное значение. В контексте АГК, собственные вектора - это новые оси (т.е. те самые новые компоненты), а собственные значения - это размер объясняемой дисперсии с помощью новых осей.</p>
</blockquote>
<p>Итак, для начала нам нужно центрировать и нормировать данные, т.е. вычесть среднее и поделить на стандартное отклонение, т.е. посчитать z-оценки. Это нужно для того, чтобы сделать все шкалы равноценными. Это особенно важно делать когда разные шкалы используют несопоставимые единицы измерения. Скажем, одна колонка - это масса человека в килограммах, а другая - рост в метрах. Если применять АГК на этих данных, то ничего хорошего не выйдет: вклад роста будет слишком маленьким. А вот если мы сделаем z-преобразование, то приведем и вес, и рост к “общему знаменателю”.</p>
<p>В нашем случае это не так критично, поскольку во всех случаях испытуемые отвечают по одинаковой 7-балльной шкале.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">opinion_scaled &lt;-<span class="st"> </span><span class="kw">as.data.table</span>(<span class="kw">scale</span>(opinion))</code></pre></div>
<p>В базовом R уже есть инструменты для АГК <code>princomp()</code> и <code>prcomp()</code>, считают они немного по-разному. Возьмем более рекомендуемый вариант, <code>prcomp()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">prcomp</span>(opinion_scaled)</code></pre></div>
<pre><code>## Standard deviations (1, .., p=15):
##  [1] 1.7822858 1.2706276 1.0404145 1.0373031 0.9620233 0.9594423 0.9312585
##  [8] 0.9151956 0.8932286 0.8511995 0.8189853 0.8003226 0.7568713 0.7509609
## [15] 0.7274690
## 
## Rotation (n x k) = (15 x 15):
##                 PC1         PC2         PC3           PC4         PC5
## iOp01   -0.06943778  0.38155798 -0.19427723  0.4915882664  0.19803386
## iOp03   -0.20562301  0.30500547  0.47716338 -0.2907785685 -0.20900299
## iOp04    0.36177159 -0.08071718  0.34244974 -0.0003028303 -0.11323021
## iOp10   -0.34078095  0.23989272  0.19732683 -0.2139680548 -0.17104896
## iOp11    0.29931733  0.09490561  0.09826912 -0.0213681852  0.23233088
## iOp02.5  0.32443413  0.07300092  0.07894631  0.0320344221 -0.22999432
## iOp42    0.12845659  0.48677246 -0.23754435  0.0526953352 -0.14183215
## iOp43    0.16507540  0.31259574 -0.28949688 -0.4294394393 -0.28394314
## iOp46   -0.20512296  0.17552225  0.40029547  0.0300032371  0.04153754
## iOp45   -0.29856014  0.20970290 -0.31605182 -0.0187235987  0.07757389
## iOP13.5  0.35202797  0.02718279  0.05356841  0.1507532470 -0.03959969
## iOp44    0.11226061  0.20192394  0.07709088 -0.4107140003  0.80179338
## iOp07.5  0.26953643  0.30979313 -0.15452816 -0.1165836764 -0.10753154
## iOp47    0.33900566  0.15729302  0.24253529  0.1122834985  0.03911805
## iOP12.5 -0.10942316  0.33363638  0.26570013  0.4695379747  0.04614479
##                 PC6          PC7         PC8          PC9         PC10
## iOp01   -0.15062622  0.086873091 -0.36382134  0.434219525 -0.294884944
## iOp03   -0.23181854  0.028323653 -0.34924941 -0.041639577  0.099043057
## iOp04   -0.05029616  0.211504124  0.01004747  0.199516759 -0.159180605
## iOp10   -0.13095970 -0.053855368 -0.17025640 -0.051893607 -0.186371938
## iOp11    0.46069587 -0.051935276 -0.38659529  0.074794408 -0.174518794
## iOp02.5 -0.36039154 -0.451433548  0.02531913  0.005203201 -0.301394416
## iOp42   -0.19693292  0.151161377  0.15029456  0.208217043  0.586642570
## iOp43    0.18770535  0.248241667  0.31276168  0.154365239 -0.362684643
## iOp46    0.44736652 -0.352974058  0.39556974  0.473486940  0.079459941
## iOp45    0.11041482 -0.512305517 -0.04298693 -0.213770985  0.023419463
## iOP13.5 -0.26367332 -0.425241487  0.20911238 -0.010784156 -0.004230272
## iOp44   -0.28023510  0.019551048  0.17605295 -0.045507654 -0.042046820
## iOp07.5  0.30741820 -0.121070383 -0.17902370 -0.366582757 -0.039498614
## iOp47    0.17602641  0.006911587 -0.16548973 -0.174333373  0.417089629
## iOP12.5  0.04333967  0.264739933  0.39189684 -0.507508839 -0.249004492
##                 PC11        PC12         PC13        PC14        PC15
## iOp01    0.268041765 -0.10759740 -0.017454400  0.05583458 -0.07759637
## iOp03   -0.028268175 -0.14763906 -0.207863748 -0.27700923 -0.42210555
## iOp04    0.189110923 -0.09478334 -0.006973371 -0.52100969  0.55114105
## iOp10   -0.047812745  0.09035923  0.551647315  0.34238261  0.44032361
## iOp11   -0.639556895  0.07498348  0.119986008 -0.07704203 -0.04334111
## iOp02.5 -0.162737844  0.26521465 -0.464150949  0.28093279  0.11355379
## iOp42   -0.293136056  0.26303996  0.050047991 -0.12403748  0.14999167
## iOp43   -0.029759426 -0.37536418 -0.058696637  0.13243197 -0.11563024
## iOp46    0.156393341  0.14514663 -0.053539827  0.04183396 -0.04903883
## iOp45   -0.074520395 -0.37759488 -0.197166575 -0.35794150  0.35036950
## iOP13.5 -0.008700931 -0.29354808  0.586329244 -0.15432949 -0.31640366
## iOp44    0.088893908  0.05750762 -0.038890456  0.02630346  0.04428991
## iOp07.5  0.516696787  0.44286099  0.106674560 -0.14620017 -0.09660579
## iOp47    0.174231721 -0.46253063 -0.123396692  0.48427005  0.17481876
## iOP12.5 -0.177910829  0.01561185 -0.051961030 -0.05844298 -0.01982064</code></pre>
<p>В принципе, z-преобразование было делать необязательно, <code>prcomp()</code> умеет делать это сам:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pr &lt;-<span class="st"> </span><span class="kw">prcomp</span>(opinion, <span class="dt">scale. =</span> <span class="ot">TRUE</span>)
pr</code></pre></div>
<pre><code>## Standard deviations (1, .., p=15):
##  [1] 1.7822858 1.2706276 1.0404145 1.0373031 0.9620233 0.9594423 0.9312585
##  [8] 0.9151956 0.8932286 0.8511995 0.8189853 0.8003226 0.7568713 0.7509609
## [15] 0.7274690
## 
## Rotation (n x k) = (15 x 15):
##                 PC1         PC2         PC3           PC4         PC5
## iOp01   -0.06943778  0.38155798 -0.19427723  0.4915882664  0.19803386
## iOp03   -0.20562301  0.30500547  0.47716338 -0.2907785685 -0.20900299
## iOp04    0.36177159 -0.08071718  0.34244974 -0.0003028303 -0.11323021
## iOp10   -0.34078095  0.23989272  0.19732683 -0.2139680548 -0.17104896
## iOp11    0.29931733  0.09490561  0.09826912 -0.0213681852  0.23233088
## iOp02.5  0.32443413  0.07300092  0.07894631  0.0320344221 -0.22999432
## iOp42    0.12845659  0.48677246 -0.23754435  0.0526953352 -0.14183215
## iOp43    0.16507540  0.31259574 -0.28949688 -0.4294394393 -0.28394314
## iOp46   -0.20512296  0.17552225  0.40029547  0.0300032371  0.04153754
## iOp45   -0.29856014  0.20970290 -0.31605182 -0.0187235987  0.07757389
## iOP13.5  0.35202797  0.02718279  0.05356841  0.1507532470 -0.03959969
## iOp44    0.11226061  0.20192394  0.07709088 -0.4107140003  0.80179338
## iOp07.5  0.26953643  0.30979313 -0.15452816 -0.1165836764 -0.10753154
## iOp47    0.33900566  0.15729302  0.24253529  0.1122834985  0.03911805
## iOP12.5 -0.10942316  0.33363638  0.26570013  0.4695379747  0.04614479
##                 PC6          PC7         PC8          PC9         PC10
## iOp01   -0.15062622  0.086873091 -0.36382134  0.434219525 -0.294884944
## iOp03   -0.23181854  0.028323653 -0.34924941 -0.041639577  0.099043057
## iOp04   -0.05029616  0.211504124  0.01004747  0.199516759 -0.159180605
## iOp10   -0.13095970 -0.053855368 -0.17025640 -0.051893607 -0.186371938
## iOp11    0.46069587 -0.051935276 -0.38659529  0.074794408 -0.174518794
## iOp02.5 -0.36039154 -0.451433548  0.02531913  0.005203201 -0.301394416
## iOp42   -0.19693292  0.151161377  0.15029456  0.208217043  0.586642570
## iOp43    0.18770535  0.248241667  0.31276168  0.154365239 -0.362684643
## iOp46    0.44736652 -0.352974058  0.39556974  0.473486940  0.079459941
## iOp45    0.11041482 -0.512305517 -0.04298693 -0.213770985  0.023419463
## iOP13.5 -0.26367332 -0.425241487  0.20911238 -0.010784156 -0.004230272
## iOp44   -0.28023510  0.019551048  0.17605295 -0.045507654 -0.042046820
## iOp07.5  0.30741820 -0.121070383 -0.17902370 -0.366582757 -0.039498614
## iOp47    0.17602641  0.006911587 -0.16548973 -0.174333373  0.417089629
## iOP12.5  0.04333967  0.264739933  0.39189684 -0.507508839 -0.249004492
##                 PC11        PC12         PC13        PC14        PC15
## iOp01    0.268041765 -0.10759740 -0.017454400  0.05583458 -0.07759637
## iOp03   -0.028268175 -0.14763906 -0.207863748 -0.27700923 -0.42210555
## iOp04    0.189110923 -0.09478334 -0.006973371 -0.52100969  0.55114105
## iOp10   -0.047812745  0.09035923  0.551647315  0.34238261  0.44032361
## iOp11   -0.639556895  0.07498348  0.119986008 -0.07704203 -0.04334111
## iOp02.5 -0.162737844  0.26521465 -0.464150949  0.28093279  0.11355379
## iOp42   -0.293136056  0.26303996  0.050047991 -0.12403748  0.14999167
## iOp43   -0.029759426 -0.37536418 -0.058696637  0.13243197 -0.11563024
## iOp46    0.156393341  0.14514663 -0.053539827  0.04183396 -0.04903883
## iOp45   -0.074520395 -0.37759488 -0.197166575 -0.35794150  0.35036950
## iOP13.5 -0.008700931 -0.29354808  0.586329244 -0.15432949 -0.31640366
## iOp44    0.088893908  0.05750762 -0.038890456  0.02630346  0.04428991
## iOp07.5  0.516696787  0.44286099  0.106674560 -0.14620017 -0.09660579
## iOp47    0.174231721 -0.46253063 -0.123396692  0.48427005  0.17481876
## iOP12.5 -0.177910829  0.01561185 -0.051961030 -0.05844298 -0.01982064</code></pre>
<p><code>summary()</code> выдаст полезную информацию, в частности, долю объясненной дисперсии и кумулятивную долю объясненной дисперсии</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(pr)</code></pre></div>
<pre><code>## Importance of components:
##                           PC1    PC2     PC3     PC4    PC5     PC6
## Standard deviation     1.7823 1.2706 1.04041 1.03730 0.9620 0.95944
## Proportion of Variance 0.2118 0.1076 0.07216 0.07173 0.0617 0.06137
## Cumulative Proportion  0.2118 0.3194 0.39157 0.46330 0.5250 0.58637
##                            PC7     PC8     PC9   PC10    PC11   PC12
## Standard deviation     0.93126 0.91520 0.89323 0.8512 0.81899 0.8003
## Proportion of Variance 0.05782 0.05584 0.05319 0.0483 0.04472 0.0427
## Cumulative Proportion  0.64418 0.70002 0.75321 0.8015 0.84623 0.8889
##                           PC13   PC14    PC15
## Standard deviation     0.75687 0.7510 0.72747
## Proportion of Variance 0.03819 0.0376 0.03528
## Cumulative Proportion  0.92712 0.9647 1.00000</code></pre>
<div id="pca_n" class="section level3">
<h3><span class="header-section-number">5.3.1</span> Количество извлекаемых компонент</h3>
<p>Визуализация объясненных дисперсий с помощью каждого фактора может использоваться для того, чтобы решить, какие оси оставить, а какие отбросить.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(pr)</code></pre></div>
<p><img src="sirius_advanced_files/figure-html/unnamed-chunk-174-1.png" width="672" /></p>
<p>Если после какой-то шкалы график резко “падает” и становится ровным, то можно предположить, что эти последние шкалы представляют некоторый “шум” в данных - их и можно отбросить.</p>
<p>В пакете <code>psych</code> есть функция <code>fa.parallel()</code>, которая позволяет не только визуализировать, но и дает пользователю количество рекомендуемых компонент. Важно понимать, что эти границы условны, поэтому не стоит безусловно доверять этой функции.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">psych<span class="op">::</span><span class="kw">fa.parallel</span>(opinion)</code></pre></div>
<p><img src="sirius_advanced_files/figure-html/unnamed-chunk-175-1.png" width="672" /></p>
<pre><code>## Parallel analysis suggests that the number of factors =  6  and the number of components =  4</code></pre>
<p>Можно визуализировать данные в новых осях (например, в первых двух):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(pr<span class="op">$</span>x[,<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>])</code></pre></div>
<p><img src="sirius_advanced_files/figure-html/unnamed-chunk-176-1.png" width="672" /></p>
<p>Наконец, выбрать желаемое количество компонент можно через параметр <code>rank. =</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">prcomp</span>(opinion, <span class="dt">scale. =</span> <span class="ot">TRUE</span>, <span class="dt">rank. =</span> <span class="dv">4</span>)</code></pre></div>
<pre><code>## Standard deviations (1, .., p=15):
##  [1] 1.7822858 1.2706276 1.0404145 1.0373031 0.9620233 0.9594423 0.9312585
##  [8] 0.9151956 0.8932286 0.8511995 0.8189853 0.8003226 0.7568713 0.7509609
## [15] 0.7274690
## 
## Rotation (n x k) = (15 x 4):
##                 PC1         PC2         PC3           PC4
## iOp01   -0.06943778  0.38155798 -0.19427723  0.4915882664
## iOp03   -0.20562301  0.30500547  0.47716338 -0.2907785685
## iOp04    0.36177159 -0.08071718  0.34244974 -0.0003028303
## iOp10   -0.34078095  0.23989272  0.19732683 -0.2139680548
## iOp11    0.29931733  0.09490561  0.09826912 -0.0213681852
## iOp02.5  0.32443413  0.07300092  0.07894631  0.0320344221
## iOp42    0.12845659  0.48677246 -0.23754435  0.0526953352
## iOp43    0.16507540  0.31259574 -0.28949688 -0.4294394393
## iOp46   -0.20512296  0.17552225  0.40029547  0.0300032371
## iOp45   -0.29856014  0.20970290 -0.31605182 -0.0187235987
## iOP13.5  0.35202797  0.02718279  0.05356841  0.1507532470
## iOp44    0.11226061  0.20192394  0.07709088 -0.4107140003
## iOp07.5  0.26953643  0.30979313 -0.15452816 -0.1165836764
## iOp47    0.33900566  0.15729302  0.24253529  0.1122834985
## iOP12.5 -0.10942316  0.33363638  0.26570013  0.4695379747</code></pre>
</div>
</div>
<div id="fa" class="section level2">
<h2><span class="header-section-number">5.4</span> Эксплораторный факторный анализ</h2>
<p>Чарльз Спирмен был один из пионеров использования коэффициентов корреляции в научных исследованиях. Он уже в самом начале XX века использовал корреляционные матрицы для исследования связи разных тестов, которые проходили школьники. Он обнаружил, что оценки по самым разным тестам коррелируют друг с другом. Короче говоря, если учащийся хорошо справляется с математикой, то и с музыкой у него, скорее всего, будет хорошо.</p>
<p>Чарльз Спирмен предположил, что за этими шкалами стоит некоторый единый фактор, который он назвал фактором g - общий интеллект. С точки зрения Спирмена, общий интеллект - это латентный фактор, который объясняет существующие корреляции между баллами за разные тесты, а то, что общий интеллект не объясняет - это отдельные способности.</p>
<p>Для того, чтобы доказать свою теорию, Чарльз Спирмен придумал эксплораторный факторный анализ (ЭФА; exploratory factor analysis). Потом, правда, оказалось, что в данном случае факторный анализ ничего не доказывает, зато метод оказался очень полезным и получил большое распространение (особенно в психологии).</p>
<p>Суть ЭФА несколько сложнее АГК. Если в АГК мы просто вертим оси исходного пространства, чтобы максимизировать дисперсию первых осей и минимизировать дисперсию последних, то в ЭФА мы строим модель с заданным количеством латентных (т.е. “скрытых”) переменных, которые должны объяснять общую дисперсию наблюдаемых переменных и быть ортогональными (перпендикулярными) друг другу. Ну а все необъясненное остается влиянием независимых индивидуальных факторов. Кроме того, полученные латентные факторы можно еще “повращать” для большей интерпретируемости латентных факторов. Причем “вращение” может быть как ортогональным (самое распространенное - варимакс) или косоугольным (например, облимин). В первом случае факторы останутся нескоррелированными, во втором случае - нет.</p>
<p>Для ЭФА есть много пакетов, более того, уже знакомый нам <code>psych</code> умеет делать ЭФА.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fa_none_fit &lt;-<span class="st"> </span><span class="kw">factanal</span>(opinion_scaled, <span class="dt">factors =</span> <span class="dv">6</span>, <span class="dt">rotation =</span> <span class="st">&quot;varimax&quot;</span>)
fa_none_fit</code></pre></div>
<pre><code>## 
## Call:
## factanal(x = opinion_scaled, factors = 6, rotation = &quot;varimax&quot;)
## 
## Uniquenesses:
##   iOp01   iOp03   iOp04   iOp10   iOp11 iOp02.5   iOp42   iOp43   iOp46 
##   0.842   0.633   0.539   0.516   0.730   0.742   0.512   0.775   0.863 
##   iOp45 iOP13.5   iOp44 iOp07.5   iOp47 iOP12.5 
##   0.605   0.005   0.948   0.642   0.614   0.828 
## 
## Loadings:
##         Factor1 Factor2 Factor3 Factor4 Factor5 Factor6
## iOp01           -0.111                           0.371 
## iOp03                            0.587           0.109 
## iOp04    0.152   0.569   0.279  -0.113          -0.136 
## iOp10   -0.103  -0.270  -0.208   0.592                 
## iOp11            0.188   0.447  -0.151                 
## iOp02.5  0.279   0.246   0.247  -0.120   0.196         
## iOp42                                    0.569   0.391 
## iOp43                    0.197           0.426         
## iOp46           -0.137           0.266  -0.126   0.160 
## iOp45           -0.575  -0.102   0.168           0.150 
## iOP13.5  0.939   0.173   0.198  -0.192                 
## iOp44                    0.145           0.154         
## iOp07.5                  0.496           0.316         
## iOp47    0.148   0.313   0.482  -0.115           0.115 
## iOP12.5                          0.165           0.374 
## 
##                Factor1 Factor2 Factor3 Factor4 Factor5 Factor6
## SS loadings      1.044   0.990   0.977   0.934   0.724   0.538
## Proportion Var   0.070   0.066   0.065   0.062   0.048   0.036
## Cumulative Var   0.070   0.136   0.201   0.263   0.311   0.347
## 
## Test of the hypothesis that 6 factors are sufficient.
## The chi square statistic is 130.78 on 30 degrees of freedom.
## The p-value is 1.52e-14</code></pre>
<p>Получаемый результат имеет примерно тот же вид, что и при АГК. Нужно смотреть на кумулятивную объясненную дисперсию, а также смотреть на факторные нагрузки - связь латентных факторов с наблюдаемыми шкалами. Особенно нас интересуют факторные нагрузки близкие к 1 и -1 (значения близкие к нулю скрыты). Анализируя эти шкалы, можно сделать вывод о том, что из себя представляет латентный фактор содержательно. Возьмем для примера второй фактор: в нем есть как выраженные положительные, так и отрицательные нагрузки:</p>
<ul>
<li><p><strong>“Consuming genetically modified (GMO) food is perfectly safe”</strong> - положительная нагрузка <em>0.569</em></p></li>
<li><p><strong>“When you are ill, how likely are you to turn to alternative medicine (such as homeopathy) rather than seeking treatment from conventional medicine?”</strong> - отрицательная нагрузка <em>-0.575</em></p></li>
</ul>
<p>Можно предположить, что этот фактор означает доверие к академической науке: те, у кого большое значение по этому фактору не боятся ГМО, а те, у кого низкое значение, - верят в эффективность гомеопатии.</p>
<p>Давайте визуализируем с помощью ggplot2 факторные нагрузки по первым двум факторам:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">load &lt;-<span class="st"> </span>fa_none_fit<span class="op">$</span>loadings[,<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]
<span class="kw">library</span>(ggplot2)
load_dt &lt;-<span class="st"> </span><span class="kw">as.data.table</span>(load)
load_dt<span class="op">$</span>names &lt;-<span class="st"> </span><span class="kw">rownames</span>(load)
load</code></pre></div>
<pre><code>##             Factor1      Factor2
## iOp01   -0.01566970 -0.110771479
## iOp03   -0.07033983 -0.025900326
## iOp04    0.15240114  0.568881912
## iOp10   -0.10317583 -0.270441390
## iOp11    0.06172226  0.188263581
## iOp02.5  0.27880820  0.246291576
## iOp42    0.06696601  0.060755424
## iOp43    0.01663996  0.011630244
## iOp46   -0.05416371 -0.137096836
## iOp45   -0.06206774 -0.574575950
## iOP13.5  0.93850496  0.172697022
## iOp44    0.05999292  0.049111124
## iOp07.5  0.07140540  0.009635239
## iOp47    0.14796036  0.312706149
## iOP12.5 -0.01468160 -0.040392354</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(load_dt, <span class="kw">aes</span>(<span class="dt">x =</span> Factor1, <span class="dt">y =</span> Factor2))<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> names), <span class="dt">vjust =</span> <span class="dv">1</span>, <span class="dt">hjust =</span> <span class="dv">1</span>)</code></pre></div>
<p><img src="sirius_advanced_files/figure-html/unnamed-chunk-179-1.png" width="672" /></p>
</div>
<div id="cfa" class="section level2">
<h2><span class="header-section-number">5.5</span> Конфирматорный факторный анализ</h2>
<p>Как следует из названия, если ЭФА - это более эксплораторный метод анализа, то конфирматорный факторный анализ (КФА) предназначен для проверки моделей о структуре факторов.</p>
<p>Как и в ЭФА, в КФА есть неизмеряемые латентные переменные, которые как-то объясняют измеряемые переменные. Однако если в ЭФА мы просто строим модель, где все латентные переменные объясняют все измеряемые переменные, то в КФА мы можем проверять более специфическую модель, где отдельные латентные переменные связаны только с определенными измеряемыми переменными. Кроме того, мы можем задавать (или не задавать) корреляции между латентными факторами и ошибками.</p>
<p>Самый распространенный пакет для КФА в R - lavaan (LAtent VAriable ANalysis). Впрочем, это один из самых распространенных инструментов для КФА (и структурного моделирования, о чем будет позже) вообще!</p>
<p>Давайте сразу его установим и загрузим данные по 9 тестам младшеклассников.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;lavaan&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(lavaan)
<span class="kw">data</span>(HolzingerSwineford1939)</code></pre></div>
<p>Модель предполагает, наличие трех коррелирующих друг с другом факторов: визуальный фактор (задания х1, х2, х3), текстовый фактор (задания х4, х5, х6) и фактор скорости (задания х7, х8, х9). Для того, чтобы задать такую модель, у <code>lavaan</code> есть свой синтаксис. Описание модели записывается в строковую переменную.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">HS_model &lt;-<span class="st"> &quot;</span>
<span class="st">visual =~ x1 + x2 + x3</span>
<span class="st">textual =~ x4 + x5 + x6</span>
<span class="st">speed =~ x7 + x8 + x9</span>
<span class="st">&quot;</span></code></pre></div>
<p>Затем происходит фиттинг модели с помощью функции <code>cfa()</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">hs_cfa &lt;-<span class="st"> </span><span class="kw">cfa</span>(HS_model, <span class="dt">data =</span> HolzingerSwineford1939)
<span class="kw">summary</span>(hs_cfa)</code></pre></div>
<pre><code>## lavaan 0.6-4 ended normally after 35 iterations
## 
##   Optimization method                           NLMINB
##   Number of free parameters                         21
## 
##   Number of observations                           301
## 
##   Estimator                                         ML
##   Model Fit Test Statistic                      85.306
##   Degrees of freedom                                24
##   P-value (Chi-square)                           0.000
## 
## Parameter Estimates:
## 
##   Information                                 Expected
##   Information saturated (h1) model          Structured
##   Standard Errors                             Standard
## 
## Latent Variables:
##                    Estimate  Std.Err  z-value  P(&gt;|z|)
##   visual =~                                           
##     x1                1.000                           
##     x2                0.554    0.100    5.554    0.000
##     x3                0.729    0.109    6.685    0.000
##   textual =~                                          
##     x4                1.000                           
##     x5                1.113    0.065   17.014    0.000
##     x6                0.926    0.055   16.703    0.000
##   speed =~                                            
##     x7                1.000                           
##     x8                1.180    0.165    7.152    0.000
##     x9                1.082    0.151    7.155    0.000
## 
## Covariances:
##                    Estimate  Std.Err  z-value  P(&gt;|z|)
##   visual ~~                                           
##     textual           0.408    0.074    5.552    0.000
##     speed             0.262    0.056    4.660    0.000
##   textual ~~                                          
##     speed             0.173    0.049    3.518    0.000
## 
## Variances:
##                    Estimate  Std.Err  z-value  P(&gt;|z|)
##    .x1                0.549    0.114    4.833    0.000
##    .x2                1.134    0.102   11.146    0.000
##    .x3                0.844    0.091    9.317    0.000
##    .x4                0.371    0.048    7.779    0.000
##    .x5                0.446    0.058    7.642    0.000
##    .x6                0.356    0.043    8.277    0.000
##    .x7                0.799    0.081    9.823    0.000
##    .x8                0.488    0.074    6.573    0.000
##    .x9                0.566    0.071    8.003    0.000
##     visual            0.809    0.145    5.564    0.000
##     textual           0.979    0.112    8.737    0.000
##     speed             0.384    0.086    4.451    0.000</code></pre>
<p>Здесь мы можем увидеть, сошлась ли модель, оценки качества модели и оценки интересующих параметров модели.</p>
<p>Модели для КФА принято рисовать в виде блок-схем с кружочками, квадратиками и стрелочками. Есть несколько вариантов, как именно отрисовывать модели, например, нужно ли отдельным кружочком рисовать ошибку для каждой измеряемой модели. Но, в целом, правила такие: <em>круги</em> - это латентные переменные, <em>квадраты</em> - измеряемые переменные, <em>стрелочки</em> - ассоциации между ними.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;semPlot&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(semPlot)
<span class="kw">semPaths</span>(hs_cfa)</code></pre></div>
<p><img src="sirius_advanced_files/figure-html/unnamed-chunk-185-1.png" width="672" /></p>
<p>КФА лежит в основе структурного моделирования (structural equation modelling, SEM). По сути, структурное моделирование - это КФА + анализ пути (path analysis), который можно рассматривать как расширение множественной линейной регрессии - только вместо одного линейного уравнения у нас появляется целая система уровнений. Если же в системе уравнений использовать не наблюдаемые, а на латентные переменные, то получается структурное моделирование.</p>
</div>
<div id="other_multi" class="section level2">
<h2><span class="header-section-number">5.6</span> Другие многомерные методы</h2>
<p>АГК, ЭФА, КФА, структурное моделирование - не единственные многомерные методы для анализа данных. За бортом осталось множество подходов, таких как кластерный анализ и многомерное шкалирование. В заключение я хочу показать еще один интересный подход к анализу данных в социальных науках - сетевой анализ, т.е. анализ графов. Этот метод активно применяется в исследованиях социальных сетей, в биологии и даже в гуманитарных науках.</p>
<p>В основе графа лежит матрица близости между переменными. В данном случае мы можем использовать уже знакомую нам матрицу корреляций. Тогда отдельная вершина будет отдельным пунктом опросником, а связью между ними - наличие корреляции выше выбранного порога (использовать пороговое значение необязательно, но сделает визуализацию нагляднее).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;igraph&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">opinion_cor_abs &lt;-<span class="st"> </span><span class="kw">abs</span>(opinion_cor)
<span class="kw">diag</span>(opinion_cor_abs) &lt;-<span class="st"> </span><span class="dv">0</span>
<span class="kw">rownames</span>(opinion_cor_abs) &lt;-<span class="st"> </span><span class="kw">colnames</span>(opinion_cor_abs) &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;</span><span class="ch">\\</span><span class="st">.&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="kw">colnames</span>(opinion_cor_abs))


<span class="kw">library</span>(igraph)
opinion_ig &lt;-<span class="st"> </span><span class="kw">graph.adjacency</span>(opinion_cor_abs, <span class="dt">weighted =</span> <span class="ot">TRUE</span>, <span class="dt">mode =</span> <span class="st">&quot;lower&quot;</span>)
opinion_ig &lt;-<span class="st"> </span><span class="kw">delete.edges</span>(opinion_ig, <span class="kw">E</span>(opinion_ig)[weight <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.2</span>])
<span class="kw">plot</span>(opinion_ig, <span class="dt">vertex.colour =</span> <span class="st">&quot;grey&quot;</span>, <span class="dt">vertex.frame.color =</span> <span class="ot">NA</span>,
     <span class="dt">vertex.size =</span> <span class="kw">strength</span>(opinion_ig)<span class="op">*</span><span class="dv">3</span><span class="op">+</span><span class="dv">2</span>, <span class="dt">vertex.label.dist =</span> <span class="dv">1</span>,
     <span class="dt">edge.curved =</span> <span class="dv">0</span>, <span class="dt">vertex.label.color =</span> <span class="st">&quot;black&quot;</span>)</code></pre></div>
<p><img src="sirius_advanced_files/figure-html/unnamed-chunk-187-1.png" width="672" /></p>
<p>В R есть множество пакетов для интерактивных визуализаций графов.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;edgebundleR&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(edgebundleR)
<span class="kw">edgebundle</span>(opinion_ig)</code></pre></div>
<div id="htmlwidget-f24b96066a359c580292" style="width:672px;height:480px;" class="edgebundleR html-widget"></div>
<script type="application/json" data-for="htmlwidget-f24b96066a359c580292">{"x":{"json_real":"[{\"name\":\"iOp01\",\"imports\":null},{\"name\":\"iOp03\",\"imports\":\"iOp10\"},{\"name\":\"iOp04\",\"imports\":[\"iOp10\",\"iOp11\",\"iOp025\",\"iOp45\",\"iOP135\",\"iOp47\"]},{\"name\":\"iOp10\",\"imports\":[\"iOp11\",\"iOp025\",\"iOp46\",\"iOp45\",\"iOP135\",\"iOp47\"]},{\"name\":\"iOp11\",\"imports\":[\"iOp025\",\"iOP135\",\"iOp075\",\"iOp47\"]},{\"name\":\"iOp025\",\"imports\":[\"iOp45\",\"iOP135\",\"iOp075\",\"iOp47\"]},{\"name\":\"iOp42\",\"imports\":[\"iOp43\",\"iOp075\"]},{\"name\":\"iOp43\",\"imports\":\"iOp075\"},{\"name\":\"iOp46\",\"imports\":null},{\"name\":\"iOp45\",\"imports\":[\"iOP135\",\"iOp47\"]},{\"name\":\"iOP135\",\"imports\":[\"iOp075\",\"iOp47\"]},{\"name\":\"iOp44\",\"imports\":null},{\"name\":\"iOp075\",\"imports\":\"iOp47\"},{\"name\":\"iOp47\",\"imports\":null},{\"name\":\"iOP125\",\"imports\":null}]","width":null,"height":null,"padding":100,"tension":0.5,"fontsize":14,"nodesize":[5,20],"directed":false},"evals":[],"jsHooks":[]}</script>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;networkD3&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(networkD3)
opinion_nd3 &lt;-<span class="st"> </span><span class="kw">igraph_to_networkD3</span>(opinion_ig)
<span class="kw">forceNetwork</span>(<span class="dt">Links =</span> opinion_nd3<span class="op">$</span>links, <span class="dt">Nodes =</span> opinion_nd3<span class="op">$</span>nodes,
             <span class="dt">Source =</span> <span class="st">&#39;source&#39;</span>, <span class="dt">Target =</span> <span class="st">&#39;target&#39;</span>, 
             <span class="dt">NodeID =</span> <span class="st">&#39;name&#39;</span>, <span class="dt">Group =</span> <span class="dv">1</span>, <span class="dt">opacity =</span> <span class="dv">1</span>)</code></pre></div>
<div id="htmlwidget-253ecefc9ffaea63a371" style="width:672px;height:480px;" class="forceNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-253ecefc9ffaea63a371">{"x":{"links":{"source":[3,4,2,5,10,7,4,6,1,2,2,3,2,3,5,4,9,6,5,3,2,3,5,2,12,9,3,4,10],"target":[5,5,5,12,12,12,12,12,3,3,4,4,10,10,10,10,10,7,9,9,9,8,13,13,13,13,13,13,13],"colour":["#666","#666","#666","#666","#666","#666","#666","#666","#666","#666","#666","#666","#666","#666","#666","#666","#666","#666","#666","#666","#666","#666","#666","#666","#666","#666","#666","#666","#666"]},"nodes":{"name":["iOp01","iOp03","iOp04","iOp10","iOp11","iOp025","iOp42","iOp43","iOp46","iOp45","iOP135","iOp44","iOp075","iOp47","iOP125"],"group":["iOp01","iOp03","iOp04","iOp10","iOp11","iOp025","iOp42","iOp43","iOp46","iOp45","iOP135","iOp44","iOp075","iOp47","iOP125"]},"options":{"NodeID":"name","Group":1,"colourScale":"d3.scaleOrdinal(d3.schemeCategory20);","fontSize":7,"fontFamily":"serif","clickTextSize":17.5,"linkDistance":50,"linkWidth":"function(d) { return Math.sqrt(d.value); }","charge":-30,"opacity":1,"zoom":false,"legend":false,"arrows":false,"nodesize":false,"radiusCalculation":" Math.sqrt(d.nodesize)+6","bounded":false,"opacityNoHover":0,"clickAction":null}},"evals":[],"jsHooks":[]}</script>
<!--chapter:end:04-Week2Day4_fa.Rmd-->
</div>
</div>
<div id="d6" class="section level1">
<h1><span class="header-section-number">6</span> Неделя 2, День 6</h1>
<div id="style" class="section level2">
<h2><span class="header-section-number">6.1</span> Стиль кода</h2>
<p>После того, как мы научились делать всякие сложные вещи в R, нужно снова вернуться к тому, что иногда кажется несколько занудным и неинтересным: к стилю написания кода и “воркфлоу”. После того, как путем проб и ошибок нужные результаты посчитаны, а подходящий график нарисован, очень хочется все закрыть и поскорее послать туда, куда это нужно было послать еще неделю назад. При сумбурном образе жизни современного ученого мало кому нравится идея о том, что после написания работающего кода нужно выдохнуть и все перепроверить, переписать код (если что-то можно сделать лучше), закомментировать сложные куски кода. Тем не менее, это не займет много времени, а в дальнейшем много раз окупится, когда придется возвращаться к коду или в нем окажется ошибка (а такое, как Вы уже могли догадаться, бывает часто).</p>
<p>Есть некоторые обязательные правила, без которых у Вас ничего не будет работать. Например, нельзя использовать пробелы в названии переменных, переменные не могут начинаться с цифр и т.д. Есть менее строгие правила, которые связаны с тем, что нарушение таковых может в специфических случаях привести к ошибкам. Но даже если Вы знаете, в каких именно случаях и что может пойти не так и почему, уверены, что Вас это не коснется, то все равно игра не стоит свеч. Например, можно создать переменные с именем <code>T</code> и <code>F</code>, но делать этого не стоит, потому что это перепишет стандартные значения <code>T</code> и <code>F</code> (<code>TRUE</code> и <code>FALSE</code>). И если хотя где-то в коде Вы используете <code>T</code> вместо <code>TRUE</code>, то ничего не будет работать, придется потратить очень много времени, чтобы понять, в чем была ошибка. По этой же причине, кстати говоря, лучше не писать сокращать <code>TRUE</code> до <code>T</code>, а <code>FALSE</code> до <code>F</code>.</p>
<p>Есть же правила, которые не связаны с тем, что они могут привести к ошибкам, а только с тем, что такой код становится проще читать. Особенно хорошо, если все придерживаются более-менее одного стиля, но, увы, такого в R нет: Вы уже могли заметить, что разные пакеты предлагают свой стиль, немного отличающийся от других.</p>
<p>Поэтому вполне нормально, если Вы выработаете свой стиль с опытом. Главное, по возможности придерживаться его. Довольно универсальный стиль <a href="http://adv-r.had.co.nz/Style.html">описан</a> Хэдли Уикхемом.</p>
<p>Вот краткий пересказ основных правил из этого гайда (и некоторых других, которые я добавил сюда сам):</p>
<ul>
<li><em>Для файлов.</em> Не использовать пробелы и знак  - лучше использовать нижнее подчеркивание или дефис. Использовать только маленькие буквы. В начале названия можно использовать числа, чтобы обозначить, в каком порядке нужно запускать скрипты.</li>
<li><em>Для переменных.</em> Использовать короткие, но осмысленные названия переменных. Есть несколько вариантов, как разделять слова в названии переменной: использование больших букв, точка или нижнее подчеркивание.</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">SomeNumber &lt;-<span class="st"> </span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span> <span class="co">#можно, но не очень удобно</span>
some.number &lt;-<span class="st"> </span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span> <span class="co">#удобно, но не рекомендуется</span>
some_number &lt;-<span class="st"> </span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span> <span class="co">#хорошо</span></code></pre></div>
<p>В целом, не стоит использовать вариант с точкой (точка обычно означает метод для generic функции), а вариант с нижнем подчеркиванием - самый популярный. Не используйте <code>T</code>, <code>c</code> и какие-либо привычные функции для называния переменных. Не только из-за того, что это может привести к ошибкам, но и из-за того, что читающий код может не понять, что происходит.</p>
<ul>
<li><em>Пробелы.</em> Всегда вокруг арифметических операторов (но не вокруг <code>:</code>!), после, но не до запятой, не ставить пробелов около <code>$</code> и <code>::</code></li>
</ul>
<p>Кроме того, в RStudio есть удобное сочетание клавиш для форматирования кода: <code>ctrl + shift + A</code> (Windows) или <code>cmd + shift + A</code> (MacOS). Если выделить код и зажать эти клавиши, то вот такой код…</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">for</span>  (i <span class="cf">in</span> <span class="dv">1</span> <span class="op">:</span><span class="st"> </span><span class="dv">10</span>)  { <span class="cf">if</span>(i<span class="op">%%</span><span class="dv">2</span><span class="op">==</span><span class="st"> </span><span class="dv">0</span>)
<span class="kw">print</span>(
<span class="kw">paste</span>(i , <span class="st">&quot;is even&quot;</span>) )
                    }</code></pre></div>
<pre><code>## [1] &quot;2 is even&quot;
## [1] &quot;4 is even&quot;
## [1] &quot;6 is even&quot;
## [1] &quot;8 is even&quot;
## [1] &quot;10 is even&quot;</code></pre>
<p>…превратится в такой:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">for</span>  (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)  {
  <span class="cf">if</span> (i <span class="op">%%</span><span class="st"> </span><span class="dv">2</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)
  <span class="kw">print</span>(<span class="kw">paste</span>(i , <span class="st">&quot;is even&quot;</span>))
}</code></pre></div>
<pre><code>## [1] &quot;2 is even&quot;
## [1] &quot;4 is even&quot;
## [1] &quot;6 is even&quot;
## [1] &quot;8 is even&quot;
## [1] &quot;10 is even&quot;</code></pre>
</div>
<div id="repr" class="section level2">
<h2><span class="header-section-number">6.2</span> Вопроизводимость исследований</h2>
<div id="quest" class="section level3">
<h3><span class="header-section-number">6.2.1</span> Спорные исследовательские практики</h3>
<p>Если Вы откроете какой-нибудь более-менее классический учебник по психологии, то увидите там много результатов исследований, которые в дальнейшем не удалось воспроизвести. Эта проблема накрыла академическое психологическое сообщество относительно недавно и стала, пожалуй, самой обсуждаемой темой среди ученых-психологов. Действительно, о чем еще говорить, если половина фактов твоей науки попросту неверна? <del>Об историческом смысле методологического кризиса, конечно же.</del> Получается, у теорий нет никакого подтверждения, а в плане знаний о психологических фактах мы находимся примерно там же, где и психологи, которые закупали метрономы и тахистоскопы почти полтора века назад.</p>
<p>Оказалось, что то, как устроена академическая наука, способствует публикации ложноположительных результатов. Если теоретическая гипотеза подтверждается, то это дает ученому больше плюшек, чем если гипотеза не подтверждается. Да и сами ученые как-то неосознанно хотят оказаться правыми. Ну а перепроверка предыдущих достижений в психологии оказалась не в почете: всем хочется быть первопроходцами и открывать новые неожиданные феномены, а не скрупулезно перепроверять чужие открытия. Все это привело психологию к тому, что в ней (да и не только в ней) закрепилось какое-то количество спорных исследовательских практик (questionable research practices). Спорные практики на то и спорные, что не все они такие уж плохие, многие ученые даже считают, что в них нет ничего плохого. В отличие, например, от фальсификации данных - это, очевидно, совсем плохо.</p>
<p>Вот некоторые распространенные спорные исследовательские практики:</p>
<ul>
<li><p><em>Выбор зависимых переменных пост-фактум.</em> По своей сути, это проблема скрытых множественных сравнений: если у нас много зависимых переменных, то можно сделать вид, что измерялось только то, на чем нашли эффект. Поэтому стоит задуматься, если возникает идея измерять все подряд на всякий случай - что конкретно предполагается обнаружить? Если конкретной гипотезы нет, то нужно так и написать, делая соответствующие поправки при анализе.</p></li>
<li><p><em>Обсуждение неожиданных результатов как ожидаемых.</em> Возможно, Вам это покажется смешным, но очень часто результаты оказываются статистически значимыми, но направлены в другую сторону, чем предполагалось в гипотезе. И в таких случаях исследователи часто пишут, как будто бы такие результаты и ожидались изначально! Приходится, правда, немного подкрутить теоретические построения.</p></li>
<li><p><em>Остановка набора испытуемых при достижении уровня значимости (Optional stopping).</em> Представьте себе, что Вы не обнаружили значимых результатов, но p-value болтается около 0.05. Тогда Вам захочется добрать парочку испытуемых. А потом еще. И еще немного. Проблема с таким подходом в том, что рано или поздно Вы получите статистически значимые результаты. В любом случае, даже если эффекта нет. На самом деле, эта проблема не так сильно влияет на результаты как может показаться, но это все-таки достаточно плохая практика, а ее применение увеличивает количество опубликованных ложно-положительных результатов.</p></li>
<li><p><em>Неправильное округление до .05.</em> Всякий раз, когда видите <em>p = .05</em> будьте внимательны: вообще-то он не может быть равен именно <em>.05</em>. Либо автор не очень этого понимает, либо просто <em>p</em> больше, а не меньше <em>.05</em>. Например, <em>.054</em>, что потом округляется до <em>.05</em> и преподносится как статистически значимые результаты.</p></li>
<li><p><em>Использование односторонних тестов для сравнения средних.</em> Эта практика похожа на предыдущую: исследователь получил <em>p &gt; .05</em>, но меньше, чем <em>.1</em>. Недобросовестный исследователь, который хочет опубликоваться проводит односторонний т-тест вместо двустороннего, т.е. фактически просто делит р на 2. Совсем недобросовестные даже не пишут, что они использовали односторонний т-тест, хотя по умолчанию все используют двусторонний.</p></li>
</ul>
<p>Данный список не претендует на полноту. Этих практик стоит избегать и других от этого отучать. Ну а если Вы думаете, что никто не заметит, если Вы так сделаете, то это не так.</p>
<p>Например, последние две практики можно легко обнаружить с помощью сайта <a href="http://statcheck.io" class="uri">http://statcheck.io</a>. Этот сайт делает магию: нужно кинуть ему статью, он распознает в ней статистические тесты и пересчитывает их. На самом деле, ничего сложного, а это сайт сделан с помощью R и уже знакомых нам инструментов: с помощью специальных пакетов из файлов вытаскивается текст, в тексте с помощью регулярных выражений находятся паттерны вроде “<em>t</em>(18) = -1.91, <em>p</em> = .036” - в большинстве журналов используется очень похожее форматирование статистических результатов. Зная степени свободы и т-статистику, можно пересчитать p-value. В данном случае это можно посчитать вот так:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">pt</span>(<span class="op">-</span><span class="fl">1.91</span>, <span class="dt">df =</span> <span class="dv">18</span>)<span class="op">*</span><span class="dv">2</span> <span class="co">#умножаем на 2, потому что двусторонний тест</span></code></pre></div>
<pre><code>## [1] 0.07219987</code></pre>
<p>Ну а дальше остается сравнить это с тем, что написали авторы. Например, бывает как в данном случае, что пересчитанный p-value в два раза больше того, что написали авторы. Это означает, скорее всего, что авторы использовали односторонний критерий. Если они об этом нигде не сказали, то это очень плохо.</p>
<p><strong>Самостоятельное задание</strong>:</p>
<ol style="list-style-type: decimal">
<li><p>Найдите научную статью, в которой, как Вам кажется, авторы использовали спорные исследовательские практики. Если такой статьи нет на примете, то по ищите в научных базах статьи из журналов с низким импакт-фактором - средним количеством цитирований на статью.</p></li>
<li><p>Проверьте статью через <a href="http://statcheck.io" class="uri">http://statcheck.io</a>. Проинтерпретируйте все несовпадения, если такие имеются.</p></li>
</ol>
</div>
<div id="repr_r" class="section level3">
<h3><span class="header-section-number">6.2.2</span> Вопроизводимые исследования в R</h3>
<p>Очевидно, что перечисленных практик стоит избегать. Однако недостаточно просто сказать “ребята, давайте вы не будете пытаться во что бы то ни стало искать неожиданные результаты и публиковать их”. Поэтому сейчас предлагаются потенциальные решения пробоемы воспроизводимости исследований, которые постепенно набирают все большую популярность. Самое распространенное решение - это использование пререгистраций. Все просто: исследователь планирует исследование, какую выборку он хочет собрать, как будет обрабатывать данные, какие результаты он будет принимать как соответствующие гипотезе, а какие - нет. Получается что-то вроде научной статьи без результатов и их обсуждения, хотя можно и в более простом виде все представить: главное, есть доказательство, что исследование вы планировали провести именно так, а не подменяли все на ходу для красивых выводов. Другой способ добиться большей воспроизводимости результатов (и защиты от фальсификации) - это увеличение прозрачности в публикации данных и методов анализа. Существуют ученые (к счастью, такое встречается все реже), которые будут раздражаться, если их попросить дать вам данные. Мол, ну как же так, я их столько собирал, это же мои данные, а вот вы украдете у меня их и сделаете что-нибудь на них, опубликуете свою статью. Нет уж, мол, сами собирайте свои данные. Я терпел, и вы терпите. Очевидно, что наука - не забивание гвоздей, а ценность научной работы не обязательно пропорциональна количеству задействованных испытуемых. Собранные данные в некоторых случаях можно использовать в других исследованиях, а если все могут посмотреть исходные данные и проверить анализ, то это вообще круто и может защитить от ошибок.</p>
<p>Конечно, не все готовы к таким разворотам в исследовательской практике. Но лучше быть готовым, потому что в какой-то момент может оказаться, что новые практики станут обязательными. И тут R будет весьма кстати: можно выкладывать данные c RMarkdown документом, который будет сразу собирать из этого статью и графики. Данные со скриптами можно выкладывать на <a href="https://github.com">GitHub</a> - это удобно для коллективной работы над проектом. Другой вариант - выкладывать данные и скрипты для анализа на сайте <a href="osf.io" class="uri">osf.io</a>. Это сайт специально сделанный как платформа для публикации данных исследований и скриптов для них.</p>
<p><strong>Самостоятельное задание</strong>:</p>
<ol style="list-style-type: decimal">
<li>Найдите статью с кодом по на R по интересуемой Вам теме. Посмотрите код, попытайтесь его понять и запустить самостоятельно.</li>
</ol>
</div>
<div id="power" class="section level3">
<h3><span class="header-section-number">6.2.3</span> Статистическая мощность</h3>
<p>Чтобы избежать <em>optional stopping</em>, нужно определять размер выборки заранее. Как это сделать? Наиболее корректный способ предполагает использование анализа статистической мощности (statistical power analysis). Для этого понадобится пакет <code>pwr</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;pwr&quot;</span>)</code></pre></div>
<p>Этот пакет предоставляет семейство функций для расчета мощности, размера эффекта, уровня значимости или нужного размера выборки для разных статистических тестов.</p>
<p>Статистическая мощность - вероятность обнаружить статистически значимый эффект, если он действительно есть. Размер эффекта - собственно, размер эффекта в исследовании, обычно в универсальных единицах. Например, размер различия средних обычно измеряется в стандартных отклонениях. Это позволяет сравнивать эффекты в разных исследованиях и даже эффекты в разных областях науки.</p>
<p>Если задать 3 из 4 чисел (статистическая мощность - стандартно это .8, уровень значимости - стандартно .05, размер эффекта, размер выборки), то функция выдаст недостающее число.</p>
<p>Я очень советую поиграться с этим самостоятельно. Например, если размер эффекта в единицах стандартных отклонений Cohen’s d = 2, то сколько нужно испытуемых, чтобы обнаружить эффект для двухвыборочного т-теста с вероятностью .8?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(pwr)
<span class="kw">pwr.t.test</span>(<span class="dt">d =</span> <span class="dv">2</span>, <span class="dt">power =</span> <span class="fl">0.8</span>, <span class="dt">type =</span> <span class="st">&quot;two.sample&quot;</span>)</code></pre></div>
<pre><code>## 
##      Two-sample t test power calculation 
## 
##               n = 5.089995
##               d = 2
##       sig.level = 0.05
##           power = 0.8
##     alternative = two.sided
## 
## NOTE: n is number in *each* group</code></pre>
<p>Всеего 6 в каждой группе (округляем в большую сторону)!</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">pwr.t.test</span>(<span class="dt">d =</span> <span class="dv">2</span>, <span class="dt">power =</span> <span class="fl">0.8</span>, <span class="dt">type =</span> <span class="st">&quot;paired&quot;</span>)</code></pre></div>
<pre><code>## 
##      Paired t test power calculation 
## 
##               n = 4.220726
##               d = 2
##       sig.level = 0.05
##           power = 0.8
##     alternative = two.sided
## 
## NOTE: n is number of *pairs*</code></pre>
<p>Еще меньше, если использовать within-subject дизайн исследования и зависимый т-тест.</p>
<p>А если эффект маленький - всего d = .2?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">pwr.t.test</span>(<span class="dt">d =</span> .<span class="dv">2</span>, <span class="dt">power =</span> <span class="fl">0.8</span>, <span class="dt">type =</span> <span class="st">&quot;two.sample&quot;</span>)</code></pre></div>
<pre><code>## 
##      Two-sample t test power calculation 
## 
##               n = 393.4057
##               d = 0.2
##       sig.level = 0.05
##           power = 0.8
##     alternative = two.sided
## 
## NOTE: n is number in *each* group</code></pre>
<p>394 испытуемых в каждой группе!</p>
<p>Можно проверить такие расчеты самостоятельно с помощью симуляции данных.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(<span class="kw">replicate</span>(<span class="dv">1000</span>, <span class="kw">t.test</span>(<span class="kw">rnorm</span>(<span class="dv">394</span>, <span class="dv">100</span>, <span class="dv">15</span>), <span class="kw">rnorm</span>(<span class="dv">394</span>, <span class="dv">103</span>, <span class="dv">15</span>))<span class="op">$</span>p.value <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.05</span>))</code></pre></div>
<pre><code>## [1] 0.8</code></pre>
<p>Действительно, если много раз делать случайные выборки из двух нормальных распределений с средними, отличающимися на 0.2 стандартных отклонения, то примерно в 80% случаев вы получите статистически значимые различия!</p>
<p><strong>Самостоятельное задание</strong>:</p>
<ol style="list-style-type: decimal">
<li>Представьте, что эффекта нет - две выборки взяты из нормального распределения. Посчитайте, как часто <code>t.test()</code> будет выдавать ложноположительный результат при альфа = .05.</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(<span class="kw">replicate</span>(<span class="dv">10000</span>, <span class="kw">t.test</span>(<span class="kw">rnorm</span>(<span class="dv">15</span>), <span class="kw">rnorm</span>(<span class="dv">15</span>))<span class="op">$</span>p.value <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.05</span>))</code></pre></div>
<pre><code>## [1] 0.0473</code></pre>
<ol start="2" style="list-style-type: decimal">
<li>Будет ли это зависеть от размера выборки?</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(<span class="kw">replicate</span>(<span class="dv">10000</span>, <span class="kw">t.test</span>(<span class="kw">rnorm</span>(<span class="dv">150</span>), <span class="kw">rnorm</span>(<span class="dv">150</span>))<span class="op">$</span>p.value <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.05</span>))</code></pre></div>
<pre><code>## [1] 0.0508</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(<span class="kw">replicate</span>(<span class="dv">10000</span>, <span class="kw">t.test</span>(<span class="kw">rnorm</span>(<span class="dv">1500</span>), <span class="kw">rnorm</span>(<span class="dv">1500</span>))<span class="op">$</span>p.value <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.05</span>))</code></pre></div>
<pre><code>## [1] 0.0495</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>Представьте, что мы работает не с данными нормального распределения, а с <code>rlnorm()</code>.</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(<span class="kw">replicate</span>(<span class="dv">10000</span>, <span class="kw">t.test</span>(<span class="kw">rlnorm</span>(<span class="dv">15</span>), <span class="kw">rlnorm</span>(<span class="dv">15</span>))<span class="op">$</span>p.value <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.05</span>))</code></pre></div>
<pre><code>## [1] 0.0328</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(<span class="kw">replicate</span>(<span class="dv">10000</span>, <span class="kw">t.test</span>(<span class="kw">rlnorm</span>(<span class="dv">150</span>), <span class="kw">rlnorm</span>(<span class="dv">150</span>))<span class="op">$</span>p.value <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.05</span>))</code></pre></div>
<pre><code>## [1] 0.0468</code></pre>
<!--chapter:end:05-Week2Day5_style.Rmd-->
</div>
</div>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>ANOVA от ANalysis Of VAriance, по-русски часто читается как “АНОВА”.<a href="#fnref1">↩</a></p></li>
<li id="fn2"><p>ANOVA от ANalysis Of VAriance, по-русски часто читается как “АНОВА”.<a href="#fnref2">↩</a></p></li>
<li id="fn3"><p>Форма <em>F</em>-распределения будет сильно зависеть от числа степеней свободы. Но оно всегда определено от 0 до плюс бесконечности: в числителе и знаменателе всегда неотрицательные числа.<a href="#fnref3">↩</a></p></li>
<li id="fn4"><p>Обобщением множественной линейной регрессии (вернее, одним из) можно считать общую линейную модель (general linear model). Общая линейная модель может предсказывать не одну, а сразу несколько объясняемых переменных в отличие от множественной линейной регрессии. Следующим этапом обобщения служит обобщенная линейная модель (generalized linear model). Фишка последней в том, что можно использовать не только модели с нормально распределенными остатками, но и, например, логистическую и пуассоновскую регрессию.<a href="#fnref4">↩</a></p></li>
<li id="fn5"><p>Вообще-то эта логика не совсем корректна. Тест Ливиня - это такой же статистический тест, как и остальные. Поэтому считать, что допущения соблюдаются на основании того, что p-value больше допустимого уровня <span class="math inline">\(\alpha\)</span>, - это неправильно. Но для проверки допущений такая не очень корректная практика считается допустимой.<a href="#fnref5">↩</a></p></li>
</ol>
</div>
<!--bookdown:body:end-->
            </section>

          </div>
        </div>
      </div>
<!--bookdown:link_prev-->
<!--bookdown:link_next-->
    </div>
  </div>
<!--bookdown:config-->

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
